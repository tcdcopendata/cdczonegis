G.chart={},G.chart.modal=function(e){var t=G.ui.modalContent(e,"","geocloud-modal-chart"),a=G.ui.create("button","geocloud-button geocloud-theme",LanguageValue.Close,t.footer);return a.addEventListener("click",function(){t.area.innerHTML="",e.hide()}),t},G.chart.barChart=function(e,t,a,n,r){var o='<div class="barChart"><p class="barChart barChartTitle"> '+a+' </p><hr class="my-4" width="150px" align="left" color="black"></div>',i=G.ui.create("div","",o,e);i.id=t,i.tooltip=G.ui.create("div","","",i),i.tooltip.id=t+"_tooltip",i.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var s,l,c,u,d,p,g={width:540,height:200,margin:{top:20,right:20,bottom:30,left:50}};r&&(r.width&&(g.width=r.width),r.height&&(g.height=r.height),r.margin&&(g.margin=r.margin));var m=function(){s=d3.select("#"+t).append("svg").attr("width",g.width+"px").attr("height",g.height+"px"),s.append("text").attr("fill","#000").attr("x",g.width/2-30).attr("y",g.height-10).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),s.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("個案數");var e=Math.max.apply(Math,n.map(function(e){return e.count}));l=d3.scaleBand().rangeRound([0,g.width-g.margin.left-g.margin.right]).domain(n.map(function(e){return e.id})),l.invert=function(){var e=l.domain(),t=l.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}(),c=d3.scaleLinear().domain([0,e]).range([g.height-g.margin.top-g.margin.bottom,0]),u=d3.axisBottom(l).tickFormat(function(e,t){return n.length<=5||1==n[t].week||!(n[t].week%5)?n[t].week:""}),d=d3.axisLeft().scale(c),s.append("g").attr("class","axis axis-x").attr("transform","translate("+g.margin.left+","+(g.height-g.margin.bottom)+")").call(u),s.append("g").attr("class","axis axis-y").attr("transform","translate("+g.margin.left+","+g.margin.top+")").call(d),p=d3.line().defined(function(e){return null==e.count?null:e}).x(function(e){return l(e.id)}).y(function(e){return c(e.count)}).curve(d3.curveCardinal.tension(1)),s.append("g").append("path").attr("class","line-path").attr("transform","translate("+g.margin.left+","+g.margin.top+")").attr("d",p(n)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989")};m();var h=function(e){var a=Math.max.apply(Math,e.map(function(e){return e.count}));l.domain(e.map(function(e){return e.id})),c.domain([0,a]),d3.select("#"+t).transition(),s.select("line-path").attr("d",p(e)),s.select("axis-x").call(u),s.select("axis-y").call(d)};this.setData=h},G.chart.lineChart=function(){},Date.prototype.getWeek=function(){var e=new Date(this.valueOf()),t=(this.getDay()+6)%7;e.setDate(e.getDate()-t+3);var a=e.valueOf();return e.setMonth(0,1),4!=e.getDay()&&e.setMonth(0,1+(4-e.getDay()+7)%7),1+Math.ceil((a-e)/6048e5)},G.authorize={},G.authorize.loginButton=function(e,t,a){var n;if(t){var r,o;switch(t.toLowerCase()){case"google":r="Google 登入",o="icon_google_circle.png";break;case"dropbox":r="Dropbox 登入",o="icon_dropbox_circle.png";break;case"facebook":r="Facebook 登入",o="icon_facebook_circle.png";break;case"linkedin":r="Linkedin 登入",o="icon_linkedin_circle.png"}n=G.ui.button(e,r,a),n.style="width:195px;height:36px;font-size:13px;margin:5px;border-radius:18px;content='';background-position:left;background-position-x:2px;background-repeat:no-repeat;background-image:url(/map/images/icon/"+o+");filter:gray;-webkit-filter:grayscale(1);filter:grayscale(1);"}return n},G.authorize.logoutButton=function(e,t,a){var n;if(t){var r,o;switch(t.toLowerCase()){case"google":r="Google 登出",o="icon_google_circle.png";break;case"dropbox":r="Dropbox 登出",o="icon_dropbox_circle.png";break;case"facebook":r="Facebook 登出",o="icon_facebook_circle.png";break;case"linkedin":r="Linkedin 登出",o="icon_linkedin_circle.png"}n=G.ui.button(e,r,a).style="width:195px;height:36px;font-size:13px;margin:5px;border-radius:18px;content='';background-position:left;background-position-x:2px;background-repeat:no-repeat;background-image:url(/map/images/icon/"+o+");"}return n},G.authorize.Google={},G.authorize.Google.properties={apiKey:"AIzaSyBx0UlivKfK1BokDNBoMI_GxUCpq7mksKM",clientId:"154528275611-88csl6vf2rbeloemqeha558kr303795n.apps.googleusercontent.com"},G.authorize.Google.checkLogin=function(){},G.authorize.Google.LoginSuccess=function(e){},G.authorize.Dropbox={},G.authorize.Dropbox.properties={clientId:"71obue91e9kzkpf",redirectUri:"https://zone.cdc.gov.tw/map",accessToken:"",accountId:"",tokenType:"",uid:""},G.authorize.Dropbox.Operator,G.authorize.Dropbox.init=function(){G.authorize.Dropbox.getLoginArgs(),G.authorize.Dropbox.Operator=new Dropbox({accessToken:G.authorize.Dropbox.properties.accessToken,clientId:G.authorize.Dropbox.properties.clientId})},G.authorize.Dropbox.setLoginArgs=function(e){localStorage.auth_dropbox_token=e.access_token,localStorage.auth_dropbox_accountid=e.account_id,localStorage.auth_dropbox_tokentype=e.token_type,localStorage.auth_dropbox_uid=e.uid,G.authorize.Dropbox.properties.accessToken=localStorage.auth_dropbox_token,G.authorize.Dropbox.properties.accountId=localStorage.auth_dropbox_accountid,G.authorize.Dropbox.properties.tokenType=localStorage.auth_dropbox_tokentype,G.authorize.Dropbox.properties.uid=localStorage.auth_dropbox_uid},G.authorize.Dropbox.clearLoginArgs=function(){localStorage.auth_dropbox_token="",localStorage.auth_dropbox_accountid="",localStorage.auth_dropbox_tokentype="",localStorage.auth_dropbox_uid="",G.authorize.Dropbox.properties.accessToken="",G.authorize.Dropbox.properties.accountId="",G.authorize.Dropbox.properties.tokenType="",G.authorize.Dropbox.properties.uid=""},G.authorize.Dropbox.getLoginArgs=function(){if(window.location.href.indexOf("#access_token")>-1){for(var e=window.location.href.split("#")[1].split("&"),t={access_token:"",token_type:"",uid:"",account_id:""},a=0;a<e.length;a++)"access_token"==e[a].split("=")[0]?t.access_token=decodeURIComponent(e[a].split("=")[1]):"token_type"==e[a].split("=")[0]?t.token_type=decodeURIComponent(e[a].split("=")[1]):"uid"==e[a].split("=")[0]?t.uid=decodeURIComponent(e[a].split("=")[1]):"account_id"==e[a].split("=")[0]&&(t.account_id=decodeURIComponent(e[a].split("=")[1]));G.authorize.Dropbox.setLoginArgs(t)}G.authorize.Dropbox.properties.accessToken=localStorage.auth_dropbox_token,G.authorize.Dropbox.properties.accountId=localStorage.auth_dropbox_accountid,G.authorize.Dropbox.properties.tokenType=localStorage.auth_dropbox_tokentype,G.authorize.Dropbox.properties.uid=localStorage.auth_dropbox_uid},G.authorize.Dropbox.checkLoginStatus=function(e){var t={};if(!(G.authorize.Dropbox.properties.accessToken&&G.authorize.Dropbox.properties.accessToken.length>0))return t.success=!1,t;t.success=!0;var a=G.authorize.Dropbox.Operator;a.usersGetAccount({account_id:G.authorize.Dropbox.properties.accountId}).then(function(e){return G.authorize.Dropbox.account=e,t.account=e,t})["catch"](function(e){return t})},G.authorize.Dropbox.login=function(){var e=G.authorize.Dropbox.Operator,t=e.getAuthenticationUrl(G.authorize.Dropbox.properties.redirectUri);$(location).attr("href",t)},G.authorize.Dropbox.logout=function(){G.authorize.Dropbox.clearLoginArgs(),$(location).attr("href",G.authorize.Dropbox.properties.redirectUri)},G.authorize.Dropbox.getFileList=function(e,t){var a=G.authorize.Dropbox.Operator;a.filesListFolder({path:"/"+e}).then(function(e){console.log(e)})["catch"](function(e){console.log(e)})},G.authorize.Dropbox.parseData=function(){},G.authorize.Facebook={},G.authorize.Facebook.init=function(){window.fbAsyncInit=function(){FB.init({appId:"1882471455400241",autoLogAppEvents:!0,xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,t,a){var n,r=e.getElementsByTagName(t)[0];e.getElementById(a)||(n=e.createElement(t),n.id=a,n.src="https://connect.facebook.net/en_US/sdk.js",r.parentNode.insertBefore(n,r))}(document,"script","facebook-jssdk")},G.authorize.Facebook.checkLoginStatus=function(e){FB.getLoginStatus(function(t){e&&e(t)})},G.authorize.Linkedin={},G.geo={},G.geo.tile={},G.geo.tile.indices={},G.geo.tile.geojsons={},G.geo.tile.datajsons={},G.geo.tile.options={maxZoom:20,tolerance:5,extent:4096,buffer:64,debug:0,indexMaxZoom:0,indexMaxPoints:1e5},G.geo.set={},G.geo.getColorByCount=function(e){var t=[255,255,255],a=[229,236,175],n=a[0],r=a[1],o=a[2];if(e>=100)n=187,r=79,o=97;else if(e>10&&e<100){var i=(e-10)/90;n=205+-18*i,r=156+-77*i,o=136+-39*i}else if(e>0&&e<=10){var i=e/10;n=a[0]+(205-a[0])*i,r=a[1]+(156-a[1])*i,o=a[2]+(136-a[2])*i}else n=t[0],r=t[1],o=t[2];return"#"+G.geo.rgbToHex(Math.round(n))+G.geo.rgbToHex(Math.round(r))+G.geo.rgbToHex(Math.round(o))},G.geo.rgbToHex=function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},G.geo.set.DengueCase={toggleType:"locale",style:function(e,t){function a(e,t){var a="#DF8244";if("locale"==e)switch(t.IMMIGRATION){case"0":a="#DF8244";break;case"1":a="#506D8D"}else if("gender"==e)switch(t.GENDER_DESC){case"女":a="#A8779E";break;case"男":a="#3573C0"}else if("age"==e){var n=parseInt(t.SICK_AGE);a=isNaN(n)?"#DDDDDD":n<=14?"#B12318":n<=49?"#DF8244":n<=64?"#F5D062":"#878787"}else if("blood"==e){var r=t.PATHOGEN_DETAIL_NAME,o="";switch(r){case"第一型":a="#BD5B4E";break;case"第二型":a="#F0975C";break;case"第三型":a="#5FAF9F";break;case"第四型":a="#495787";break;case"無快篩":a="#878787";break;default:a="#878787"}}else if("dead"==e){var i=parseInt(t.DEATH_CNT),s=t.HAS_SC&&"有"==t.HAS_SC,o="";switch(o=i&&!isNaN(i)&&i>0?"死亡":s?"重症":"非重症及非死亡"){case"死亡":a="#B12318";break;case"重症":a="#DF8244";break;case"非重症及非死亡":a="#F5D062";break;default:a="#F5D062"}}else if("date"==e){a="#878787";var l=new Date,c=new Date(t.SICK_DATE),u=(l.getTime()-c.getTime())/864e5;a=u>=0&&u<=7?"#B12318":u<=14?"#DF8244":u<=28?"#F5D062":"#878787"}return a}toggleType="locale";var n={radius:6,fillColor:a(G.geo.set.DengueCase.toggleType,e),color:a(G.geo.set.DengueCase.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return"5"!=e.DETERMINED_STATUS&&(n.iconSize=[16,16],n.iconAnchor=[8,8],n.iconUrl="/map/images/icon_guess.png"),n},onEachFeature:{}},G.geo.set.DengueCaseArea={type:"City",style:function(e,t){function a(e){var t="#"+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)+G.geo.rgbToHex(255),a=[];switch(G.geo.set.DengueCaseArea.type){case"City":var n=e.COUNTY;if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCase){var r=G.geo.tile.geojsons.DengueCase;r.features.forEach(function(e){e.properties.RESIDENCE_COUNTY_NAME.trim().replace("　","")==n&&a.push(e)})}break;case"Dist":var n=e.COUNTY,o=e.TOWN;if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCase){var r=G.geo.tile.geojsons.DengueCase;r.features.forEach(function(e){e.properties.RESIDENCE_COUNTY_NAME.trim().replace("　","")==n&&e.properties.RESIDENCE_TOWN_NAME.trim().replace("　","")==o&&a.push(e)})}break;case"Village":var n=e.COUNTYNAME,o=e.TOWNNAME,i=e.VILLNAME;if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCase){var r=G.geo.tile.geojsons.DengueCase;r.features.forEach(function(e){e.properties.RESIDENCE_COUNTY_NAME.trim().replace("　","")==n&&e.properties.RESIDENCE_TOWN_NAME.trim().replace("　","")==o&&e.properties.RESIDENCE_VILLAGE_NAME.trim().replace("　","")==i&&a.push(e)})}}return t=G.geo.getColorByCount(a.length)}var n={weight:0,fillColor:a(e),fillOpacity:.6};return n}},G.geo.set.DengueCluster={style:function(e,t){function a(e){var t=8,a=parseInt(e.case_count);return a>50&&(a=50),a<=15?t=8+8/13*(a-2):a<=50&&(t=16+8/35*(a-15)),t}function n(e){var t="#b80001";return t=e.closed?"#78340e":"#b80001"}var r={radius:a(e),fillColor:n(e),color:n(e),weight:0,opacity:1,fillOpacity:.8};return r}},G.geo.set.DengueClusterPolygon={toggleType:"closed",style:function(e,t){function a(e){var t="#b80001";return t=e.closed?"#78340e":"#b80001"}toggleType="closed";var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.DenguePestBucketPoint={toggleType:"locale",style:function(e,t){function a(e){var t="#FFFFFF",a=parseInt(e.egg_average);return t=isNaN(a)?"#FFFFFF":a<1?"#FFFFFF":a<100?"#FFF0C5":a<150?"#F6C3A2":a<200?"#DF8244":"#B12318"}var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.DenguePestVegetablePoint={style:function(e,t){function a(e){var t="#BDBDBD";switch(e.Type){case"多人分租":t="#DE8344";break;case"曾查獲陽性孳生源":t="#556C8E";break;case"其他":t="#B79230";break;case"無資料":t="#BDBDBD"}return t}toggleType="type";var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.DenguePrevent={toggleType:"time",style:function(e,t){function a(e,t){var a=new Date;a=new Date(a.getFullYear(),a.getMonth(),a.getDate()),a.setDate(a.getDate()-13);var n="#878787";if("time"==e&&t.DATE){var r=new Date(t.DATE);r.getTime()>=a.getTime()&&(n="#DF8244")}return n}toggleType="time";var n={radius:6,fillColor:a(G.geo.set.DenguePrevent.toggleType,e),color:a(G.geo.set.DenguePrevent.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return"5"!=e.DETERMINED_STATUS&&(n.iconSize=[16,16],n.iconAnchor=[8,8],n.iconUrl="/map/images/icon_guess.png"),n},onEachFeature:{}},G.geo.set.DengueMedical={toggleType:"level",style:function(e,t){function a(e){var t=8,a=parseInt(e.case_count);return a>25&&(a=25),a<=5?t=8+8/3*(a-2):a<=25&&(t=16+.4*(a-5)),t}function n(e,t){var a="#385492";if("level"==e)switch(t.specialcategory){case"A":a="#385492";break;case"B":a="#385492"}else if("rods"==e)switch(t.specialcategory){case"女":a="#385492";break;case"男":a="#385492"}return a}toggleType="level";var r={radius:a(e),fillColor:n(G.geo.set.DengueMedical.toggleType,e),color:n(G.geo.set.DengueMedical.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return r},onEachFeature:{}},G.geo.set.DengueRiskSpatial={toggleType:"type",style:function(e,t){function a(e){var t="#FFFFFF",a=e["gwr.e"];if(a<=0)t="#FFFFFF";else if(a>3.5)t="#FF0000";else{var n=256*a/3.5-1,r=255-n;t="#FF"+G.geo.rgbToHex(Math.round(r))+G.geo.rgbToHex(Math.round(r))}return t}var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.DengueRiskMST={toggleType:"type",style:function(e,t){function a(e,t){var a="#F2F2F2",e=t["2014/08/26"];switch(e){case"increase":a="#B02318";break;case"decrease":a="#385492";break;case"keep":a="#5E813F";break;case"no cluster":a="#F2F2F2"}return a}var n={radius:6,fillColor:a(G.geo.set.DengueRiskMST.toggleType,e),color:a(G.geo.set.DenguePrevent.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.MeaslesCase={toggleType:"locale",style:function(e,t){function a(e,t){var a="#DF8244";if("locale"==e)switch(t.IMMIGRATION){case"0":a="#DF8244";break;case"1":a="#506D8D"}else if("gender"==e)switch(t.GENDER_DESC){case"F":a="#A8779E";break;case"M":a="#3573C0"}else if("age"==e){var n=parseInt(t.SICK_AGE);a=isNaN(n)?"#DDDDDD":n<=0?"#B12318":n<=6?"#DF8244":n<=19?"#F5D062":n<=39?"#878787":"#000000"}else if("date"==e){a="#878787";var r=new Date,o=new Date(t.SICK_DATE),i=(r.getTime()-o.getTime())/864e5;a=i>=0&&i<10?"#B12318":i<=28?"#DF8244":"#878787"}return a}toggleType="locale";var n={radius:6,fillColor:a(G.geo.set.MeaslesCase.toggleType,e),color:a(G.geo.set.MeaslesCase.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return"5"!=e.DETERMINED_STATUS&&(n.iconSize=[16,16],n.iconAnchor=[8,8],n.iconUrl="/map/images/icon_guess.png"),n},onEachFeature:{}},G.geo.set.MeaslesCluster={style:function(e,t){function a(e){return color="#878787",e.report_first&&e.report_first==e.REPORT?color="#B12318":color="#DF8244",color}var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return"5"!=e.DETERMINED_STATUS&&(n.iconSize=[16,16],n.iconAnchor=[8,8],n.iconUrl="/map/images/icon_guess.png"),n},onEachFeature:{}},G.geo.set.MeaslesClusterContact={style:function(e,t){function a(e){return color="#878787",e.SYMPTOM?color="#1E253C":color="#878787",color}var n={radius:6,fillColor:a(e),color:a(e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.MeaslesContact={toggleType:"gender",style:function(e,t){function a(e,t){var a="#DDDDDD";if("gender"==e)switch(t.GENDER){case"女":a="#A8779E";break;case"男":a="#3573C0"}else if("age"==e){if(t.AGE){var n=parseInt(t.AGE.split("歲")[0]);a=isNaN(n)?"#DDDDDD":n<=0?"#B12318":n<=6?"#DF8244":n<=19?"#F5D062":n<=39?"#878787":"#000000"}}else if("watch"==e&&t.CONTACT_DATE){var r=new Date,o=new Date(t.CONTACT_DATE),i=(r.getTime()-o.getTime())/864e5;a=isNaN(i)?"#DDDDDD":i<=18?"#DF8244":"#506D8D"}return a}toggleType="gender";var n={radius:6,fillColor:a(G.geo.set.MeaslesContact.toggleType,e),color:a(G.geo.set.MeaslesContact.toggleType,e),weight:0,opacity:1,fillOpacity:.8};return n},onEachFeature:{}},G.geo.set.BoundaryCity={type:"GroupCity",style:function(e,t){function a(e){var t=e.COUNTY,a=[];if("PeopleCity"==G.geo.set.BoundaryCity.type||"GroupCity"==G.geo.set.BoundaryCity.type){if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCluster){var n=G.geo.tile.geojsons.DengueCluster;n.features.forEach(function(e){e.properties.residence_city==t&&a.push(e)})}}else if("ClusterContactCity"==G.geo.set.BoundaryCity.type){if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.MeaslesClusterContact){var n=G.geo.tile.geojsons.MeaslesClusterContact;n.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME==t&&a.push(e)})}}else if("ContactCity"==G.geo.set.BoundaryCity.type&&G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.MeaslesContact){var n=G.geo.tile.geojsons.MeaslesContact;n.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME==t&&a.push(e)})}if("PeopleCity"==G.geo.set.BoundaryCity.type){var r=0;return a.forEach(function(e){var t=parseInt(e.properties.case_count);isNaN(t)||(r+=t)}),G.geo.getColorByCount(r)}return"GroupCity"==G.geo.set.BoundaryCity.type?G.geo.getColorByCount(a.length):"ClusterContactCity"==G.geo.set.BoundaryCity.type?G.geo.getColorByCount(a.length):"ContactCity"==G.geo.set.BoundaryCity.type?G.geo.getColorByCount(a.length):"#"+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)}var n={weight:0,fillColor:a(e),fillOpacity:.6};return n}},G.geo.set.BoundaryDist={type:"GroupDist",style:function(e,t){function a(e){var t=e.COUNTY,a=e.TOWN,n=[];if("PeopleDist"==G.geo.set.BoundaryCity.type||"GroupDist"==G.geo.set.BoundaryCity.type){if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCluster){var r=G.geo.tile.geojsons.DengueCluster;r.features.forEach(function(e){e.properties.residence_city==t&&e.properties.residence_dist==a&&n.push(e)})}}else if("ClusterContactDist"==G.geo.set.BoundaryCity.type){if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.MeaslesClusterContact){var r=G.geo.tile.geojsons.MeaslesClusterContact;r.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME==t&&e.properties.RESIDENTIAL_TOWN_NAME==a&&n.push(e)})}}else if("ContactDist"==G.geo.set.BoundaryCity.type&&G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.MeaslesContact){var r=G.geo.tile.geojsons.MeaslesContact;r.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME==t&&e.properties.RESIDENTIAL_TOWN_NAME==a&&n.push(e)})}if("PeopleDist"==G.geo.set.BoundaryDist.type){var o=0;return n.forEach(function(e){var t=parseInt(e.properties.case_count);isNaN(t)||(o+=t)}),G.geo.getColorByCount(o)}return"GroupDist"==G.geo.set.BoundaryDist.type?G.geo.getColorByCount(n.length):"ClusterContactDist"==G.geo.set.BoundaryDist.type?G.geo.getColorByCount(n.length):"ContactDist"==G.geo.set.BoundaryDist.type?G.geo.getColorByCount(n.length):"#"+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)}var n={weight:0,fillColor:a(e),fillOpacity:.6};return n}},G.geo.set.BoundaryVillage={type:"GroupVillage",style:function(e,t){function a(e,t){var a=["GroupVillage","PeopleVillage"],o=["MosquitoBi","MosquitoHouse","MosquitoContainer","MosquitoWorm","BucketEgg","BucketPositive"];return a.indexOf(t)>=0?n(e):o.indexOf(t)>=0?r(e):"#FFFFFF"}function n(e){var t=e.COUNTYNAME,a=e.TOWNNAME,n=e.VILLNAME,r=[];if(G.geo.tile&&G.geo.tile.geojsons&&G.geo.tile.geojsons.DengueCluster){var o=G.geo.tile.geojsons.DengueCluster;o.features.forEach(function(e){e.properties.residence_city==t&&e.properties.residence_dist==a&&e.properties.residence_village==n&&r.push(e)})}if("PeopleVillage"==G.geo.set.BoundaryVillage.type){var i=0;return r.forEach(function(e){var t=parseInt(e.properties.case_count);t!=isNaN&&(i+=t)}),G.geo.getColorByCount(i)}return"GroupVillage"==G.geo.set.BoundaryVillage.type?G.geo.getColorByCount(r.length):"#"+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)+G.geo.rgbToHex(255)}function r(e){var t=e.COUNTYNAME,a=e.TOWNNAME,n=e.VILLNAME,r=["MosquitoBi","MosquitoHouse","MosquitoContainer","MosquitoWorm"],l=["BucketEgg","BucketPositive"];if(r.indexOf(G.geo.set.BoundaryVillage.type)>=0&&G.geo.tile&&G.geo.tile.datajsons&&G.geo.tile.datajsons.objVillages){var c,u=G.geo.tile.datajsons.objVillages;if(!(u&&u[t]&&u[t][a]&&u[t][a][n]))return"#FFFFFF";c=u[t][a][n];var d=0;return d="MosquitoBi"==G.geo.set.BoundaryVillage.type?c.bi_level:"MosquitoHouse"==G.geo.set.BoundaryVillage.type?c.house_level:"MosquitoContainer"==G.geo.set.BoundaryVillage.type?c.container_level:"MosquitoWorm"==G.geo.set.BoundaryVillage.type?c.worm_level:0,0==d&&0==c.data_mosquito.length&&(d=NaN),o(d)}if(l.indexOf(G.geo.set.BoundaryVillage.type)>=0&&G.geo.tile&&G.geo.tile.datajsons&&G.geo.tile.datajsons.objVillages){var c,u=G.geo.tile.datajsons.objVillages;return u&&u[t]&&u[t][a]&&u[t][a][n]?(c=u[t][a][n],"BucketEgg"==G.geo.set.BoundaryVillage.type?i(0==c.data_bucket.length?NaN:c.totaleggs):"BucketPositive"==G.geo.set.BoundaryVillage.type?s(0==c.data_bucket.length?NaN:c.totaleggs):"#FFFFFF"):"#FFFFFF"}return"#FFFFFF"}function o(e){return isNaN(e)?"#FFFFFF":e<=0?"#FFF0C5":e<=1?"#F6C3A2":e<=2?"#EA712B":"#B80001"}function i(e){var t="#FFFFFF";return t=isNaN(e)?"#FFFFFF":e<1?"#FFF0C5":e<250?"#F6C3A2":e<500?"#EA712B":"#B80001"}function s(e){var t="#FFFFFF";return t=isNaN(e)?"#FFFFFF":e<30?"#FFF0C5":e<60?"#EA712B":"#B80001"}var l={weight:0,fillColor:a(e,G.geo.set.BoundaryVillage.type),fillOpacity:.6};return l},onEachFeature:function(){alert("test")}},G.geo.onEachFeature=function(e,t){var a=[];for(var n in e.properties){var r=n+"："+e.properties[n];if(r.indexOf("script")!==-1)a.push(r);else{var o=document.createElement("div");o.innerHTML=r,a.push(o)}}t.bindPopup(G.ui.popupContent(a))},G.geo.filter=function(e){for(var t=e.features,a=[],n={},r=0;r<t.length;r++){var o=t[r],i=parseInt(t[r].properties.EXEYEAR);i<2014&&a.push(o)}return n.type="FeatureCollection",n.features=a,n},G.geo.getData=function(e,t,a,n,r,o,i){if("BoundaryCity"===e){var s="/map/data/geojson/boundary/city";G.geo.tile.geojsons[e]||$.ajax({url:s,async:!0,dataType:"json",type:"POST"}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1),G.layerBar.createDiseaseLayer("DengueCaseAreaCity",a,["json",G.geo.tile.geojsons[e]],!1),"City"==G.geo.set.DengueCaseArea.type&&(a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaCity)})}else if("BoundaryDist"===e){var s="/map/data/geojson/boundary/dist";G.geo.tile.geojsons[e]||$.ajax({url:s,async:!0,dataType:"json",type:"POST"}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1),G.layerBar.createDiseaseLayer("DengueCaseAreaDist",a,["json",G.geo.tile.geojsons[e]],!1),"Dist"==G.geo.set.DengueCaseArea.type&&(a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaDist)})}else if("BoundaryVillage"===e){var s="/map/data/geojson/boundary/village";G.geo.tile.geojsons[e]||$.ajax({url:s,async:!0,dataType:"json",type:"POST"}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1),G.layerBar.createDiseaseLayer("DengueCaseAreaVillage",a,["json",G.geo.tile.geojsons[e]],!1),"Village"==G.geo.set.DengueCaseArea.type&&(a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaVillage)})}else if("DengueCase"===e){var s="/map/data/dengue/map/case/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.DengueCase.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.geo.tile.geojsons.DengueCaseHeatmap=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!0),G.layerBar.createDiseaseLayer("DengueCaseHeatmap",a,["heatmap",G.geo.tile.geojsons.DengueCaseHeatmap],!0),G.menu.DengueGraph.refreshLayer("DengueCaseArea")})}else if("DengueCluster"===e){var s="/map/data/dengue/map/cluster/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.DengueCluster.params}).done(function(e){G.geo.tile.geojsons.DengueCluster=e,G.layerBar.createDiseaseLayer("DengueCluster",a,["json",G.geo.tile.geojsons.DengueCluster],!1)});var l="/map/data/dengue/map/cluster/polygons";$.ajax({url:l,async:!0,dataType:"json",type:"POST",data:G.geo.getData.DengueCluster.params}).done(function(e){G.geo.tile.geojsons.DengueClusterPolygon=e,G.layerBar.createDiseaseLayer("DengueClusterPolygon",a,["json",G.geo.tile.geojsons.DengueClusterPolygon],!1)})}else if("DenguePest"===e){var s="/map/data/dengue/map/pest/points/bucket";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData[e].params}).done(function(e){G.geo.tile.geojsons.DenguePestBucketPoint=e,G.layerBar.createDiseaseLayer("DenguePestBucketPoint",a,["json",G.geo.tile.geojsons.DenguePestBucketPoint],!1)});var c="/map/data/dengue/map/pest/points/vegetable";$.ajax({url:c,async:!0,dataType:"json",type:"POST"}).done(function(e){G.geo.tile.geojsons.DenguePestVegetablePoint=e,G.layerBar.createDiseaseLayer("DenguePestVegetablePoint",a,["json",G.geo.tile.geojsons.DenguePestVegetablePoint],!1)})}else if("DenguePrevent"===e){var s="/map/data/dengue/map/prevent/polygons";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.DenguePrevent.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("DengueMedical"===e){var s="/map/data/dengue/map/medical/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.DengueMedical.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("DengueRiskSpatial"===e){var s="/map/data/dengue/map/risk/spatial";$.ajax({url:s,async:!0,dataType:"json",type:"POST"}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("DengueRiskMST"===e){var s="/map/data/dengue/map/risk/mst";$.ajax({url:s,async:!0,dataType:"json",type:"POST"}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("MeaslesCase"===e){var s="/map/data/measles/map/case/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.MeaslesCase.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!0)})}else if("MeaslesCluster"===e){var s="/map/data/measles/map/cluster/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.MeaslesCluster.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("MeaslesClusterContact"===e){var s="/map/data/measles/map/cluster/pointsContact";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.MeaslesClusterContact.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}else if("MeaslesContact"===e){var s="/map/data/measles/map/contact/points";$.ajax({url:s,async:!0,dataType:"json",type:"POST",data:G.geo.getData.MeaslesContact.params}).done(function(t){G.geo.tile.geojsons[e]=t,G.layerBar.createDiseaseLayer(e,a,["json",G.geo.tile.geojsons[e]],!1)})}},G.geo.getData.DengueCase={params:{}},G.geo.getData.DengueCase.LayerType="",G.geo.getData.DengueCluster={params:{}},G.geo.getData.DengueCluster.LayerType="",G.geo.getData.DenguePest={params:{}},G.geo.getData.DenguePrevent={params:{},LayerType:""},G.geo.getData.DengueMedical={params:{}},G.geo.getData.DengueMedical.LayerType="",G.geo.getData.MeaslesCase={params:{}},G.geo.getData.MeaslesCase.LayerType="",G.geo.getData.MeaslesCluster={params:{}},G.geo.getData.MeaslesCluster.LayerType="",G.geo.getData.MeaslesClusterContact={params:{}},G.geo.getData.MeaslesClusterContact.LayerType="",G.geo.getData.MeaslesContact={params:{}},G.geo.getData.MeaslesContact.LayerType="",G.menu={},G.menu.createGeoCloudPanel=function(e,t,a,n){var r=L.DomUtil.create("div","geocloud-panel",e);if(t&&t.length>0){var o=L.DomUtil.create("div","title",r);o.textContent=t}var i=L.DomUtil.create(n?n:"div","area",r);return r.style.display=a?"none":"",r.area=i,r},G.menu.createGeoCloudCollapsePanel=function(e,t,a,n,r){var o=L.DomUtil.create("div","geocloud-collapse-panel panel panel-default",e),i=L.DomUtil.create("div","title panel-heading",o),s=L.DomUtil.create(n?n:"div","area panel-collapse collapse panel-body",o);s.id=r;var l=L.DomUtil.create("a","title panel-heading",L.DomUtil.create("h4","panel-title",i));return l.innerText=t,l["data-toggle"]="collapse",l.href="#"+r,o.area=s,o},G.menubutton=G.menubutton?G.menubutton:{},G.menubutton.zone_export=function(){return'<img src="/map/assets/images/export.svg" />'},G.menubutton.zone_bookmark=function(){return'<img src="/map/assets/images/bookmarks.svg" />'},G.menubutton.zone_tile=function(){return'<img src="/map/assets/images/groundFloorMap.svg" />'},G.menubutton.zone_import=function(){return'<h5 style="width:30px;height:17px">匯入</h5>'},G.menubutton.zone_draw=function(){return'<h5 style="width:30px;height:17px">手繪</h5>'},G.menubutton.zone_animation=function(){return'<img src="/map/assets/images/animation.svg" />'},G.menubutton.zone_list=function(){return'<img src="/map/assets/images/forms.svg" />'},G.menubutton.zone_legend=function(){return'<img src="/map/assets/images/legend.svg" />'},G.menubutton.zone_user=function(){return'<img src="/map/assets/images/administrator.svg" />'},G.menubutton.zone_logout=function(){return'<img src="/map/assets/images/loginInformation.svg" />'},G.menubutton.zone_information=function(){return'<img src="/map/assets/images/info.svg" />'},G.menubutton.zone_disease=function(){return'<img src="/map/assets/images/dengue.svg" />'},G.menubutton.zone_disease_dengue=function(){return'<img src="/map/assets/images/dengue.svg" />'},G.menubutton.zone_disease_measles=function(){return'<img src="/map/assets/images/measles.svg" />'},G.menu.Zone_User=function(e,t,a,n){function r(){$.ajax({type:"post",url:"/map/user/settings",async:!0,dataType:"json",data:{USER_ID:User.userid}}).done(function(e){if(e&&e.length>0&&e[0].USER_MAP&&e[0].USER_MAP.lat&&e[0].USER_MAP.lat>0)E.value=e[0].USER_MAP.lat,M.value=e[0].USER_MAP.lng,S.value=e[0].USER_MAP.zoom,m.setView([e[0].USER_MAP.lat,e[0].USER_MAP.lng],e[0].USER_MAP.zoom);else if(User.regional&&User.xmin&&User.xmax&&User.ymin&&User.ymax){var t=parseFloat(User.xmin),a=parseFloat(User.xmax),n=parseFloat(User.ymin),r=parseFloat(User.ymax);if(t!=isNaN&&a!=isNaN&&n!=isNaN&&r!=isNaN){var o=L.latLng(n,t),i=L.latLng(r,a);m.fitBounds(L.latLngBounds(o,i))}}})}function o(e){$.ajax({type:"post",url:"/map/user/settings/update_map",async:!0,dataType:"json",data:e}).done(function(e){console.log("updateMapSetting: "+e),alert("設定完成")})}function i(){gapi.load("client:auth2",s)}function s(){var e="https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";gapi.client.init({apiKey:G.authorize.Google.properties.apiKey,discoveryDocs:[e],clientId:G.authorize.Google.properties.clientId,scope:O}).then(function(){N=gapi.auth2.getAuthInstance(),N.isSignedIn.listen(u);N.currentUser.get();c()})}function l(){N.isSignedIn.get()?(N.signOut(),c()):(N.signIn(),c())}function c(e){var t=N.currentUser.get(),a=t.hasGrantedScopes(O);a?(P.style.display="none",I.style.display=""):(P.style.display="",I.style.display="none")}function u(e){
c()}function d(){if(G.authorize.Dropbox.properties.accessToken&&G.authorize.Dropbox.properties.accessToken.length>0){B.style.display="none",U.style.display="";var e=G.authorize.Dropbox.Operator;e.usersGetAccount({account_id:G.authorize.Dropbox.properties.accountId}).then(function(e){z.Username=L.DomUtil.create("span","",z),G.authorize.Dropbox.account=e,z.Username.textContent=G.authorize.Dropbox.account.name.display_name+" 您好！"})["catch"](function(e){})}else B.style.display="",U.style.display="none"}function p(){G.authorize.Facebook.checkLoginStatus(function(e){switch(e.status){case"unknown":F.style.display="",R.style.display="none";break;case"not_authorized":F.style.display="",R.style.display="none";break;case"connected":F.style.display="none",R.style.display=""}})}function g(){IN&&IN.User&&IN.User.isAuthorized()?(j.style.display="none",V.style.display=""):(j.style.display="",V.style.display="none")}var m=a.mainMap,h=(a.tileLayers,n.tile,{});h.USER_SETTING={},h.USER_MAP={},h.USER_THEME={};var y=e.createMenuControl("個人",G.menubutton.zone_user(),t,"zone_user",function(){W||(W=!0,p(),g())}),b=G.menu.createGeoCloudPanel(y,"使用者資訊"),f=G.ui.create("div","","",b.area),v=G.ui.create("div","","",b.area),C=G.ui.create("div","","",b.area),D=G.ui.create("div","","",b.area);if(User&&User.userid){var x=L.DomUtil.create("div","userdata-area",f);x.style.margin="6px",x.style.marginLeft="10px",x.Username=L.DomUtil.create("span","",x),x.Username.textContent=User.username+" 您好！";G.ui.button(f,"登出",function(e){swal({title:"確定登出？",text:"確定要登出嗎？",icon:"warning",confirmButtonText:"確定",cancelButtonText:"取消",buttons:!0}).then(function(e){e&&$(location).attr("href","/map/deauthorize")})}).style="width: 195px;height: 30px;font-size: 13px;margin:5px";if(3==User.permission||2==User.permission){G.ui.button(C,"管理",function(e){$(location).attr("href","/map/admin")}).style="width: 195px;height: 30px;font-size: 13px;margin:5px"}}else{G.ui.button(f,"登入",function(e){$(location).attr("href","/map/authorize")}).style="width: 195px;height: 30px;font-size: 13px;margin:5px"}var _,w;G.ui.button(v,"開始導引式教學",function(e){var t=window.Tour["default"];const a={canExit:!1,padding:5,maxHeight:150,maxWidth:250,maskVisible:!0,maskVisibleOnNoTarget:!0,maskClickThrough:!1,maskScrollThrough:!0,maskColor:"rgba(0,0,0,.7)",scrollBox:"body",previousText:"上一步",nextText:"下一步",finishText:"完成",showPrevious:!0,showNext:!0,animationDuration:400,placement:["bottom","right","top","left"],dark:!1,disableInteraction:!1,disableEscExit:!1,steps:[{target:"",content:LanguageValue.Tour.TourUserStart},{target:".geocloud-control-geocoding",content:LanguageValue.Tour.TourUserSearch},{target:".geocloud-control-zoom",content:LanguageValue.Tour.TourUserZoom},{target:".geocloud-control-menu",content:LanguageValue.Tour.TourUserMenu},{target:".geocloud-control-tab",content:LanguageValue.Tour.TourUserTab}]};t.start(a).then(function(){})["catch"](function(){})}).style="width: 195px;height: 30px;font-size: 13px;margin:5px";switch(LanguageValue.LanguageCode){case"zh-tw":_="Switch to English Version",w="/map/en";break;case"en":_="切換至中文版",w="/map/zh-tw"}var k=(G.ui.button(D,_,function(e){$(location).attr("href",w)}).style="width: 195px;height: 30px;font-size: 13px;margin:5px",G.menu.createGeoCloudPanel(y,"使用者偏好設定")),T=G.ui.create("div","","",k.area),E=L.DomUtil.create("input","",G.ui.create("label","geocloud-menuContent-selectData-name","緯度 : ",T)),M=L.DomUtil.create("input","",G.ui.create("label","geocloud-menuContent-selectData-name","經度 : ",T)),S=L.DomUtil.create("input","",G.ui.create("label","geocloud-menuContent-selectData-name","縮放等級 : ",T));G.ui.button(T,"取得畫面中心點座標",function(e){var t=m.getCenter();E.value=t.lat,M.value=t.lng;var a=m.getZoom();S.value=a}).style="width: 195px;height: 30px;font-size: 13px;margin:5px",G.ui.button(T,"儲存為起始點",function(e){if(isNaN(parseFloat(E.value)))return void alert("不合法的緯度值");if(isNaN(parseFloat(M.value)))return void alert("不合法的經度值");if(isNaN(parseInt(S.value)))return void alert("不合法的縮放等級");h.USER_MAP.lat=parseFloat(E.value),h.USER_MAP.lng=parseFloat(M.value),h.USER_MAP.zoom=parseInt(S.value),h.USER_ID=User.userid;var t={};t.USER_ID=h.USER_ID,t.USER_MAP=JSON.stringify(h.USER_MAP),t.USER_SETTING=JSON.stringify(h.USER_SETTING),o(t)}).style="width: 195px;height: 30px;font-size: 13px;margin:5px";r();var A=G.menu.createGeoCloudPanel(y,"第三方服務"),P=G.ui.create("div","","",A.area),I=G.ui.create("div","","",A.area);P.style.display="none",I.style.display="none";G.authorize.loginButton(P,"Google",function(e){l()}),G.authorize.logoutButton(I,"Google",function(e){l()});i();var N,O="https://www.googleapis.com/auth/drive.metadata.readonly";G.authorize.Google.checkLogin(),G.authorize.Dropbox.init();var B=G.ui.create("div","","",A.area),U=G.ui.create("div","","",A.area);B.style.display="none",U.style.display="none";var z=L.DomUtil.create("div","userdata-dropbox-area",U);z.style.margin="6px",z.style.marginLeft="10px",d();G.authorize.loginButton(B,"Dropbox",function(e){var t=G.authorize.Dropbox.Operator,a=t.getAuthenticationUrl(G.authorize.Dropbox.properties.redirectUri);$(location).attr("href",a)}),G.authorize.logoutButton(U,"Dropbox",function(e){G.authorize.Dropbox.clearLoginArgs(),$(location).attr("href","/map")});G.authorize.Facebook.init();var F=G.ui.create("div","","",A.area),R=G.ui.create("div","","",A.area);F.style.display="none",R.style.display="none";var q=L.DomUtil.create("div","userdata-dropbox-area",U);q.style.margin="6px",q.style.marginLeft="10px";var j=(G.authorize.loginButton(F,"Facebook",function(e){FB.login(function(e){e.authResponse?(p(),console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(e){console.log("Good to see you, "+e.name+".")})):console.log("User cancelled login or did not fully authorize.")})}),G.authorize.logoutButton(R,"Facebook",function(e){FB.logout(function(e){p()})}),G.ui.create("div","","",A.area)),V=G.ui.create("div","","",A.area);j.style.display="none",V.style.display="none";var H=L.DomUtil.create("div","userdata-dropbox-area",V);H.style.margin="6px",H.style.marginLeft="10px";var W=(G.authorize.loginButton(j,"Linkedin",function(e){IN.User.authorize(function(){g()},function(){})}),G.authorize.logoutButton(V,"Linkedin",function(e){IN.User.logout(function(){g()},function(){})}),!1)},G.menu.zone_user=function(e,t,a,n){return new G.menu.Zone_User(e,t,a,n)},G.menu.Zone_Export=function(e,t,a,n){var r,o=a.mainMap,i=(a.sortLayersList,{}),s=e.createMenuControl("匯出",G.menubutton.zone_export(),t,"zone_export"),l=function(e){var t=e.name.split("."),a=t.pop().toLowerCase(),n=t.pop();if(S(!0),/gpx|kml|json|geojson/gi.test(a)){var o=new FileReader;o.onload=function(e){var t,o=e.target.result;t=/gpx|kml/gi.test(a)?G.converter.toGeojson(a,o):JSON.parse(o),r=t,p.value=a,p.setAttribute("data-filename",n),c(a),S(!1)},o.readAsText(e)}else"kmz"===a?G.converter.toGeojson("kmz",e,function(e){e&&(r=e[0],p.value=a,p.setAttribute("data-filename",n),c(a),buttonClick()),S(!1)}):(window.alert("Unsupported file type "+e.type+"("+a+")"),S(!1))},c=function(e){for(var t={radius:parseFloat(h.radius.input.value),color:h.color.input.value,weight:1,opacity:1},n={color:_.color.input.value,weight:parseFloat(_.weight.input.value),dashArray:parseFloat(_.dashArray.input.value),opacity:parseFloat(_.opacity.input.value)},o={color:E.color.input.value,weight:parseFloat(E.weight.input.value),dashArray:parseFloat(E.dashArray.input.value),opacity:parseFloat(E.opacity.input.value),fillColor:E.fillColor.input.value,fillOpacity:parseFloat(E.fillOpacity.input.value)},s=("dxf"===this.value?function(e,a){var n,r=e.properties.dxfType;if("Point"===r)e.style&&0!==Object.keys(e.style)||(e.style=t),n=L.circleMarker(a,t);else if("TEXT"===r){var o=e.properties.Name,i=encodeURIComponent(o);len=i.replace(/%[A-F\d]{2}/g,"U").length,n=L.marker(a,{icon:L.divIcon({iconSize:[6*len,12],iconAnchor:[0,6],className:"geocloud-marker-dxfText",html:'<span style="color: '+e.style.color+"; opacity: "+e.style.opacity+';">'+e.properties.Name+"</span>"}),clickable:!1})}return n}:function(e,a){var n;return e.style&&0!==Object.keys(e.style)?n=e.style.iconUrl?L.marker(a,{icon:L.icon(e.style)}):L.marker(a,{icon:L.divIcon(e.style)}):(e.style=t,n=L.circleMarker(a,e.style)),n},0),l=r.features.length;s<l;s++){var c=r.features[s];switch(c.geometry.type){case"Point":c.properties.__style=L.extend({},t,c.style);break;case"LineString":case"MultiLineString":c.properties.__style=L.extend({},n,c.style);break;case"Polygon":case"MultiPolygon":c.properties.__style=L.extend({},o,c.style)}}"shp"===e?G.layerBar.controller(p.getAttribute("data-filename"),i.ShapeFile,a,["json",r],!0,!1,!0,!0):"dxf"===e?G.layerBar.controller(p.getAttribute("data-filename"),i.DxfFile,a,["json",r],!0,!1,!0,!0):"dropbox"===e?G.layerBar.controller(p.getAttribute("data-filename"),i.DropboxFile,a,["json",r],!0,!1,!0,!0):G.layerBar.controller(p.getAttribute("data-filename"),i.InputFile,a,["json",r],!0,!1,!0,!0)};o.getContainer().addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t={},n=Array.prototype.slice.apply(e.dataTransfer.files);if(n.length>0)n.forEach(function(e){e&&l(e)});else{var i=e.dataTransfer.getData("URL");if(i){t.type="url",t.string=i;var s=t.string.split("?"),c=s[1].split("&"),d=t.string.split(".");t.name=decodeURIComponent(c[0]),t.ext=d[d.length-1],$.ajax({url:"/proxy?"+t.string,async:!1,dataType:"text"}).done(function(e){r=JSON.parse(e),a.modal.show(u),S(!1)})}else{var p=e.dataTransfer.getData("text/plain");t.type="text",t.string=p}}o.scrollWheelZoom.enable()},!1);var u=G.ui.modalContent(a.modal,"圖層設定","geocloud-modal-io"),d=u.area,p=G.ui.create("button","geocloud-button geocloud-theme",LanguageValue.Ok,u.footer);p.addEventListener("click",function(){c(this.value),a.modal.hide()});var g=L.DomUtil.create("div","geocloud-modal-panel",d);L.DomUtil.create("div","panel-title",g).textContent=LanguageValue.IoMarkerLayer;var m=L.DomUtil.create("div","panel-area",g),h={color:{input:G.ui.color()},radius:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,10,1,function(){h.radius.span.textContent=this.value})}},y=L.DomUtil.create("div","table",m);for(var b in h){var f=L.DomUtil.create("tr","",y),v=L.DomUtil.create("td","",f),C=L.DomUtil.create("td","",f);switch(b){case"color":v.textContent=LanguageValue.Color,C.appendChild(h.color.input);break;case"radius":v.textContent="半徑",v.appendChild(document.createElement("br")),v.appendChild(h.radius.span),C.appendChild(h.radius.input)}}var D=L.DomUtil.create("div","geocloud-modal-panel",d);L.DomUtil.create("div","panel-title",D).textContent=LanguageValue.IoPolylineLayer;var x=L.DomUtil.create("div","panel-area",D),_={color:{input:G.ui.color()},weight:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,10,.1,function(){_.weight.span.textContent=this.value})},dashArray:{span:G.ui.create("span","value",0),input:G.ui.slider(0,0,24,.1,function(){_.dashArray.span.textContent=this.value})},opacity:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,1,.1,function(){_.opacity.span.textContent=this.value})}},w=L.DomUtil.create("div","table",x);for(var b in _){var f=L.DomUtil.create("tr","",w),v=L.DomUtil.create("td","",f),C=L.DomUtil.create("td","",f);switch(b){case"color":v.textContent=LanguageValue.Color,C.appendChild(_.color.input);break;case"weight":v.textContent=LanguageValue.Width,v.appendChild(document.createElement("br")),v.appendChild(_.weight.span),C.appendChild(_.weight.input);break;case"dashArray":v.textContent=LanguageValue.Dash,v.appendChild(document.createElement("br")),v.appendChild(_.dashArray.span),C.appendChild(_.dashArray.input);break;case"opacity":v.textContent=LanguageValue.Opcity,v.appendChild(document.createElement("br")),v.appendChild(_.opacity.span),C.appendChild(_.opacity.input)}}var k=L.DomUtil.create("div","geocloud-modal-panel",d);L.DomUtil.create("div","panel-title",k).textContent=LanguageValue.IoPolygonLayer;var T=L.DomUtil.create("div","panel-area",k),E={color:{input:G.ui.color()},weight:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,10,.1,function(){E.weight.span.textContent=this.value})},dashArray:{span:G.ui.create("span","value",0),input:G.ui.slider(0,0,24,.1,function(){E.dashArray.span.textContent=this.value})},opacity:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,1,.1,function(){E.opacity.span.textContent=this.value})},fillColor:{input:G.ui.color()},fillOpacity:{span:G.ui.create("span","value",.6),input:G.ui.slider(.6,0,1,.1,function(){E.fillOpacity.span.textContent=this.value})}},M=L.DomUtil.create("table","table",T);for(var b in E){var f=L.DomUtil.create("tr","",M),v=L.DomUtil.create("td","",f),C=L.DomUtil.create("td","",f);switch(b){case"color":v.textContent=LanguageValue.Polyline+LanguageValue.Color,C.appendChild(E.color.input);break;case"weight":v.textContent=LanguageValue.Width,v.appendChild(document.createElement("br")),v.appendChild(E.weight.span),C.appendChild(E.weight.input);break;case"dashArray":v.textContent=LanguageValue.Dash,v.appendChild(document.createElement("br")),v.appendChild(E.dashArray.span),C.appendChild(E.dashArray.input);break;case"opacity":v.textContent=LanguageValue.Opcity,v.appendChild(document.createElement("br")),v.appendChild(E.opacity.span),C.appendChild(E.opacity.input);break;case"fillColor":v.textContent=LanguageValue.Polygon+LanguageValue.Color,C.appendChild(E.fillColor.input);break;case"fillOpacity":v.textContent=LanguageValue.FillOpcity,v.appendChild(document.createElement("br")),v.appendChild(E.fillOpacity.span),C.appendChild(E.fillOpacity.input)}}var S=function(e){[buttonFileInput].forEach(function(t){t.disabled=e})},A=G.menu.createGeoCloudPanel(s,LanguageValue.IoOutputDrawLayer),P=A.area,I=G.ui.bulbButton(P,LanguageValue.IoMarkerLayer),N=G.ui.bulbButton(P,LanguageValue.IoPolylineLayer),O=G.ui.bulbButton(P,LanguageValue.IoPolygonLayer);I.classList.add("active"),N.classList.add("active"),O.classList.add("active");var B={Point:I,Polyline:N,Polygon:O},U=L.DomUtil.create("input","",G.ui.create("label","geocloud-menuContent-io-output-name",LanguageValue.IoFileName,P));U.type="text",U.placeholder=LanguageValue.IoFileNamePlaceholder;var z=function(){var e=G.converter.emptyGeojson();return["Point","Polyline","Polygon"].forEach(function(t){if(B[t].classList.contains("active")){var n=a.overLayers[t].toGeoJSON();"Polygon"!==t?e.features=e.features.concat(n.features):e.features=e.features.concat(n.features.map(function(e){return"string"!=typeof e.style.fillColor&&delete e.style.fillColor,e}))}}),e},F=G.ui.create("div","btn row","",P);F.style["horizontal-align"]="middle",F.style.width="100%";var R=G.ui.button(F,"JSON",function(){var e=z(),t=new Blob([JSON.stringify(e)],{type:"text/plain;charset=utf-8"}),a=U.value;a=""!==a.trim()?a:"CDCZone_Drawfile",saveAs(t,a+".json")}),q=G.ui.button(F,"KML",function(){var e=z(),t=G.converter.toKml("geojson",e),a=new Blob([t],{type:"text/plain;charset=utf-8"}),n=U.value;n=""!==n.trim()?n:"CDCZone_Drawfile",saveAs(a,n+".kml")}),j=G.ui.button(F,"Dropbox",function(){if(G.Dropbox){var e=z(),t=U.value,a=new Date,n="_"+a.getFullYear()+(a.getMonth()+1)+a.getDate()+"_"+a.getHours()+a.getMinutes();t+=n,this.disabled=!0,dropbox_putData(JSON.stringify(e),"CDCZone/drawLayers/"+t+".json",dropbox_getToken(),function(e){swal(LanguageValue.IoUploadSuccess,LanguageValue.IoUploadPath+"："+e.path,"success"),this.disabled=!1})}else swal({title:LanguageValue.IoLoginDropbox,text:LanguageValue.IoLoginDropboxMessage,type:"warning"}),dropbox_authorize()});R.style.margin="3px",q.style.margin="3px",j.style.margin="3px"},G.menu.zone_export=function(e,t,a,n){return new G.menu.Zone_Export(e,t,a,n)},G.menu.Zone_Bookmark=function(e,t,a,n){function r(){$.ajax({type:"get",url:"/map/bmlist",async:!0,success:function(e){e.data.forEach(function(e){name=e.name,year=e.year,bbox=e.bbox,layer=e.layer,G.layerBar.createbmlist(name,year,c,a,layer,bbox)})}})}var o=(a.mainMap,a.tileLayers,n.tile,e.createMenuControl("書籤",G.menubutton.zone_bookmark(),t,"zone_bookmark")),i=G.menu.createGeoCloudPanel(o,"新增書籤"),s=L.DomUtil.create("input","",G.ui.create("label","geocloud-menuContent-selectData-name","名稱 : ",i.area));s.type="text";var l=G.ui.create("div","Catch-Enter","",i.area),c=(G.ui.button(l,"申請送出",function(e){var t=s.value,a=mymap.mainMap.getBounds().toBBoxString()+",4326",n="106",o="";if(t){for(var i=0;i<$(".geocloud-menuContent-geo .geocloud-layerBar").length;i++)$(".geocloud-menuContent-geo .geocloud-layerBar")[i].childNodes[0].className&&(o=""==o?$(".geocloud-menuContent-geo .geocloud-layerBar")[i].childNodes[0].innerText:o+","+$(".geocloud-menuContent-geo .geocloud-layerBar")[i].childNodes[0].innerText);$.ajax({type:"post",url:"/map/bookmark_data",async:!0,data:{name:t,year:n,bbox:a,layer:o},success:function(e){if("false"!=e){if(alert("已送出"),0!=$(".geocloud-menuContent-zone_bookmark .area")[1].childElementCount)for(var t=$(".geocloud-menuContent-zone_bookmark .area")[1].childElementCount,a=0;a<t;a++)$(".geocloud-menuContent-zone_bookmark .area")[1].removeChild($(".geocloud-menuContent-zone_bookmark .area")[1].childNodes[0]);r()}else alert("已閒置過久，請重新登入")}})}else{var l="";l+="名稱不可為空\r",alert(l)}}).style="width: 207px;height: 30px;font-size: 13px;margin:5px",G.menu.createGeoCloudPanel(o,"書籤清單"));r()},G.menu.zone_bookmark=function(e,t,a,n){return new G.menu.Zone_Bookmark(e,t,a,n)},G.menu.Zone_Tile=function(e,t,a,n){var r=a.mainMap,o=a.tileLayers,i=n.tile,s=e.createMenuControl("底圖切換",G.menubutton.zone_tile(),t,"tile");o.osm2=G.WMTS.Tile("osm2"),o.gm2=G.WMTS.Tile("gm2"),o.nlsc2=G.WMTS.Tile("nlsc2"),o.nlsc3=G.WMTS.Tile("nlsc3"),o.nlsc5=G.WMTS.Tile("nlsc5"),o.nlsc6=G.WMTS.Tile("nlsc6"),o.nlsc7=G.WMTS.Tile("nlsc7"),o.nlsc8=G.WMTS.Tile("nlsc8"),o.flooding300=G.WMTS.Tile("flooding300"),o.flooding450=G.WMTS.Tile("flooding450"),o.flooding600=G.WMTS.Tile("flooding600");var l=G.menu.createGeoCloudPanel(s,LanguageValue.TileMap).area,c=[],u=[],d=[],p=[];if(i&&i.forEach(function(e){switch(e){case"osm":u=["osm1","Open Street Map"],c.push(u);break;case"google":u=["gsm",LanguageValue.TileGoogleStreetMap],c.push(u),u=["gim",LanguageValue.TileGoogleImage],c.push(u);break;case"nlsc":u=["nlsc1",LanguageValue.TileNLSC],c.push(u),u=["nlsc4",LanguageValue.TileNLSCImage],c.push(u);break;default:u=[e,LanguageValue["Tile"+e]],p.push(u)}}),c.forEach(function(e){var t=L.DomUtil.create("div","geocloud-tile-button",l),n=L.DomUtil.create("div","geocloud-tile-image",t),r=L.DomUtil.create("div","geocloud-tile-describe",t);t.title=e[1],n.style.background="url(/map_core/style/images/tiles/"+e[0]+".png) no-repeat",r.textContent=e[1],t.addEventListener("click",function(){a.tileLayerChange(e[0]),G.util.each(l.querySelectorAll(".geocloud-tile-button"),function(e){e.classList.remove("active")}),d.length>0&&G.util.each(g.querySelectorAll(".geocloud-tile-button"),function(e){e.classList.remove("active")}),this.classList.add("active")}),"gsm"===e[0]&&t.classList.add("active")}),d.length>0){var g=G.menu.createGeoCloudPanel(s,LanguageValue.TileHistoryMap).area;d.forEach(function(e){var t=L.DomUtil.create("div","geocloud-tile-button",g),n=L.DomUtil.create("div","geocloud-tile-image",t),r=L.DomUtil.create("div","geocloud-tile-describe",t);t.title=e[1],n.style.background="url(/map_core/style/images/tiles/"+e[0]+".png) no-repeat",r.textContent=e[1],t.addEventListener("click",function(){a.tileLayerChange(e[0]),G.util.each(l.querySelectorAll(".geocloud-tile-button"),function(e){e.classList.remove("active")}),G.util.each(g.querySelectorAll(".geocloud-tile-button"),function(e){e.classList.remove("active")}),this.classList.add("active")})})}if(p.length>0){var m=G.menu.createGeoCloudPanel(s,"附加資訊圖層").area;p.forEach(function(e){var t=e[0].toLowerCase();o[t].setZIndex(1);var a=L.DomUtil.create("div","geocloud-tile-button",m),n=L.DomUtil.create("div","geocloud-tile-image",a),i=L.DomUtil.create("div","geocloud-tile-describe",a);a.title=e[1],n.style.background="url(/map_core/style/images/tiles/"+t+".png) no-repeat",i.textContent=e[1],a.addEventListener("click",function(){this.classList.contains("active")?r.removeLayer(o[t]):r.addLayer(o[t]),this.classList.toggle("active")})})}},G.menu.zone_tile=function(e,t,a,n){return new G.menu.Zone_Tile(e,t,a,n)},G.menu.Zone_Import=function(e,t,a,n){var r=(a.mainMap,a.tileLayers,n.tile,e.createMenuControl("匯入",null,t,"zone_import"));G.menu.createGeoCloudPanel(r,"匯入圖層").area},G.menu.zone_import=function(e,t,a,n){return new G.menu.Zone_Import(e,t,a,n)},L.drawLocal.draw.handlers.marker.tooltip.start=LanguageValue.LeafletDrawMarkerTip,L.drawLocal.draw.handlers.polygon.tooltip.start=LanguageValue.LeafletDrawStartTip,L.drawLocal.draw.handlers.polygon.tooltip.cont=LanguageValue.LeafletDrawStartCont,L.drawLocal.draw.handlers.polygon.tooltip.end=LanguageValue.LeafletDrawPolygonEndTip,L.drawLocal.draw.handlers.polyline.tooltip.start=LanguageValue.LeafletDrawStartTip,L.drawLocal.draw.handlers.polyline.tooltip.cont=LanguageValue.LeafletDrawStartCont,L.drawLocal.draw.handlers.polyline.tooltip.end=LanguageValue.LeafletDrawPolylineEndTip,L.drawLocal.draw.handlers.rectangle.tooltip.start=LanguageValue.LeafletDrawRetangle,L.drawLocal.draw.handlers.simpleshape.tooltip.end=LanguageValue.LeafletDrawSimpleShapeEndTip,["Point","Polyline","Polygon"].forEach(function(e){G.geo.set[e]={set:function(t,a){var n=t.style,r=this.gmap,o=r.overLayers[e],i=G.ui.popupEditButtons(a,n,r,o);a.bindPopup(G.ui.popupContent(i))}},"Point"===e?G.geo.set.Point.style=function(e,t){return L.marker(t,{icon:L.divIcon(e.style)})}:G.geo.set[e].style=function(e,t){return e.style}}),G.menu.Zone_Draw=function(e,t,a,n){var r=a.mainMap,o=a.mainMap,i=a.overLayers;["Point","Polyline","Polygon"].forEach(function(e){a.overLayers||(a.overLayers={}),a.overLayers[e]||(a.overLayers[e]=L.layerGroup().addTo(r))});var s=e.createMenuControl("手繪",null,t,"zone_draw"),l=G.menu.createGeoCloudPanel(s,LanguageValue.DrawManage),c=G.menu.createGeoCloudPanel(s,LanguageValue.Point),u=G.menu.createGeoCloudPanel(s,LanguageValue.Polyline),d=G.menu.createGeoCloudPanel(s,LanguageValue.Polygon);L.DomUtil.create("div","disable",c),L.DomUtil.create("div","disable",u),L.DomUtil.create("div","disable",d),a.drawPanels={},a.drawPanels.enable=function(){[c,u,d].forEach(function(e){e.querySelector(".disable").classList.remove("active")})},a.drawPanels.disable=function(){[c,u,d].forEach(function(e){e.querySelector(".disable").classList.add("active")})},["Point","Polyline","Polygon"].forEach(function(e){G.ui.bulbButton(l.area,LanguageValue[e],function(){var t=a.mainMap,n=a.overLayers[e];this.classList.contains("active")?(t.addLayer(n),t.fire("moveend")):t.removeLayer(n)}).click()}),o.on("draw:created",function(e){var t,n,r=e.layerType,o=e.layer;switch(r){case"marker":t=i.Point,n=g.style();break;case"polyline":t=i.Polyline,n=b.style();break;case"polygon":if(t=i.Polygon,n=w.style(),"string"!=typeof n.fillColor){var s="p"+w.fillColor.pattern.querySelector(".active").title;n.fillColor=G.color.pattern[s],n.fillColorCode=s}}o.feature=o.toGeoJSON(),o.feature.style=n,t.addLayer(o),G.util.each(g.marker.children,function(e){e.classList.remove("active")});var l=G.ui.popupEditButtons(o,n,a,t);o.bindPopup(G.ui.popupContent(l))}),o.on("draw:drawstop",function(e){G.util.each(g.marker.children,function(e){e.classList.remove("active")})});var p=new L.Draw.Marker(o),g={color:{input:G.ui.color(function(){G.util.each(g.marker.children,function(e){e.style.color=this.value}.bind(this))})}};g.style=function(){var e=g.color.input.value,t=g.marker.querySelector(".active");return{className:"geocloud-draw-marker-icon",iconSize:[36,36],iconAnchor:[18,18],html:'<div style="color:'+e+';">'+t.innerHTML+"</div>"}};var m=["fa-map-marker","fa-dot-circle-o","fa-child"],h=L.DomUtil.create("table","",L.DomUtil.create("div","table",c.area));["color","marker"].forEach(function(e){var t=L.DomUtil.create("tr","",h),a=L.DomUtil.create("td","",t),n=L.DomUtil.create("td","",t);switch(e){case"color":a.textContent=LanguageValue.Color,n.appendChild(g.color.input);break;case"marker":a.textContent="符號";var r=L.DomUtil.create("div","marker-area",n);m.forEach(function(e){var t=L.DomUtil.create("div","marker",r);if(L.DomUtil.create("i","fa "+e,t),t.addEventListener("click",function(){G.util.each(g.marker.children,function(e){e.classList.remove("active")}),this.classList.add("active"),p.options.icon=L.divIcon(g.style()),p.enable()}),t.style.color="#000",/geo-icon-A201|geo-icon-A301|geo-icon-A401/gi.test(e)){var a=G.ui.create("span","value",0,t);a.style.top="-4px",a.style.left="8px"}}),g.marker=r}});var y=new L.Draw.Polyline(o),b={color:{input:G.ui.color()},weight:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,10,.1,function(){b.weight.span.textContent=this.value})},dashArray:{span:G.ui.create("span","value",0),input:G.ui.slider(0,0,24,.1,function(){b.dashArray.span.textContent=this.value})},opacity:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,1,.1,function(){b.opacity.span.textContent=this.value})}},f=L.DomUtil.create("table","",L.DomUtil.create("div","table",u.area));for(var v in b){var C=L.DomUtil.create("tr","",f),D=L.DomUtil.create("td","",C),x=L.DomUtil.create("td","",C);switch(v){case"color":D.textContent=LanguageValue.Color,x.appendChild(b.color.input);break;case"weight":D.textContent=LanguageValue.Width,D.appendChild(document.createElement("br")),D.appendChild(b.weight.span),x.appendChild(b.weight.input);break;case"dashArray":D.textContent=LanguageValue.Dash,D.appendChild(document.createElement("br")),D.appendChild(b.dashArray.span),x.appendChild(b.dashArray.input);break;case"opacity":D.textContent=LanguageValue.Opcity,D.appendChild(document.createElement("br")),D.appendChild(b.opacity.span),x.appendChild(b.opacity.input)}}b.style=function(){var e={};return["weight","opacity","dashArray"].forEach(function(t){e[t]=parseFloat(b[t].input.value)}),e.color=b.color.input.value,e};var _=(G.ui.button(u.area,LanguageValue.Draw,function(){y.options.shapeOptions=b.style(),y.enable()}),new L.Draw.Polygon(o)),w={color:{input:G.ui.color()},weight:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,10,.1,function(){w.weight.span.textContent=this.value})},dashArray:{span:G.ui.create("span","value",0),input:G.ui.slider(0,0,24,.1,function(){w.dashArray.span.textContent=this.value})},opacity:{span:G.ui.create("span","value",1),input:G.ui.slider(1,0,1,.1,function(){w.opacity.span.textContent=this.value})},fillColor:{input:G.ui.color()},fillOpacity:{span:G.ui.create("span","value",.6),input:G.ui.slider(.6,0,1,.1,function(){w.fillOpacity.span.textContent=this.value})}},k=L.DomUtil.create("table","",L.DomUtil.create("div","table",d.area));for(var v in w){var C=L.DomUtil.create("tr","",k),D=L.DomUtil.create("td","",C),x=L.DomUtil.create("td","",C);switch(v){case"color":D.textContent=LanguageValue.Polyline+LanguageValue.Color,x.appendChild(w.color.input);break;case"weight":D.textContent=LanguageValue.Width,D.appendChild(document.createElement("br")),D.appendChild(w.weight.span),x.appendChild(w.weight.input);break;case"dashArray":D.textContent=LanguageValue.Dash,D.appendChild(document.createElement("br")),D.appendChild(w.dashArray.span),x.appendChild(w.dashArray.input);break;case"opacity":D.textContent=LanguageValue.Opcity,D.appendChild(document.createElement("br")),D.appendChild(w.opacity.span),x.appendChild(w.opacity.input);break;case"fillColor":var T=G.ui.create("span","switch active",LanguageValue.Polygon+LanguageValue.Color,D),E=G.ui.create("span","switch",LanguageValue.Polygon+LanguageValue.Legend,D),M=w.fillColor.input,S=L.DomUtil.create("div","pattern-area",x);x.appendChild(M),w.fillColor.pattern=S,G.color.patternList.forEach(function(e,t){e.forEach(function(e,t){var a=L.DomUtil.create("div","pattern",S);a.title=e,a.style.backgroundPosition="0px "+-90*t+"px",a.addEventListener("click",function(){G.util.each(S.children,function(e){e.classList.remove("active")}),this.classList.add("active")})})}),S.firstElementChild.classList.add("active"),T.addEventListener("click",function(){T.classList.add("active"),E.classList.remove("active"),M.style.display="",S.style.display="none"}),E.addEventListener("click",function(){T.classList.remove("active"),E.classList.add("active"),M.style.display="none",S.style.display=""}),S.style.display="none";break;case"fillOpacity":D.textContent=LanguageValue.FillOpcity,D.appendChild(document.createElement("br")),D.appendChild(w.fillOpacity.span),x.appendChild(w.fillOpacity.input)}}w.style=function(){var e={};if(["weight","opacity","dashArray","fillOpacity"].forEach(function(t){e[t]=parseFloat(w[t].input.value)}),e.color=w.color.input.value,T.classList.contains("active"))e.fillColor=w.fillColor.input.value;else{var t=w.fillColor.pattern.querySelector(".active").title;e.fillColor=G.color.pattern["p"+t]}return e};G.ui.button(d.area,LanguageValue.Draw,function(){_.options.shapeOptions=L.extend(_.options.shapeOptions,w.style()),_.enable()})},G.menu.zone_draw=function(e,t,a,n){return new G.menu.Zone_Draw(e,t,a,n)},G.menu.Zone_Animation=function(e,t,a,n){var r=(a.mainMap,a.tileLayers,n.tile,e.createMenuControl("動畫",G.menubutton.zone_animation(),t,"zone_animation")),o=G.menu.createGeoCloudPanel(r,"圖層動畫輪播資訊",!1,"div",!0,!1,function(e){$(".geocloud-panel a").each(function(t,a){this!=e.currentTarget&&this.classList.remove("active")});var t=e.currentTarget.classList.contains("active");t?G.swipe._leftLayer&&(G.WMTS.Tile("gsm").addTo(a.mainMap),a.mainMap.removeLayer(G.swipe._leftLayer),a.mainMap.removeLayer(G.swipe._rightLayer),document.querySelectorAll(".geocloud-menuContent-swipe .geocloud-panel .area .disable").forEach(function(e){e.classList.add("active")}),G.swipe.remove()):(a.mainMap.eachLayer(function(e,t){a.mainMap.removeLayer(e)}),G.WMTS.Tile("gsm").addTo(a.mainMap),document.querySelectorAll(".geocloud-menuContent-slider .geocloud-panel .area .control_bar .disable")[0].classList.add("active"),$.playBar.getAction()&&$.playBar.Stop())}),i=["請選擇","一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],s=G.ui.create("div","timeline-left","起始年分:",o.area);s.style="margin: 5px;";var l=G.ui.create("select","timeone","",s);l.setAttribute("id","mySelect");for(var c=0;c<i.length;c++){var u=document.createElement("option");u.setAttribute("value",c),u.text=i[c],l.appendChild(u)}l.onclick=function(){$(".control_bar .disable")[0].classList[1]||$(".control_bar .disable")[0].classList.add("active")},l.onchange=function(){if(0!=this.value){p.setAttribute("id","mySelect"),Number(p.value)<Number(this.value)&&(p.value=Number(this.value));for(var e=0;e<i.length;e++)e<this.value?p.options[e].disabled=!0:p.options[e].disabled=!1;p.disabled=!1}else p.disabled=!0,p.value=0};var d=G.ui.create("div","timeline-right","結束年分:",o.area);d.style="margin: 5px;";for(var p=G.ui.create("select","timetwo","",d),c=0;c<i.length;c++){var u=document.createElement("option");u.setAttribute("value",c),u.text=i[c],p.appendChild(u)}p.onclick=function(){$(".control_bar .disable")[0].classList[1]||$(".control_bar .disable")[0].classList.add("active")},p.disabled=!0;var g=G.ui.create("div","timeline-Enter","",o.area);g.style="position: absolute;top: 45px;left: 110px;";var m=G.ui.button(g,"年份確認",function(e){for(var t=0;t<$(".geocloud-menuContent-geo")[0].childNodes.length;t++)"active"==$(".geocloud-menuContent-geo")[0].childNodes[t].querySelector("a").classList.value&&$(".geocloud-menuContent-geo")[0].childNodes[t].querySelector("a").click();$.ajax({type:"post",url:"/map/bar_data",async:!0,data:{yearone:Number($(".timeone")[0].value),yeartwo:Number($(".timetwo")[0].value)},success:function(e){console.log(e),$.playBar.Stop(),$.playBar.addBar($(".bar")),$.playBar.changeBarColor("#72dfff"),$.playBar.Stop(),$.playBar.clearlayer(),$.playBar.setvalue(e.data),$(".control_bar .disable")[0].classList.remove("active")}})});m.style="width: 49px;height: 45px;font-size: 13px;margin-left:30px";var h=G.ui.create("div","control_bar","",o.area);h.style="position:relative;margin-top:15px";var y=G.ui.create("div","bar","start",h),y=G.ui.create("div","bar_start","",h);
y.addEventListener("click",function(){l.disabled=!0,p.disabled=!0,$.playBar.getAction()||$.playBar.Begin()});var b=G.ui.create("div","bar_stop","",h);b.addEventListener("click",function(){var e=$.playBar.getAction();e&&$.playBar.Stop(),e=!1,l.disabled=!1,p.disabled=!1});var f=G.ui.create("div","bar_restart","",h);f.addEventListener("click",function(){$.playBar.Stop(),$.playBar.addBar($(".bar")),$.playBar.changeBarColor("#72dfff"),$.playBar.Stop(),l.disabled=!1,p.disabled=!1});var v=G.ui.create("div","bar_record","",h);v.addEventListener("click",function(){if(!$.playBar.getAction()){var e=G.ui.modal(document.querySelector("body")),t=document.createElement("div");t.className="pacman";for(var a=0,n=5;a<n;a++){var r=document.createElement("div");t.appendChild(r)}e.appendChild(t),e.show(t),f.click(),$.playBar.ScreenShot(function(t){$.playBar.Stop(),$.ajax({type:"post",url:"/map/record",async:!0,data:t,processData:!1,contentType:!1,success:function(t){if(!t)return void alert("影片擷取錯誤");var a=G.dataProcess.base64ToBlob(t,"video/mp4");(new Date).getTime();saveAs(a,"${name}.mp4"),e.hide()}})})}}),$.playBar.addBar($(".bar")),$.playBar.changeBarColor("#72dfff"),$.playBar.Stop();var C=document.createElement("div");C.className="disable active",h.appendChild(C)},G.menu.zone_animation=function(e,t,a,n){return new G.menu.Zone_Animation(e,t,a,n)},G.menu.Zone_List=function(e,t,a,n){function r(e){dialog_list=L.DomUtil.create("div","dengue",$("#platform")[0]);var t=document.createElement("table");t.id="table_dengue",t.width="100%",t.border="1px solid black";for(var a=document.createElement("tr"),n=0;n<5;n++){var r=["法傳編號","居住地","性別","年齡","發病日"],o=document.createElement("th");o.innerHTML=r[n],a.appendChild(o)}var i=document.createElement("thead");i.appendChild(a);for(var s=document.createElement("tbody"),n=0;n<e.length;n++)row=s.insertRow(n),cell0=row.insertCell(0),cell0.innerHTML=e[n].REPORT,cell1=row.insertCell(1),cell1.innerHTML=e[n].RESIDENCE_COUNTY_NAME+" "+e[n].RESIDENCE_TOWN_NAME,cell2=row.insertCell(2),cell2.innerHTML=e[n].GENDER_DESC,cell3=row.insertCell(3),cell3.innerHTML=e[n].SICK_AGE,cell4=row.insertCell(4),cell4.innerHTML=e[n].SICK_DATE;t.appendChild(i),t.appendChild(s),dialog_list.appendChild(t),$("#table_dengue").DataTable({destroy:!0,language:{decimal:"",emptyTable:"沒有數據",info:"目前顯示 _START_ 至 _END_ 筆，共 _TOTAL_ 筆",infoEmpty:"顯示第 0 至 0 筆，共 0 筆",infoFiltered:" (從 _MAX_ 筆資料中篩選)",infoPostFix:"",thousands:",",lengthMenu:"顯示筆數： _MENU_",loadingRecords:"載入中...",processing:"處理中...",search:"搜尋：",zeroRecords:"未找到相符資料",paginate:{first:"第一頁",last:"最後一頁",next:"下一頁",previous:"上一頁"},aria:{sortAscending:": 使用順序排列",sortDescending:": 使用反序排列"}},nowrap:"nowrap"});$(".dengue").dialog({title:"清單查詢-登革熱案例",autoOpen:!1,height:387,width:838,buttons:{Cancel:function(){$(".dengue").dialog("close")}},close:function(){$(".dengue").dialog("close")}})}function o(e){dialog_list=L.DomUtil.create("div","bucket",$("#platform")[0]);var t=document.createElement("table");t.id="table_bucket",t.width="100%",t.border="1px solid black";for(var a=document.createElement("tr"),n=0;n<3;n++){var r=["誘卵桶編號","所在地區","調查日期"],o=document.createElement("th");o.innerHTML=r[n],a.appendChild(o)}var i=document.createElement("thead");i.appendChild(a);for(var s=document.createElement("tbody"),n=0;n<e.length;n++)row=s.insertRow(n),cell0=row.insertCell(0),cell0.innerHTML=e[n].bucket_id,cell1=row.insertCell(1),cell1.innerHTML=e[n].country+" "+e[n].town,cell2=row.insertCell(2),cell2.innerHTML=e[n].investigate_date;t.appendChild(i),t.appendChild(s),dialog_list.appendChild(t),$("#table_bucket").DataTable({destroy:!0,language:{decimal:"",emptyTable:"沒有數據",info:"目前顯示 _START_ 至 _END_ 筆，共 _TOTAL_ 筆",infoEmpty:"顯示第 0 至 0 筆，共 0 筆",infoFiltered:" (從 _MAX_ 筆資料中篩選)",infoPostFix:"",thousands:",",lengthMenu:"顯示筆數： _MENU_",loadingRecords:"載入中...",processing:"處理中...",search:"搜尋：",zeroRecords:"未找到相符資料",paginate:{first:"第一頁",last:"最後一頁",next:"下一頁",previous:"上一頁"},aria:{sortAscending:": 使用順序排列",sortDescending:": 使用反序排列"}},nowrap:"nowrap"});$(".bucket").dialog({title:"清單查詢-誘卵桶",autoOpen:!1,height:387,width:838,buttons:{Cancel:function(){$(".bucket").dialog("close")}},close:function(){$(".bucket").dialog("close")}})}var i,s=a.mainMap,l=(a.tileLayers,n.tile,e.createMenuControl("列表",G.menubutton.zone_list(),t,"zone_list"));G.menu.Zone_List.refreshList=function(e){};var c=G.menu.createGeoCloudPanel(l,"範圍選取"),u=G.menu.createGeoCloudPanel(l,"表單控制區");u.style.display="none";var d=(G.ui.button(u,"登革熱",function(e){$(".dengue").dialog("open")}).style="width: 49px;height: 45px;font-size: 13px;margin-left:49px",G.ui.button(u,"誘卵桶",function(e){$(".bucket").dialog("open")}).style="width: 49px;height: 45px;font-size: 13px;margin-left:30px",G.ui.button(c,"自訂範圍",function(e){"none"!=this.parentElement.parentElement.children[1].style.display&&(this.parentElement.parentElement.children[1].style.display="none"),i=1;var t={showArea:!1,shapeOptions:{stroke:!0,color:"black",weight:1,opacity:1,fill:!1,downloadfile:!0,clickable:!0}},a=[];s.eachLayer(function(e,t){e.options&&e.options.downloadfile&&a.push(e.toGeoJSON().geometry)}),0==a.length?(polygonDraw=new L.Draw.Polygon(s,t),polygonDraw.enable(),$(".text")[0].innerText="*確定範圍後按下方查詢紐",$(".text")[0].style="color: red;font-size: 19px;s",d.style.display=""):alert("只能選擇一塊範圍")}).style="width: 49px;height: 45px;font-size: 13px;margin-left:49px",G.ui.button(c,"螢幕擷取",function(e){"none"!=this.parentElement.parentElement.children[1].style.display&&(this.parentElement.parentElement.children[1].style.display="none"),i=2,s.eachLayer(function(e,t){e.options&&e.options.downloadfile&&s.removeLayer(e)}),$(".text")[0].innerText="*請按下方查詢紐",$(".text")[0].style="color: red;font-size: 20px;padding: 21px;",d.style.display=""}).style="width: 49px;height: 45px;font-size: 13px;margin-left:30px",G.ui.create("div","senbtn","",c));d.style.display="none";G.ui.create("span","text","",d),G.ui.button(d,"清單查詢",function(e){var t="";1==i?(s.eachLayer(function(e,a){if(e.options&&e.options.downloadfile){for(var n in e.getLatLngs())t=0==n?e.getLatLngs()[n].lng+","+e.getLatLngs()[n].lat:t+","+e.getLatLngs()[n].lng+","+e.getLatLngs()[n].lat;s.removeLayer(e)}}),""==t?alert("請先選擇範圍"):$.ajax({type:"post",url:"/map/datalist",async:!0,data:{bbox:t},success:function(e){d.style.display="none",u.style.display="",$(".dengue")[0]&&($(".dengue").remove(),$(".bucket").remove()),r(e.data[1]),o(e.data[0])}})):(t=s.getBounds().toBBoxString(),$.ajax({type:"post",url:"/map/datalist",async:!0,data:{bbox:t},success:function(e){d.style.display="none",u.style.display="",$(".dengue")[0]&&($(".dengue").remove(),$(".bucket").remove()),r(e.data[1]),o(e.data[0])}}))}).style="width: 207px;height: 30px;font-size: 13px;margin:5px"},G.menu.zone_list=function(e,t,a,n){return new G.menu.Zone_List(e,t,a,n)},G.menu.Zone_Legend=function(e,t,a,n){var r=(a.mainMap,a.tileLayers,n.tile,e.createMenuControl("圖例",G.menubutton.zone_legend(),t,"zone_legend"));G.menu.createGeoCloudPanel(r,"病例點位").area},G.menu.zone_legend=function(e,t,a,n){return new G.menu.Zone_Legend(e,t,a,n)},G.menu.Zone_Logout=function(e,t,a,n){function r(){swal({title:"確定登出？",text:"確定要登出嗎？",icon:"warning",confirmButtonText:"確定",cancelButtonText:"取消",buttons:!0}).then(function(e){e&&$(location).attr("href","/map/deauthorize")})}a.mainMap,a.tileLayers,e.createMenuControl("登出",G.menubutton.zone_logout(),null,null,r)},G.menu.zone_logout=function(e,t,a,n){return new G.menu.Zone_Logout(e,t,a,n)},G.menu.Zone_Information=function(e,t,a,n){function r(){$.ajax({url:"/map/information",async:!0,dataType:"json",type:"GET"}).done(function(e){e.html=e.html.replace(/<img /g,'<img style="width:100%" '),e.html=e.html.replace(/\n/g,"<p>"),i.innerHTML=e.html,i.style="text-align:left;",swal({content:i}).then(function(e){$(".swal-modal").attr("style","")}),$(".swal-modal").css({width:"95%","max-width":"1000px",height:"95%","overflow-y":"auto"})})}var o=e.createMenuControl("FAQ",G.menubutton.zone_information(),null,null,r),i=G.ui.create("div","","",o)},G.menu.zone_information=function(e,t,a,n){return new G.menu.Zone_Information(e,t,a,n)},G.menu.Zone_Disease=function(e,t,a,n){function r(){event.preventDefault(),$(".geocloud-control-menu-dropdown").toggleClass("is-view")}var o=[{id:"dengue",img_url:"/map/assets/images/dengue.svg",url:"/map/dengue",icon:G.menubutton.zone_disease_dengue()}],i="dengue",s=o[0];o.forEach(function(e){window.location.href.indexOf(e.id)>=0&&(s=e,i=e.id)});var l=e.createStaticMenuButton("疾病別",s.icon,r),c=L.DomUtil.create("ul","geocloud-control-menu-dropdown",l);o.forEach(function(e){var t=G.ui.create("li","",'<img class="icon" src="'+e.img_url+'" style="width:48px;height:48px;color:white;" />',c);t.title=e,t.addEventListener("click",function(){i!=e.id&&(window.location=e.url)})})},G.menu.zone_disease=function(e,t,a,n){return new G.menu.Zone_Disease(e,t,a,n)},G.menu.DengueGraph=function(e,t,a,n){function r(){var e=[{id:"locale",name:"境外移入",legends:[{name:"本土病例",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"境外病例",icon:'<div style="background:#506D8D;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"gender",name:"性別",legends:[{name:"女",icon:'<div style="background:#A8779E;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"男",icon:'<div style="background:#3573C0;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"age",name:"年齡層",legends:[{name:"0-14歲",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"15-49歲",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"50-64歲",icon:'<div style="background:#F5D062;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"65歲以上",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"blood",name:"血清型",legends:[{name:"第一型",icon:'<div style="background:#BD5B4E;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"第二型",icon:'<div style="background:#F0975C;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"第三型",icon:'<div style="background:#5FAF9F;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"第四型",icon:'<div style="background:#495787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無結果或未檢驗",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"dead",name:"重症死亡",legends:[{name:"死亡",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"重症",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"非重症及非死亡",icon:'<div style="background:#F5D062;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"date",name:"發病時間",legends:[{name:"7日內",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"7~14日",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"14~28日",icon:'<div style="background:#F5D062;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"28日以上",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueCase=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueCase.querySelector("ul").classList.add("layer-group-DengueCase"),w.DengueCase=G.layerBar.createDiseaseLayerBar("DengueCase",_.DengueCase,a,"DengueCase",!0),k.DengueCase=w.DengueCase.querySelector("a");var t=G.ui.create("div","btn-group","",_.DengueCase.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px";var n=G.ui.create("div","","",_.DengueCase.area);e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButton_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DengueCase.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DengueCase")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea),o.table.tr_guess=G.ui.create("tr","",'<td colspan="2"><span>*診斷中病例以</span><img src="/map/images/icon_circleguess.png" style="width:16px;height:16px;" /><span>表示</span></td>',o.table.table);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name}),k.DengueCase.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")})}function o(){_.DengueCaseHeatmap=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueCaseHeatmap.querySelector("ul").classList.add("layer-group-DengueCaseHeatmap"),w.DengueCaseHeatmap=G.layerBar.createDiseaseLayerBar("DengueCaseHeatmap",_.DengueCaseHeatmap,a,"DengueCaseHeatmap",!1),k.DengueCaseHeatmap=w.DengueCaseHeatmap.querySelector("a"),k.DengueCaseHeatmap.addEventListener("click",function(){})}function i(){var e=[{id:"City",name:"縣市"},{id:"Dist",name:"鄉鎮市區"},{id:"Village",name:"村里"}];_.DengueCaseArea=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueCaseArea.querySelector("ul").classList.add("layer-group-DengueCaseArea"),w.DengueCaseArea=G.layerBar.createDiseaseLayerBar("DengueCaseArea",_.DengueCaseArea,a,"DengueCaseArea"),k.DengueCaseArea=w.DengueCaseArea.querySelector("a"),k.DengueCaseArea.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display="",G.menu.DengueGraph.refreshLayer("DengueCaseArea")):(t.style.display="none",n.style.display="none")});var t=G.ui.create("div","btn-group","",_.DengueCaseArea.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none",e.forEach(function(n){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",n.name,t);k["DengueCaseArea"+n.id]=r,n.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=n.id,r.id="btn_graphToggleButtonCaseArea_"+n.id,r.target="div_legend_"+n.id,r.addEventListener("click",function(e){switch(G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.geo.set.DengueCaseArea.type=n.id,D.removeLayer(a.vectorTileLayers.DengueCaseArea),G.geo.set.DengueCaseArea.type){case"City":a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaCity;break;case"Dist":a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaDist;break;case"Village":a.vectorTileLayers.DengueCaseArea=a.vectorTileLayers.DengueCaseAreaVillage}a.vectorTileLayers.DengueCaseArea.addTo(D),k.DengueCaseArea.classList.contains("active")?a.vectorTileLayers.DengueCaseArea.getContainer().style.display="":a.vectorTileLayers.DengueCaseArea.getContainer().style.display="none",G.menu.DengueGraph.refreshLayer("DengueCaseArea")})});var n=G.ui.create("div","btn-group",'<img src="/map/images/svg_legend_dengueclusterarea.png" style="width:100%;" />',_.DengueCaseArea.area);n.style["margin-top"]="10px",n.style["margin-left"]="10px",n.style["margin-right"]="10px",n.style.display="none"}function s(){var e=[{id:"cluster",name:"群聚",legends:[{name:"未結案群聚",icon:'<div style="background:#b80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"已結案群聚",icon:'<div style="background:#78340e;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueCluster=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueCluster.querySelector("ul").classList.add("layer-group-DengueCluster"),w.DengueCluster=G.layerBar.createDiseaseLayerBar("DengueCluster",_.DengueCluster,a,"DengueCluster",!0),k.DengueCluster=w.DengueCluster.querySelector("a");var t=G.ui.create("div","","",_.DengueCluster.area),n={};n.legendarea=L.DomUtil.create("div","legend-area-denguecluster",t),n.legendarea.id="div_legend_denguecluster",n.legendarea.style.margin="6px",n.legendarea.style.marginLeft="20px",n.table={},n.table.table=L.DomUtil.create("table","",n.legendarea);for(var r=0;r<e[0].legends.length;r++)n.table.tr=L.DomUtil.create("tr","",n.table.table),n.table.tr.td1=L.DomUtil.create("td","legend-icon",n.table.tr),n.table.tr.td2=L.DomUtil.create("td","legend-word",n.table.tr),n.table.tr.icon=G.ui.create("div","",e[0].legends[r].icon,n.table.tr.td1),n.table.tr.word=L.DomUtil.create("span","",n.table.tr.td2),n.table.tr.word.textContent=e[0].legends[r].name;n.table.tr_draw=G.ui.create("tr","",'<td colspan="2"><img src="/map/images/svg/svg_legend_denguecluster.svg" style="width:150px;" /><br/><span>  群聚人數</span></td>',n.table.table),k.DengueCluster.addEventListener("click",function(){k.DengueCluster.classList.contains("active")?t.style.display="":t.style.display="none"})}function l(){var e=[{id:"closed",name:"是否結案",legends:[{name:"未結案群聚",icon:'<div style="background:#b80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"已結案群聚",icon:'<div style="background:#78340e;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueClusterPolygon=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueClusterPolygon.querySelector("ul").classList.add("layer-group-DengueClusterPolygon"),w.DengueClusterPolygon=G.layerBar.createDiseaseLayerBar("DengueClusterPolygon",_.DengueClusterPolygon,a,"DengueClusterPolygon",!1),k.DengueClusterPolygon=w.DengueClusterPolygon.querySelector("a"),k.DengueClusterPolygon.addEventListener("click",function(){});var t=G.ui.create("div","","",_.DengueClusterPolygon.area),n={};n.legendarea=L.DomUtil.create("div","legend-area-denguecluster",t),n.legendarea.id="div_legend_denguecluster",n.legendarea.style.margin="6px",n.legendarea.style.marginLeft="20px",n.table={},n.table.table=L.DomUtil.create("table","",n.legendarea);for(var r=0;r<e[0].legends.length;r++)n.table.tr=L.DomUtil.create("tr","",n.table.table),n.table.tr.td1=L.DomUtil.create("td","legend-icon",n.table.tr),n.table.tr.td2=L.DomUtil.create("td","legend-word",n.table.tr),n.table.tr.icon=G.ui.create("div","",e[0].legends[r].icon,n.table.tr.td1),n.table.tr.word=L.DomUtil.create("span","",n.table.tr.td2),n.table.tr.word.textContent=e[0].legends[r].name;k.DengueClusterPolygon.addEventListener("click",function(){k.DengueClusterPolygon.classList.contains("active")?t.style.display="":t.style.display="none"})}function c(){var e=[{id:"City",name:"縣市"},{id:"Dist",name:"鄉鎮市區"},{id:"Village",name:"村里"}];_.DengueClusterGroupArea=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueClusterGroupArea.querySelector("ul").classList.add("layer-group-DengueClusterGroupArea"),w.DengueClusterGroupArea=G.layerBar.createDiseaseLayerBar("DengueClusterGroupArea",_.DengueClusterGroupArea,a,"DengueClusterGroupArea"),k.DengueClusterGroupArea=w.DengueClusterGroupArea.querySelector("a"),k.DengueClusterGroupArea.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")});var t=G.ui.create("div","btn-group","",_.DengueClusterGroupArea.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none",e.forEach(function(a){var n=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);k["DengueClusterGroupArea"+a.id]=n,a.name==e[0].name&&n.classList.add("active"),n.style["border-radius"]="15px",n.value=a.id,n.id="btn_graphToggleButtonClusterAreaGroup_"+a.id,n.target="div_legend_"+a.id,n.addEventListener("click",function(e){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.DengueGraph.switchVTLayer("DengueClusterGroupArea"+a.id,this.classList.contains("active"))})});var n=G.ui.create("div","btn-group",'<img src="/map/images/svg_legend_dengueclusterarea.png" style="width:100%;" />',_.DengueClusterGroupArea.area);n.style["margin-top"]="10px",n.style["margin-left"]="10px",n.style["margin-right"]="10px",n.style.display="none"}function u(){var e=[{id:"City",name:"縣市"},{id:"Dist",name:"鄉鎮市區"},{id:"Village",name:"村里"}];_.DengueClusterPeopleArea=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueClusterPeopleArea.querySelector("ul").classList.add("layer-group-DengueClusterPeopleArea"),w.DengueClusterPeopleArea=G.layerBar.createDiseaseLayerBar("DengueClusterPeopleArea",_.DengueClusterPeopleArea,a,"DengueClusterPeopleArea"),k.DengueClusterPeopleArea=w.DengueClusterPeopleArea.querySelector("a"),k.DengueClusterPeopleArea.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")});var t=G.ui.create("div","btn-group","",_.DengueClusterPeopleArea.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none",e.forEach(function(a){var n=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);k["DengueClusterPeopleArea"+a.id]=n,a.name==e[0].name&&n.classList.add("active"),n.style["border-radius"]="15px",n.value=a.id,n.id="btn_graphToggleButtonClusterAreaPeople_"+a.id,n.target="div_legend_"+a.id,n.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.DengueGraph.switchVTLayer("DengueClusterPeopleArea"+a.id,this.classList.contains("active"))})});var n=G.ui.create("div","btn-group",'<img src="/map/images/svg_legend_dengueclusterarea.png" style="width:100%;" />',_.DengueClusterPeopleArea.area);n.style["margin-top"]="10px",n.style["margin-left"]="10px",n.style["margin-right"]="10px",n.style.display="none"}function d(){var e=[{id:"Bi",name:"布氏級數",legends:[{name:"3級以上",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"2級",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1級",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0級",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"House",name:"住宅級數",legends:[{name:"3級以上",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"2級",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1級",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0級",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"Container",name:"容器級數",legends:[{name:"3級以上",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"2級",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1級",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0級",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"Worm",name:"成蟲級數幼蟲級數",legends:[{name:"3級以上",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"2級",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1級",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0級",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DenguePestMosquitoArea=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DenguePestMosquitoArea.querySelector("ul").classList.add("layer-group-DenguePestMosquitoArea"),w.DenguePestMosquitoArea=G.layerBar.createDiseaseLayerBar("DenguePestMosquitoArea",_.DenguePestMosquitoArea,a,"DenguePestMosquitoArea"),k.DenguePestMosquitoArea=w.DenguePestMosquitoArea.querySelector("a"),k.DenguePestMosquitoArea.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")});var t=G.ui.create("div","btn-group","",_.DenguePestMosquitoArea.area),n=G.ui.create("div","","",_.DenguePestMosquitoArea.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none",n.style.display="none",e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);k["DenguePestMosquitoArea"+a.id]=r,a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButtonDenguePestMosquitoArea_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.DengueGraph.switchVTLayer("DenguePestMosquitoArea"+a.id,this.classList.contains("active")),$(n).find(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DenguePest.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DenguePest")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name})}function p(){var e=[{id:"Egg",name:"總卵數",legends:[{name:"500以上",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"250~499",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1~250",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"Positive",name:"陽性率",legends:[{name:">= 60%",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"30 ~ 59%",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0 ~ 29%",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無調查資料",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DenguePestBucketArea=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DenguePestBucketArea.querySelector("ul").classList.add("layer-group-DenguePestBucketArea"),w.DenguePestBucketArea=G.layerBar.createDiseaseLayerBar("DenguePestBucketArea",_.DenguePestBucketArea,a,"DenguePestBucketArea"),k.DenguePestBucketArea=w.DenguePestBucketArea.querySelector("a"),k.DenguePestBucketArea.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")});var t=G.ui.create("div","btn-group","",_.DenguePestBucketArea.area),n=G.ui.create("div","","",_.DenguePestBucketArea.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none",n.style.display="none",e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);k["DenguePestBucketArea"+a.id]=r,a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButtonDenguePestBucketArea_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.DengueGraph.switchVTLayer("DenguePestBucketArea"+a.id,this.classList.contains("active")),$(n).find(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DenguePest.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DengueCase")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),
o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name})}function g(){var e=[{id:"Egg",name:"總卵數",legends:[{name:">= 200",icon:'<div style="background:#B80001;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"150~199",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"100~149",icon:'<div style="background:#F6C3A2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1~99",icon:'<div style="background:#FFF0C5;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"0",icon:'<div style="background:#FFFFFF;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DenguePestBucketPoint=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DenguePestBucketPoint.querySelector("ul").classList.add("layer-group-DenguePestBucketPoint"),w.DenguePestBucketPoint=G.layerBar.createDiseaseLayerBar("DenguePestBucketPoint",_.DenguePestBucketPoint,a,"DenguePestBucketPoint",!0),k.DenguePestBucketPoint=w.DenguePestBucketPoint.querySelector("a"),k.DenguePestBucketPoint.addEventListener("click",function(){k.DenguePestBucketPoint.classList.contains("active")?t.style.display="":t.style.display="none"});var t=G.ui.create("div","","",_.DenguePestBucketPoint.area);e.forEach(function(a){var n={};n.legendarea=L.DomUtil.create("div","legend-area",t),n.legendarea.id="div_legend_"+a.id,n.legendarea.style.margin="6px",n.legendarea.style.marginLeft="20px",a.name==e[0].name?n.legendarea.style.display="":n.legendarea.style.display="none",n.table={},n.table.table=L.DomUtil.create("table","",n.legendarea);for(var r=0;r<a.legends.length;r++)n.table.tr=L.DomUtil.create("tr","",n.table.table),n.table.tr.td1=L.DomUtil.create("td","legend-icon",n.table.tr),n.table.tr.td2=L.DomUtil.create("td","legend-word",n.table.tr),n.table.tr.icon=G.ui.create("div","",a.legends[r].icon,n.table.tr.td1),n.table.tr.word=L.DomUtil.create("span","",n.table.tr.td2),n.table.tr.word.textContent=a.legends[r].name})}function m(){var e=[{id:"Type",name:"列管原因",legends:[{name:"多人分租",icon:'<div style="background:#DE8344;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"曾查獲其他陽性孳生源",icon:'<div style="background:#556C8E;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"其他",icon:'<div style="background:#B79230;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無資料",icon:'<div style="background:#BDBDBD;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DenguePestVegetablePoint=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DenguePestVegetablePoint.querySelector("ul").classList.add("layer-group-DenguePestVegetablePoint"),w.DenguePestVegetablePoint=G.layerBar.createDiseaseLayerBar("DenguePestVegetablePoint",_.DenguePestVegetablePoint,a,"DenguePestVegetablePoint",!1),k.DenguePestVegetablePoint=w.DenguePestVegetablePoint.querySelector("a"),k.DenguePestVegetablePoint.addEventListener("click",function(){k.DenguePestVegetablePoint.classList.contains("active")?t.style.display="":t.style.display="none"});var t=G.ui.create("div","","",_.DenguePestVegetablePoint.area);e.forEach(function(a){var n={};n.legendarea=L.DomUtil.create("div","legend-area",t),n.legendarea.id="div_legend_"+a.id,n.legendarea.style.margin="6px",n.legendarea.style.marginLeft="20px",a.name==e[0].name?n.legendarea.style.display="":n.legendarea.style.display="none",n.table={},n.table.table=L.DomUtil.create("table","",n.legendarea);for(var r=0;r<a.legends.length;r++)n.table.tr=L.DomUtil.create("tr","",n.table.table),n.table.tr.td1=L.DomUtil.create("td","legend-icon",n.table.tr),n.table.tr.td2=L.DomUtil.create("td","legend-word",n.table.tr),n.table.tr.icon=G.ui.create("div","",a.legends[r].icon,n.table.tr.td1),n.table.tr.word=L.DomUtil.create("span","",n.table.tr.td2),n.table.tr.word.textContent=a.legends[r].name})}function h(){var e=[{id:"time",name:"防治時間",legends:[{name:"14日內防治",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"15日前防治",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DenguePrevent=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DenguePrevent.querySelector("ul").classList.add("layer-group-DenguePrevent"),w.DenguePrevent=G.layerBar.createDiseaseLayerBar("DenguePrevent",_.DenguePrevent,a,"DenguePrevent",!0),k.DenguePrevent=w.DenguePrevent.querySelector("a"),k.DenguePrevent.addEventListener("click",function(){});var t=G.ui.create("div","btn-group","",_.DenguePrevent.area),n=G.ui.create("div","","",_.DenguePrevent.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px",e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButton_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DenguePrevent.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DenguePrevent")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name})}function y(){var e=[{id:"level",name:"醫療機構層級",legends:[{name:"醫學中心",icon:'<div style="background:#385492;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"區域醫院",icon:'<div style="background:#7F7F7F;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueMedical=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueMedical.querySelector("ul").classList.add("layer-group-DengueMedical"),w.DengueMedical=G.layerBar.createDiseaseLayerBar("DengueMedical",_.DengueMedical,a,"DengueMedical",!0),k.DengueMedical=w.DengueMedical.querySelector("a");var t=G.ui.create("div","btn-group","",_.DengueMedical.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px";var n=G.ui.create("div","","",_.DengueMedical.area);e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButton_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DengueMedical.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DengueMedical")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name}),k.DengueMedical.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")})}function b(){var e=[{id:"Type",name:"種類",legends:[{name:"異常風險區域",icon:'<div style="background:#EA712B;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueRiskSpatial=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueRiskSpatial.querySelector("ul").classList.add("layer-group-DengueRiskSpatial"),w.DengueRiskSpatial=G.layerBar.createDiseaseLayerBar("DengueRiskSpatial",_.DengueRiskSpatial,a,"DengueRiskSpatial",!0),k.DengueRiskSpatial=w.DengueRiskSpatial.querySelector("a"),k.DengueRiskSpatial.addEventListener("click",function(){k.DengueRiskSpatial.classList.contains("active")?t.style.display="":t.style.display="none"});var t=G.ui.create("div","","",_.DengueRiskSpatial.area);e.forEach(function(a){var n={};n.legendarea=L.DomUtil.create("div","legend-area",t),n.legendarea.id="div_legend_"+a.id,n.legendarea.style.margin="6px",n.legendarea.style.marginLeft="20px",a.name==e[0].name?n.legendarea.style.display="":n.legendarea.style.display="none",n.table={},n.table.table=L.DomUtil.create("table","",n.legendarea);for(var r=0;r<a.legends.length;r++)n.table.tr=L.DomUtil.create("tr","",n.table.table),n.table.tr.td1=L.DomUtil.create("td","legend-icon",n.table.tr),n.table.tr.td2=L.DomUtil.create("td","legend-word",n.table.tr),n.table.tr.icon=G.ui.create("div","",a.legends[r].icon,n.table.tr.td1),n.table.tr.word=L.DomUtil.create("span","",n.table.tr.td2),n.table.tr.word.textContent=a.legends[r].name})}function f(){var e=[{id:"village",name:"村里別",legends:[{name:"擴張",icon:'<div style="background:#B02318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"持平",icon:'<div style="background:#385492;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"減少",icon:'<div style="background:#5E813F;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"無時空群聚",icon:'<div style="background:#F2F2F2;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}];_.DengueRiskMST=G.menu.createGeoCloudPanel(C,"",!0,"ul"),_.DengueRiskMST.querySelector("ul").classList.add("layer-group-DengueRiskMST"),w.DengueRiskMST=G.layerBar.createDiseaseLayerBar("DengueRiskMST",_.DengueRiskMST,a,"DengueRiskMST",!0),k.DengueRiskMST=w.DengueRiskMST.querySelector("a");var t=G.ui.create("div","btn-group","",_.DengueRiskMST.area);t["data-toggle"]="buttons",t.style["margin-left"]="10px",t.style["margin-right"]="10px";var n=G.ui.create("div","","",_.DengueRiskMST.area);e.forEach(function(a){var r=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,t);a.name==e[0].name&&r.classList.add("active"),r.style["border-radius"]="15px",r.value=a.id,r.id="btn_graphToggleButton_"+a.id,r.target="div_legend_"+a.id,r.addEventListener("click",function(){G.util.each(t.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.DengueRiskMST.toggleType=this.value,G.menu.DengueGraph.refreshLayer("DengueRiskMST")});var o={};o.legendarea=L.DomUtil.create("div","legend-area",n),o.legendarea.id="div_legend_"+a.id,o.legendarea.style.margin="6px",o.legendarea.style.marginLeft="20px",a.name==e[0].name?o.legendarea.style.display="":o.legendarea.style.display="none",o.table={},o.table.table=L.DomUtil.create("table","",o.legendarea);for(var i=0;i<a.legends.length;i++)o.table.tr=L.DomUtil.create("tr","",o.table.table),o.table.tr.td1=L.DomUtil.create("td","legend-icon",o.table.tr),o.table.tr.td2=L.DomUtil.create("td","legend-word",o.table.tr),o.table.tr.icon=G.ui.create("div","",a.legends[i].icon,o.table.tr.td1),o.table.tr.word=L.DomUtil.create("span","",o.table.tr.td2),o.table.tr.word.textContent=a.legends[i].name}),k.DengueRiskMST.addEventListener("click",function(){"none"==t.style.display?(t.style.display="",n.style.display=""):(t.style.display="none",n.style.display="none")})}function v(){var e=G.menu.createGeoCloudPanel(C,"匯入及手繪圖層"),t=G.ui.create("div","row","",e.area);t.style.margin="0px",t.style["text-align"]="center";var a=G.ui.create("button","geocloud-button geocloud-theme","匯入圖層  |+",t),n=G.ui.create("button","geocloud-button geocloud-theme","手繪圖層  |+",t);a.style.margin="3px",n.style.margin="3px",a.addEventListener("click",function(){var e=$(".geocloud-menuContent-zone_import")[0];"none"==e.style.display&&(e.style.display="")}),n.addEventListener("click",function(){var e=$(".geocloud-menuContent-zone_draw")[0];"none"==e.style.display&&(e.style.display="")})}var C=e.createMenuControl("圖例圖層",G.menubutton.zone_legend(),t,"DengueGraph"),D=a.mainMap,x=a.vectorTileLayers,_={},w={},k={},T={},E=!0,M=["BoundaryCity","BoundaryDist","BoundaryVillage"];M.forEach(function(e){G.geo.getData(e,_[e],a,!1,!1,!1,!1)}),G.menu.DengueGraph.switchPanel=function(e){var t=[];switch(t.forEach(function(e){}),x=a.vectorTileLayers,x.BoundaryCity&&D.removeLayer(x.BoundaryCity),x.BoundaryDist&&D.removeLayer(x.BoundaryDist),x.BoundaryVillage&&D.removeLayer(x.BoundaryVillage),$(_.DengueCase).hide(),$(T.DengueCase).hide(),x.DengueCase&&D.removeLayer(x.DengueCase),$(_.DengueCaseHeatmap).hide(),$(T.DengueCaseHeatmap).hide(),x.DengueCaseHeatmap&&D.removeLayer(x.DengueCaseHeatmap),$(_.DengueCaseArea).hide(),$(T.DengueCaseArea).hide(),x.DengueCaseArea&&D.removeLayer(x.DengueCaseArea),$(_.DengueCluster).hide(),$(_.DengueClusterPolygon).hide(),$(_.DengueClusterGroupArea).hide(),$(_.DengueClusterPeopleArea).hide(),$(T.DengueCluster).hide(),$(T.DengueClusterPolygon).hide(),$(T.DengueClusterGroupArea).hide(),$(T.DengueClusterPeopleArea).hide(),x.DengueCluster&&D.removeLayer(x.DengueCluster),x.DengueClusterPolygon&&D.removeLayer(x.DengueClusterPolygon),$(_.DenguePestMosquitoArea).hide(),$(_.DenguePestBucketArea).hide(),$(_.DenguePestBucketPoint).hide(),$(T.DenguePestBucketPoint).hide(),x.DenguePestBucketPoint&&D.removeLayer(x.DenguePestBucketPoint),$(_.DenguePestVegetablePoint).hide(),$(T.DenguePestVegetablePoint).hide(),x.DenguePestVegetablePoint&&D.removeLayer(x.DenguePestVegetablePoint),$(_.DenguePrevent).hide(),$(T.DenguePrevent).hide(),x.DenguePrevent&&D.removeLayer(x.DenguePrevent),$(_.DengueMedical).hide(),$(T.DengueMedical).hide(),x.DengueMedical&&D.removeLayer(x.DengueMedical),$(_.DengueRiskSpatial).hide(),$(T.DengueRiskSpatial).hide(),$(_.DengueRiskMST).hide(),$(T.DengueRiskMST).hide(),x.DengueRiskSpatial&&D.removeLayer(x.DengueRiskSpatial),x.DengueRiskMST&&D.removeLayer(x.DengueRiskMST),e){case"DengueSummary":case"DengueCase":$(_.DengueCase).show(),$(T.DengueCase).show(),$(_.DengueCaseHeatmap).show(),$(T.DengueCaseHeatmap).show(),$(_.DengueCaseArea).show(),$(T.DengueCaseArea).show(),x.DengueCase&&(x.DengueCase.addTo(D),x.DengueCase.getContainer().style.display=k.DengueCase.classList.contains("active")?"":"none"),x.DengueCaseHeatmap&&(x.DengueCaseHeatmap.addTo(D),x.DengueCaseHeatmap._el.style.display=k.DengueCaseHeatmap.classList.contains("active")?"":"none"),x.DengueCaseArea&&(x.DengueCaseArea.addTo(D),x.DengueCaseArea.getContainer().style.display=k.DengueCaseArea.classList.contains("active")?"":"none"),G.ui.mouseLayerEvent(D,"DengueCase",G.ui.popupInfoWindow("DengueCase"),E);break;case"DengueCluster":$(_.DengueCluster).show(),$(_.DengueClusterPolygon).show(),$(_.DengueClusterGroupArea).show(),$(_.DengueClusterPeopleArea).show(),$(T.DengueCluster).show(),$(T.DengueClusterPolygon).show(),$(T.DengueClusterGroupArea).show(),$(T.DengueClusterPeopleArea).show(),x.DengueCluster&&(x.DengueCluster.addTo(D),x.DengueCluster.getContainer().style.display=k.DengueCluster.classList.contains("active")?"":"none"),x.DengueClusterPolygon&&(x.DengueClusterPolygon.addTo(D),x.DengueClusterPolygon.getContainer().style.display=k.DengueClusterPolygon.classList.contains("active")?"":"none"),G.ui.mouseLayerEvent(D,"DengueCluster",G.ui.popupInfoWindow("DengueCluster"),E);break;case"DenguePest":$(_.DenguePestMosquitoArea).show(),$(_.DenguePestBucketArea).show(),$(_.DenguePestBucketPoint).show(),$(_.DenguePestVegetablePoint).show(),$(T.DenguePestMosquitoArea).show(),$(T.DenguePestBucketArea).show(),$(T.DenguePestBucketPoint).show(),$(T.DenguePestVegetablePoint).show(),x.DenguePestBucketPoint&&(x.DenguePestBucketPoint.addTo(D),x.DenguePestBucketPoint.getContainer().style.display=k.DenguePestBucketPoint.classList.contains("active")?"":"none"),x.DenguePestVegetablePoint&&(x.DenguePestVegetablePoint.addTo(D),x.DenguePestVegetablePoint.getContainer().style.display=k.DenguePestVegetablePoint.classList.contains("active")?"":"none"),G.ui.mouseLayerEvent(D,"DenguePestVegetablePoint",G.ui.popupInfoWindow("DenguePestVegetablePoint"),E),G.ui.mouseLayerEvent(D,"DenguePestBucketPoint",G.ui.popupInfoWindow("DenguePestBucketPoint"),E);break;case"DenguePrevent":$(_.DenguePrevent).show(),$(T.DenguePrevent).show(),x.DenguePrevent&&(x.DenguePrevent.addTo(D),x.DenguePrevent.getContainer().style.display=k.DenguePrevent.classList.contains("active")?"":"none"),G.ui.mouseLayerEvent(D,"DenguePrevent",G.ui.popupInfoWindow("DenguePrevent"),E);break;case"DengueMedical":$(_.DengueMedical).show(),$(T.DengueMedical).show(),x.DengueMedical&&(x.DengueMedical.addTo(D),x.DengueMedical.getContainer().style.display=k.DengueMedical.classList.contains("active")?"":"none"),G.ui.mouseLayerEvent(D,"DengueMedical",G.ui.popupInfoWindow("DengueMedical"),E);break;case"DengueWeather":break;case"DengueRisk":$(_.DengueRiskSpatial).show(),$(T.DengueRiskSpatial).show(),$(_.DengueRiskMST).show(),$(T.DengueRiskMST).show(),x.DengueRiskSpatial&&(x.DengueRiskSpatial.addTo(D),x.DengueRiskSpatial.getContainer().style.display=k.DengueRiskSpatial.classList.contains("active")?"":"none"),x.DengueRiskMST&&(x.DengueRiskMST.addTo(D),x.DengueRiskMST.getContainer().style.display=k.DengueRiskMST.classList.contains("active")?"":"none")}},G.menu.DengueGraph.switchVTLayer=function(e,t){if(x.DengueCase&&D.removeLayer(x.DengueCase),x.DengueCaseAreaCity&&D.removeLayer(x.DengueCaseArea),x.DengueCaseAreaDist&&D.removeLayer(x.DengueCaseArea),x.DengueCaseAreaVillage&&D.removeLayer(x.DengueCaseArea),x.DengueCaseHeatmap&&D.removeLayer(x.DengueCaseHeatmap),x.DengueCluster&&D.removeLayer(x.DengueCluster),x.DengueClusterPolygon&&D.removeLayer(x.DengueClusterPolygon),x.BoundaryCity&&D.removeLayer(x.BoundaryCity),x.BoundaryDist&&D.removeLayer(x.BoundaryDist),x.BoundaryVillage&&D.removeLayer(x.BoundaryVillage),x.DenguePestBucketPoint&&D.removeLayer(x.DenguePestBucketPoint),x.DenguePestVegetablePoint&&D.removeLayer(x.DenguePestVegetablePoint),x.DenguePrevent&&D.removeLayer(x.DenguePrevent),x.DengueMedical&&D.removeLayer(x.DengueMedical),x.DengueRiskSpatial&&D.removeLayer(x.DengueRiskSpatial),x.DengueRiskMST&&D.removeLayer(x.DengueRiskMST),t)switch(e){case"DengueCase":x.DengueCase&&x.DengueCase.addTo(D),G.ui.mouseLayerEvent(D,"DengueCase",G.ui.popupInfoWindow("DengueCase"),E);break;case"DengueCaseArea":x.DengueCaseArea&&x.DengueCaseArea.addTo(D);break;case"DengueCaseAreaCity":"City"!=G.geo.set.DengueCaseArea.type&&(G.geo.set.DengueCaseArea.type="City",G.menu.DengueGraph.refreshLayer("DengueCaseArea")),x.DengueCaseArea&&x.DengueCaseArea.addTo(D);break;case"DengueCaseAreaDist":"Dist"!=G.geo.set.DengueCaseArea.type&&(G.geo.set.DengueCaseArea.type="Dist",G.menu.DengueGraph.refreshLayer("DengueCaseArea")),x.DengueCaseArea&&x.DengueCaseArea.addTo(D);break;case"DengueCaseAreaVillage":"Village"!=G.geo.set.DengueCaseArea.type&&(G.geo.set.DengueCaseArea.type="Village",G.menu.DengueGraph.refreshLayer("DengueCaseArea")),x.DengueCaseArea&&x.DengueCaseArea.addTo(D);break;case"DengueCaseHeatmap":x.DengueCaseHeatmap&&x.DengueCaseHeatmap.addTo(D);break;case"DengueCluster":x.DengueCluster&&x.DengueCluster.addTo(D),G.ui.mouseLayerEvent(D,"DengueCluster",G.ui.popupInfoWindow("DengueCluster"),E);break;case"DengueClusterPolygon":x.DengueClusterPolygon&&x.DengueClusterPolygon.addTo(D);break;case"DengueClusterGroupAreaCity":"GroupCity"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="GroupCity",G.menu.DengueGraph.refreshLayer("BoundaryCity")),x.BoundaryCity&&x.BoundaryCity.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryCity",G.ui.popupInfoWindow(e),E);break;case"DengueClusterGroupAreaDist":"GroupDist"!=G.geo.set.BoundaryDist.type&&(G.geo.set.BoundaryDist.type="GroupDist",G.menu.DengueGraph.refreshLayer("BoundaryDist")),x.BoundaryDist&&x.BoundaryDist.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryDist",G.ui.popupInfoWindow(e),E);break;case"DengueClusterGroupAreaVillage":"GroupVillage"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="GroupVillage",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DengueClusterPeopleAreaCity":"PeopleCity"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="PeopleCity",G.menu.DengueGraph.refreshLayer("BoundaryCity")),x.BoundaryCity&&x.BoundaryCity.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryCity",G.ui.popupInfoWindow(e),E);break;case"DengueClusterPeopleAreaDist":"PeopleDist"!=G.geo.set.BoundaryDist.type&&(G.geo.set.BoundaryDist.type="PeopleDist",G.menu.DengueGraph.refreshLayer("BoundaryDist")),x.BoundaryDist&&x.BoundaryDist.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryDist",G.ui.popupInfoWindow(e),E);break;case"DengueClusterPeopleAreaVillage":"PeopleVillage"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="PeopleVillage",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestMosquitoAreaBi":"MosquitoBi"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="MosquitoBi",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestMosquitoAreaHouse":"MosquitoHouse"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="MosquitoHouse",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestMosquitoAreaContainer":"MosquitoContainer"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="MosquitoContainer",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestMosquitoAreaWorm":"MosquitoWorm"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="MosquitoWorm",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestBucketAreaEgg":"BucketEgg"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="BucketEgg",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestBucketAreaPositive":"BucketPositive"!=G.geo.set.BoundaryVillage.type&&(G.geo.set.BoundaryVillage.type="BucketPositive",G.menu.DengueGraph.refreshLayer("BoundaryVillage")),x.BoundaryVillage&&x.BoundaryVillage.addTo(D),G.ui.mouseLayerEvent(D,"BoundaryVillage",G.ui.popupInfoWindow(e),E);break;case"DenguePestBucketPoint":x.DenguePestBucketPoint&&x.DenguePestBucketPoint.addTo(D),G.ui.mouseLayerEvent(D,"DenguePestBucketPoint",G.ui.popupInfoWindow("DenguePestBucketPoint"),E);break;case"DenguePestVegetablePoint":x.DenguePestVegetablePoint&&x.DenguePestVegetablePoint.addTo(D),G.ui.mouseLayerEvent(D,"DenguePestVegetablePoint",G.ui.popupInfoWindow("DenguePestVegetablePoint"),E);break;case"DenguePrevent":x.DenguePrevent&&x.DenguePrevent.addTo(D),G.ui.mouseLayerEvent(D,"DenguePrevent",G.ui.popupInfoWindow("DenguePrevent"),E);break;case"DengueMedical":x.DengueMedical&&x.DengueMedical.addTo(D);break;case"DengueRiskSpatial":x.DengueRiskSpatial&&x.DengueRiskSpatial.addTo(D);break;case"DengueRiskMST":x.DengueRiskMST&&x.DengueRiskMST.addTo(D)}},G.menu.DengueGraph.refresh=function(e,t){var n=[];switch(e){case"DengueCase":n=["DengueCase","DengueCaseHeatmap","DengueCaseArea"];break;case"DengueCluster":n=["DengueCluster","DengueClusterPolygon"]}n.forEach(function(e){var t=a.vectorTileLayers[e];t&&a.mainMap.removeLayer(t)}),G.geo.getData[e]&&G.geo.getData[e].params&&t&&(G.geo.getData[e].params=t),G.geo.getData(e,_[e],a,!0,!1,!1,!1)},G.menu.DengueGraph.refreshLayer=function(e){switch(e){case"DengueCase":case"DengueCluster":case"DenguePest":case"DenguePrevent":case"DengueMedical":case"BoundaryCity":case"BoundaryDist":case"BoundaryVillage":if(a.vectorTileLayers[e]){var t=geojsonvt(G.geo.tile.geojsons[e],G.geo.tile.options);t.outOfBounds={},t.outOfBounds.checked={},a.vectorTileLayers[e].drawTile=null,a.vectorTileLayers[e].drawTile=G.vectorTile.draw(t,function(t){return G.geo.set[e].style(t)}),a.vectorTileLayers[e].redraw()}break;case"DengueCaseArea":if(a.vectorTileLayers[e]){var n="BoundaryCity";switch(G.geo.set.DengueCaseArea.type){case"City":n="BoundaryCity";break;case"Dist":n="BoundaryDist";break;case"Village":n="BoundaryVillage"}var t=geojsonvt(G.geo.tile.geojsons[n],G.geo.tile.options);t.outOfBounds={},t.outOfBounds.checked={},a.vectorTileLayers[e].drawTile=null,a.vectorTileLayers[e].drawTile=G.vectorTile.draw(t,function(t){return G.geo.set[e].style(t)}),a.vectorTileLayers[e].redraw()}}},r(),o(),i(),s(),l(),c(),u(),d(),p(),g(),m(),h(),y(),b(),f(),v(),G.menu.DengueGraph.switchPanel("DengueSummary")},G.menu.dengueGraph=function(e,t,a,n){return new G.menu.DengueGraph(e,t,a,n)},G.menu.MeaslesGraph=function(e,t,a,n){function r(){C.MeaslesCase=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesCase.querySelector("ul").classList.add("layer-group-MeaslesCase"),x.MeaslesCase=G.layerBar.createDiseaseLayerBar("MeaslesCase",C.MeaslesCase,a,"MeaslesCase",!0),_.MeaslesCase=x.MeaslesCase.querySelector("a"),_.MeaslesCase.addEventListener("click",function(){_.MeaslesCase.classList.contains("active")?t.style.display="":t.style.display="none"});var e=G.ui.create("div","btn-group","",C.MeaslesCase.area),t=G.ui.create("div","","",C.MeaslesCase.area);e["data-toggle"]="buttons",e.style["margin-left"]="10px",e.style["margin-right"]="10px",p.forEach(function(a){var n=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,e);a.name==p[0].name&&n.classList.add("active"),n.style["border-radius"]="15px",n.value=a.id,n.id="btn_graphToggleButton_"+a.id,n.target="div_legend_"+a.id,n.addEventListener("click",function(){G.util.each(e.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.MeaslesCase.toggleType=this.value,G.menu.MeaslesGraph.refreshLayer("MeaslesCase")});var r={};r.legendarea=L.DomUtil.create("div","legend-area",t),r.legendarea.id="div_legend_"+a.id,r.legendarea.style.margin="6px",r.legendarea.style.marginLeft="20px",a.name==p[0].name?r.legendarea.style.display="":r.legendarea.style.display="none",r.table={},r.table.table=L.DomUtil.create("table","",r.legendarea),r.table.tr_guess=G.ui.create("tr","",'<td colspan="2"><span>*診斷中病例以</span><img src="/map/images/icon_circleguess.png" style="width:16px;height:16px;" /><span>表示</span></td>',r.table.table);for(var o=0;o<a.legends.length;o++)r.table.tr=L.DomUtil.create("tr","",r.table.table),r.table.tr.td1=L.DomUtil.create("td","legend-icon",r.table.tr),r.table.tr.td2=L.DomUtil.create("td","legend-word",r.table.tr),r.table.tr.icon=G.ui.create("div","",a.legends[o].icon,r.table.tr.td1),r.table.tr.word=L.DomUtil.create("span","",r.table.tr.td2),r.table.tr.word.textContent=a.legends[o].name})}function o(){C.MeaslesCluster=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesCluster.querySelector("ul").classList.add("layer-group-MeaslesCluster"),x.MeaslesCluster=G.layerBar.createDiseaseLayerBar("MeaslesCluster",C.MeaslesCluster,a,"MeaslesCluster",!0),_.MeaslesCluster=x.MeaslesCluster.querySelector("a"),_.MeaslesCluster.addEventListener("click",function(){_.MeaslesCluster.classList.contains("active")?e.style.display="":e.style.display="none"});var e=G.ui.create("div","","",C.MeaslesCluster.area),t={};t.legendarea=L.DomUtil.create("div","legend-area-measlescluster",e),t.legendarea.id="div_legend_measlescluster",t.legendarea.style.margin="6px",t.legendarea.style.marginLeft="20px",t.table={},t.table.table=L.DomUtil.create("table","",t.legendarea);for(var n=0;n<g[0].legends.length;n++)t.table.tr=L.DomUtil.create("tr","",t.table.table),t.table.tr.td1=L.DomUtil.create("td","legend-icon",t.table.tr),t.table.tr.td2=L.DomUtil.create("td","legend-word",t.table.tr),t.table.tr.icon=G.ui.create("div","",g[0].legends[n].icon,t.table.tr.td1),t.table.tr.word=L.DomUtil.create("span","",t.table.tr.td2),t.table.tr.word.textContent=g[0].legends[n].name}function i(){C.MeaslesClusterContact=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesClusterContact.querySelector("ul").classList.add("layer-group-MeaslesClusterContact"),x.MeaslesClusterContact=G.layerBar.createDiseaseLayerBar("MeaslesClusterContact",C.MeaslesClusterContact,a,"MeaslesClusterContact",!0),_.MeaslesClusterContact=x.MeaslesClusterContact.querySelector("a"),_.MeaslesClusterContact.addEventListener("click",function(){_.MeaslesClusterContact.classList.contains("active")?e.style.display="":e.style.display="none"});var e=G.ui.create("div","","",C.MeaslesClusterContact.area),t={};t.legendarea=L.DomUtil.create("div","legend-area-measlesclustercontact",e),t.legendarea.id="div_legend_measlesclustercontact",t.legendarea.style.margin="6px",t.legendarea.style.marginLeft="20px",t.table={},t.table.table=L.DomUtil.create("table","",t.legendarea);for(var n=0;n<m[0].legends.length;n++)t.table.tr=L.DomUtil.create("tr","",t.table.table),t.table.tr.td1=L.DomUtil.create("td","legend-icon",t.table.tr),t.table.tr.td2=L.DomUtil.create("td","legend-word",t.table.tr),t.table.tr.icon=G.ui.create("div","",m[0].legends[n].icon,t.table.tr.td1),t.table.tr.word=L.DomUtil.create("span","",t.table.tr.td2),t.table.tr.word.textContent=m[0].legends[n].name}function s(){C.MeaslesClusterContactArea=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesClusterContactArea.querySelector("ul").classList.add("layer-group-MeaslesClusterContactArea"),x.MeaslesClusterContactArea=G.layerBar.createDiseaseLayerBar("MeaslesClusterContactArea",C.MeaslesClusterContactArea,a,"MeaslesClusterContactArea"),_.MeaslesClusterContactArea=x.MeaslesClusterContactArea.querySelector("a"),_.MeaslesClusterContactArea.addEventListener("click",function(){"none"==e.style.display?(e.style.display="",t.style.display=""):(e.style.display="none",t.style.display="none")});var e=G.ui.create("div","btn-group","",C.MeaslesClusterContactArea.area);e["data-toggle"]="buttons",e.style["margin-left"]="10px",e.style["margin-right"]="10px",e.style.display="none",h.forEach(function(t){var a=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",t.name,e);
_["MeaslesClusterContactArea"+t.id]=a,t.name==h[0].name&&a.classList.add("active"),a.style["border-radius"]="15px",a.value=t.id,a.id="btn_graphToggleButtonClusterAreaGroup_"+t.id,a.target="div_legend_"+t.id,a.addEventListener("click",function(){G.util.each(e.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.MeaslesGraph.switchVTLayer("MeaslesClusterContactArea"+t.id,this.classList.contains("active"))})});var t=G.ui.create("div","btn-group",'<img src="/map/images/svg_legend_dengueclusterarea.png" style="width:100%;" />',C.MeaslesClusterContactArea.area);t.style["margin-top"]="10px",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none"}function l(){C.MeaslesContact=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesContact.querySelector("ul").classList.add("layer-group-MeaslesContact"),x.MeaslesContact=G.layerBar.createDiseaseLayerBar("MeaslesContact",C.MeaslesContact,a,"MeaslesContact",!0),_.MeaslesContact=x.MeaslesContact.querySelector("a"),_.MeaslesContact.addEventListener("click",function(){_.MeaslesContact.classList.contains("active")?t.style.display="":t.style.display="none"});var e=G.ui.create("div","btn-group","",C.MeaslesContact.area),t=G.ui.create("div","","",C.MeaslesContact.area);e["data-toggle"]="buttons",e.style["margin-left"]="10px",e.style["margin-right"]="10px",y.forEach(function(a){var n=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",a.name,e);a.name==y[0].name&&n.classList.add("active"),n.style["border-radius"]="15px",n.value=a.id,n.id="btn_graphToggleButton_"+a.id,n.target="div_legend_measlescontact_"+a.id,n.addEventListener("click",function(){G.util.each(e.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),$(".legend-area-measlescontact").each(function(){$(this).hide()}),$("#"+this.target).show(),G.geo.set.MeaslesContact.toggleType=this.value,G.menu.MeaslesGraph.refreshLayer("MeaslesContact")});var r={};r.legendarea=L.DomUtil.create("div","legend-area-measlescontact",t),r.legendarea.id="div_legend_measlescontact_"+a.id,r.legendarea.style.margin="6px",r.legendarea.style.marginLeft="20px",a.name==y[0].name?r.legendarea.style.display="":r.legendarea.style.display="none",r.table={},r.table.table=L.DomUtil.create("table","",r.legendarea);for(var o=0;o<a.legends.length;o++)r.table.tr=L.DomUtil.create("tr","",r.table.table),r.table.tr.td1=L.DomUtil.create("td","legend-icon",r.table.tr),r.table.tr.td2=L.DomUtil.create("td","legend-word",r.table.tr),r.table.tr.icon=G.ui.create("div","",a.legends[o].icon,r.table.tr.td1),r.table.tr.word=L.DomUtil.create("span","",r.table.tr.td2),r.table.tr.word.textContent=a.legends[o].name})}function c(){C.MeaslesContactArea=G.menu.createGeoCloudPanel(d,"",!0,"ul"),C.MeaslesContactArea.querySelector("ul").classList.add("layer-group-MeaslesContactArea"),x.MeaslesContactArea=G.layerBar.createDiseaseLayerBar("MeaslesContactArea",C.MeaslesContactArea,a,"MeaslesContactArea"),_.MeaslesContactArea=x.MeaslesContactArea.querySelector("a"),_.MeaslesContactArea.addEventListener("click",function(){"none"==e.style.display?(e.style.display="",t.style.display=""):(e.style.display="none",t.style.display="none")});var e=G.ui.create("div","btn-group","",C.MeaslesContactArea.area);e["data-toggle"]="buttons",e.style["margin-left"]="10px",e.style["margin-right"]="10px",e.style.display="none",b.forEach(function(t){var a=G.ui.create("label","btn btn-sm btn-secondary btnSelectToggle",t.name,e);_["MeaslesContactArea"+t.id]=a,t.name==b[0].name&&a.classList.add("active"),a.style["border-radius"]="15px",a.value=t.id,a.id="btn_graphToggleButtonContactAreaGroup_"+t.id,a.target="div_legend_"+t.id,a.addEventListener("click",function(){G.util.each(e.querySelectorAll(".btnSelectToggle"),function(e){e.classList.remove("active")}),this.classList.add("active"),G.menu.MeaslesGraph.switchVTLayer("MeaslesContactArea"+t.id,this.classList.contains("active"))})});var t=G.ui.create("div","btn-group",'<img src="/map/images/svg_legend_dengueclusterarea.png" style="width:100%;" />',C.MeaslesContactArea.area);t.style["margin-top"]="10px",t.style["margin-left"]="10px",t.style["margin-right"]="10px",t.style.display="none"}function u(){var e=G.menu.createGeoCloudPanel(d,"手繪圖層"),t=G.ui.create("div","row","",e.area);t.style.margin="0px",t.style["text-align"]="center";var a=G.ui.create("button","geocloud-button geocloud-theme","手繪圖層  |+",t);a.style.margin="3px",a.addEventListener("click",function(){var e=$(".geocloud-menuContent-zone_draw")[0];"none"==e.style.display&&(e.style.display="")})}var d=e.createMenuControl("圖例圖層",G.menubutton.zone_legend(),t,"measlesGraph"),p=[{id:"locale",name:"境外移入",legends:[{name:"本土病例",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"境外病例",icon:'<div style="background:#506D8D;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"gender",name:"性別",legends:[{name:"女",icon:'<div style="background:#A8779E;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"男",icon:'<div style="background:#3573C0;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"age",name:"年齡層",legends:[{name:"0歲",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1-6歲",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"7-19歲",icon:'<div style="background:#F5D062;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"20-39歲",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"40歲以上",icon:'<div style="background:#000000;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"date",name:"發病時間",legends:[{name:"10日內",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"10~28日",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"28日以上",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}],g=[{id:"cluster",name:"群聚個案",legends:[{name:"指標個案",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"其他個案",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}],m=[{id:"contact",name:"群聚個案接觸者",legends:[{name:"無症狀",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"有症狀",icon:'<div style="background:#1E253C;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}],h=[{id:"City",name:"縣市"},{id:"Dist",name:"鄉鎮市區"}],y=[{id:"gender",name:"性別",legends:[{name:"女",icon:'<div style="background:#A8779E;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"男",icon:'<div style="background:#3573C0;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"age",name:"年齡層",legends:[{name:"0歲",icon:'<div style="background:#B12318;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"1-6歲",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"7-19歲",icon:'<div style="background:#F5D062;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"20-39歲",icon:'<div style="background:#878787;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"40歲以上",icon:'<div style="background:#000000;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]},{id:"watch",name:"健康監測",legends:[{name:"進行中",icon:'<div style="background:#DF8244;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'},{name:"已完成",icon:'<div style="background:#506D8D;width:16px;height:16px;border-radius:8px;-webkit-border-radius:8px;-moz-border-radius:8px;" />'}]}],b=[{id:"City",name:"縣市"},{id:"Dist",name:"鄉鎮市區"}],f=a.mainMap,v=a.vectorTileLayers,C={},D=!0,x={},_={},w={},k=["BoundaryCity","BoundaryDist","BoundaryVillage"];k.forEach(function(e){G.geo.getData(e,C[e],a,!1,!1,!1,!1)}),G.menu.MeaslesGraph.switchPanel=function(e){switch($(C.MeaslesCase).hide(),$(w.MeaslesCase).hide(),$(C.MeaslesCluster).hide(),$(w.MeaslesCluster).hide(),$(C.MeaslesClusterContact).hide(),$(w.MeaslesClusterContact).hide(),$(C.MeaslesClusterContactArea).hide(),$(w.MeaslesClusterContactArea).hide(),$(C.MeaslesContact).hide(),$(w.MeaslesContact).hide(),$(C.MeaslesContactArea).hide(),$(w.MeaslesContactArea).hide(),v.MeaslesCase&&f.removeLayer(v.MeaslesCase),v.MeaslesCluster&&f.removeLayer(v.MeaslesCluster),v.MeaslesClusterContact&&f.removeLayer(v.MeaslesClusterContact),v.BoundaryCity&&f.removeLayer(v.BoundaryCity),v.BoundaryDist&&f.removeLayer(v.BoundaryDist),v.BoundaryVillage&&f.removeLayer(v.BoundaryVillage),v.MeaslesContact&&f.removeLayer(v.MeaslesContact),e){case"MeaslesSummary":case"MeaslesCase":$(C.MeaslesCase).show(),$(w.MeaslesCase).show(),v.MeaslesCase&&(v.MeaslesCase.addTo(f),_.MeaslesCase.classList.contains("active")?v.MeaslesCase.getContainer().style.display="":v.MeaslesCase.getContainer().style.display="none"),G.ui.mouseLayerEvent(f,"MeaslesCase",G.ui.popupInfoWindow("MeaslesCase"),D);break;case"MeaslesCluster":$(C.MeaslesCluster).show(),$(w.MeaslesCluster).show(),$(C.MeaslesClusterContact).show(),$(w.MeaslesClusterContact).show(),$(C.MeaslesClusterContactArea).show(),$(w.MeaslesClusterContactArea).show(),v.MeaslesCluster&&(v.MeaslesCluster.addTo(f),_.MeaslesCluster.classList.contains("active")?v.MeaslesCluster.getContainer().style.display="":v.MeaslesCluster.getContainer().style.display="none"),v.MeaslesClusterContact&&(v.MeaslesClusterContact.addTo(f),_.MeaslesClusterContact.classList.contains("active")?v.MeaslesClusterContact.getContainer().style.display="":v.MeaslesClusterContact.getContainer().style.display="none"),G.ui.mouseLayerEvent(f,"MeaslesCluster",G.ui.popupInfoWindow("MeaslesCluster"),D);break;case"MeaslesContact":$(C.MeaslesContact).show(),$(w.MeaslesContact).show(),$(C.MeaslesContactArea).show(),$(w.MeaslesContactArea).show(),v.MeaslesContact&&(v.MeaslesContact.addTo(f),_.MeaslesContact.classList.contains("active")?v.MeaslesContact.getContainer().style.display="":v.MeaslesContact.getContainer().style.display="none")}},G.menu.MeaslesGraph.switchVTLayer=function(e,t){if(v=a.vectorTileLayers,v.MeaslesCase&&f.removeLayer(v.MeaslesCase),v.MeaslesCluster&&f.removeLayer(v.MeaslesCluster),v.MeaslesClusterContact&&f.removeLayer(v.MeaslesClusterContact),v.BoundaryCity&&f.removeLayer(v.BoundaryCity),v.BoundaryDist&&f.removeLayer(v.BoundaryDist),v.BoundaryVillage&&f.removeLayer(v.BoundaryVillage),v.MeaslesContact&&f.removeLayer(v.MeaslesContact),t)switch(e){case"MeaslesCase":v.MeaslesCase&&v.MeaslesCase.addTo(f),G.ui.mouseLayerEvent(f,"MeaslesCase",G.ui.popupInfoWindow("MeaslesCase"),D);break;case"MeaslesCluster":v.MeaslesCluster&&v.MeaslesCluster.addTo(f),G.ui.mouseLayerEvent(f,"MeaslesCluster",G.ui.popupInfoWindow("MeaslesCluster"),D);break;case"MeaslesClusterContact":v.MeaslesClusterContact&&v.MeaslesClusterContact.addTo(f);break;case"MeaslesClusterContactAreaCity":"ClusterContactCity"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="ClusterContactCity",G.menu.MeaslesGraph.refreshLayer("BoundaryCity")),v.BoundaryCity&&v.BoundaryCity.addTo(f),G.ui.PopupInfoWindow.type="MeaslesClusterContactAreaCity",G.ui.mouseLayerEvent(f,"BoundaryCity",G.ui.popupInfoWindow("MeaslesClusterContactAreaCity"),D);break;case"MeaslesClusterContactAreaDist":"ClusterContactDist"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="ClusterContactDist",G.menu.MeaslesGraph.refreshLayer("BoundaryDist")),v.BoundaryDist&&v.BoundaryDist.addTo(f),G.ui.PopupInfoWindow.type="MeaslesClusterContactAreaDist",G.ui.mouseLayerEvent(f,"BoundaryDist",G.ui.popupInfoWindow("MeaslesClusterContactAreaDist"),D);break;case"MeaslesContact":v.MeaslesContact&&v.MeaslesContact.addTo(f),G.ui.mouseLayerEvent(f,"MeaslesContact",G.ui.popupInfoWindow("MeaslesContact"),D);break;case"MeaslesContactAreaCity":"ContactCity"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="ContactCity",G.menu.MeaslesGraph.refreshLayer("BoundaryCity")),v.BoundaryCity&&v.BoundaryCity.addTo(f),G.ui.PopupInfoWindow.type="MeaslesContactAreaCity",G.ui.mouseLayerEvent(f,"BoundaryCity",G.ui.popupInfoWindow("MeaslesContactAreaCity"),D);break;case"MeaslesContactAreaDist":"ContactDist"!=G.geo.set.BoundaryCity.type&&(G.geo.set.BoundaryCity.type="ContactDist",G.menu.MeaslesGraph.refreshLayer("BoundaryDist")),v.BoundaryDist&&v.BoundaryDist.addTo(f),G.ui.PopupInfoWindow.type="MeaslesContactAreaDist",G.ui.mouseLayerEvent(f,"BoundaryDist",G.ui.popupInfoWindow("MeaslesContactAreaDist"),D)}},G.menu.MeaslesGraph.refresh=function(e,t){var n=a.vectorTileLayers[e];n&&a.mainMap.removeLayer(n),G.geo.getData[e]&&(G.geo.getData[e].params=t,G.geo.getData(e,C[e],a,!0,!1,!1,!1))},G.menu.MeaslesGraph.refreshLayer=function(e){switch(e){case"MeaslesCase":case"MeaslesCluster":case"MeaslesClusterContact":case"MeaslesContact":var t=geojsonvt(G.geo.tile.geojsons[e],G.geo.tile.options);t.outOfBounds={},t.outOfBounds.checked={},a.vectorTileLayers[e].drawTile=null,a.vectorTileLayers[e].drawTile=G.vectorTile.draw(t,function(t){return G.geo.set[e].style(t)}),a.vectorTileLayers[e].redraw()}},r(),o(),i(),s(),l(),c(),u(),G.menu.MeaslesGraph.switchPanel("MeaslesSummary")},G.menu.measlesGraph=function(e,t,a,n){return new G.menu.MeaslesGraph(e,t,a,n)},function(e){function t(){if(u=!0,p=0,g=0,p=0,l){var e=Object.keys(l);e.forEach(function(e){for(var t=1;t<=D[e];t++)l[e][t]&&l[e][t].forEach(function(e){e._icon.firstElementChild.style.background="red",e.setOpacity(0)})})}}function a(){g=parseInt(p/y*c);for(var e=1,t=(Math.ceil(g/e),0),a=front_mon;a<=behind_mon;a++)if(t+=D[a],g<t){i(a,g-t+D[a]+1);break}}function n(){console.log(g);for(var t=0,a=front_mon;a<=behind_mon;a++)if(t+=D[a],g<t){console.log("${i}月${CurrTime - value + month[i] + 1}號"),i(a,g-t+D[a]+1);break}var n=!1;return p=1*p+m,p<y||g<c?g+=1:(p=y,r(),n=!0),e(".TheColorBar").css("width",p+1),e(".TimeBall").css("left",p-4),n}function r(){b||(u=!1),clearInterval(s)}function o(){u=!0,s=setInterval(n,250)}function i(e,t){if(l[e][t]&&l[e][t].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="red"}),l[e])for(o=1;o<t;o++)if(0!=l[e][o].length){var a=new Date("${data_month}-${data_day}"),n=new Date("${data_month}-${i}"),r=(a-n)/864e5;r>28?l[e][o].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="gray"}):r>14?l[e][o].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="yellow"}):r>7&&l[e][o].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="orange"})}for(var o=front_mon;o<e;o++)if(l[o])for(j=1;j<=D[o];j++)if(0!=l[o][j].length){var a=new Date("${data_month}-${data_day}"),n=new Date("${i}-${j}"),r=(a-n)/864e5;r>28?l[o][j].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="gray"}):r>14?l[o][j].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="yellow"}):r>7&&l[o][j].forEach(function(e){e.setOpacity(1),e._icon.firstElementChild.style.background="orange"})}for(var o=e;o<=behind_mon;o++)if(l[o]&&o==e)for(j=1;j<=D[o];j++)j>t&&0!=l[o][j].length&&l[o][j].forEach(function(e){e._icon.firstElementChild.style.background="red",e.setOpacity(0)});else if(l[o])for(j=1;j<=D[o];j++)0!=l[o][j].length&&l[o][j].forEach(function(e){e._icon.firstElementChild.style.background="red",e.setOpacity(0)})}var s,l,c,u=!0,d=0,p=0,g=0,m=0,h=0,y=0,b=!1,f=!1,v=0,C=0,D={1:31,2:28,3:31,4:30,5:31,6:30,7:31,8:31,9:30,10:31,11:30,12:31},x=L.divIcon({iconAnchor:[0,24],labelAnchor:[-6,0],popupAnchor:[0,-36],html:'<span style="background: red;width: 3rem;height: 3rem;display: block;left: -1.5rem;top: -1.5rem;position: relative;border-radius: 3rem 3rem 0;transform: rotate(45deg);border: 1px solid #FFFFFF" />'});jQuery.playBar={addBar:function(n){t(),n.empty(),n.append("<div class='BarControl'></div>"),e(".BarControl").append('<div class="TheBar"><div class="TimeBall"></div><div class="TheColorBar"></div></div>'),d=e(".TheBar").width(),h=1e3,y=d,e(".TimeBall").mousedown(function(e){v=e.clientX,e.preventDefault(),b=!0,f=!0,u&&(r(),u=!1)}),e(".geocloud-panel").mousemove(function(t){if(t.preventDefault(),C=t.clientX,f){var n=C-v;v=C,n<0?p- -n>0&&(p-=-n):p+n<y?p+=n:p=y,a(),e(".TheColorBar").css("width",p+1),e(".TimeBall").css("left",p-4)}}),e(document).mouseup(function(){if(f){f=!1,b=!1,C=0;parseInt(g)}})},Stop:function(){r()},Begin:function(){o()},ScreenShot:function(t){u=!0;var a=new FormData;!function r(){n();var o=e(".leaflet-map-pane")[0];domtoimage.toPng(o).then(function(e){return a.append(g,e),g==c?void t(a):void r()})["catch"](function(e){console.error("oops, something went wrong!",e)})}()},changeBarColor:function(t){var a="undefined"!=typeof t?t:"#3498DB";e(".TheColorBar").css("background",a)},changeFontColor:function(t){var a="undefined"!=typeof t?t:"#3498DB";e(".BarBeginTime,.BarFinishTime").css("color",a)},getTheTime:function(){return g},getAction:function(){return u},setvalue:function(t){front_mon=parseInt(e(".timeone")[0].value),behind_mon=parseInt(e(".timetwo")[0].value),c=0;for(var a=front_mon;a<=behind_mon;a++)c+=D[a];for(c=c,console.log("總共:"+c+"天"),m=d/c,l={},a=front_mon;a<=behind_mon;a++){for(data={},j=1;j<=D[a];j++)data["${j}"]=[];l["${i}"]=data}t.forEach(function(e){datamonth=new Date(e.SICK_DATE).getMonth()+1,dataday=new Date(e.SICK_DATE).getDate(),l[datamonth][dataday].push(L.marker([e.LAT,e.LON],{icon:x,opacity:0}).addTo(mymap.mainMap))})},clearlayer:function(){if(l){var e=Object.keys(l);e.forEach(function(e){for(var t=1;t<=D[e];t++)l[e][t]&&l[e][t].forEach(function(e){mymap.mainMap.removeLayer(e)})})}}}}(jQuery),G.tab={},G.tab.createGeoCloudPanel=function(e,t,a,n){var r=L.DomUtil.create("div","geocloud-panel",e),o=L.DomUtil.create("div","title",r),i=L.DomUtil.create(n?n:"div","area",r);return o.textContent=t,r.style.display=a?"none":"",r.area=i,r},G.tab.createGeoCloudPanel.tabType="摘要報表",G.tab.createGeoCloudPanel.tabId="DengueSummary",G.tab.tabClick=function(e){var t=!1;if(G.tab.createGeoCloudPanel.tabId!=this.id&&(t=!0),G.tab.createGeoCloudPanel.tabId=this.id,t)switch(this.id){case"TabControlDengueSummary":G.menu.DengueGraph.switchPanel("DengueSummary");break;case"TabControlDengueCase":G.menu.DengueGraph.switchPanel("DengueCase");break;case"TabControlDengueCluster":G.menu.DengueGraph.switchPanel("DengueCluster");break;case"TabControlDenguePest":G.menu.DengueGraph.switchPanel("DenguePest");break;case"TabControlDenguePrevent":G.menu.DengueGraph.switchPanel("DenguePrevent");break;case"TabControlDengueMedical":G.menu.DengueGraph.switchPanel("DengueMedical");break;case"TabControlDengueWeather":G.menu.DengueGraph.switchPanel("DengueWeather");break;case"TabControlDengueRisk":G.menu.DengueGraph.switchPanel("DengueRisk");break;case"TabControlmeaslesSummary":G.menu.MeaslesGraph.switchPanel("MeaslesSummary");break;case"TabControlmeaslesCase":G.menu.MeaslesGraph.switchPanel("MeaslesCase");break;case"TabControlmeaslesCluster":G.menu.MeaslesGraph.switchPanel("MeaslesCluster");break;case"TabControlmeaslesContact":G.menu.MeaslesGraph.switchPanel("MeaslesContact")}},G.tab.switchTab=function(e){$("#TabControl"+e)[0].classList.contains("active")&&G.tab.createGeoCloudPanel.tabId==e||$("#TabControl"+e)[0].click()},G.tabbutton=G.tabbutton?G.tabbutton:{},G.tabbutton.zone_dengue=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/layer.svg" class="icon" alt="" style="width:20px;height:20px;">  個案統計</h5>'},G.tabbutton.zone_controllocation=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/atom.svg" class="icon" alt="" style="width:20px;height:20px;">  防治</h5>'},G.tabbutton.zone_bucket=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  病媒</h5>'},G.tabbutton.dengueSummary=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/pie.svg" class="icon" alt="" style="width:20px;height:20px;">  摘要報表</h5>'},G.tabbutton.dengueCase=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/layer.svg" class="icon" alt="" style="width:20px;height:20px;">  個案統計</h5>'},G.tabbutton.dengueCluster=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/pie-chart.svg" class="icon" alt="" style="width:20px;height:20px;">  群聚</h5>'},G.tabbutton.denguePest=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  病媒</h5>'},G.tabbutton.denguePrevent=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  防治</h5>'},G.tabbutton.dengueMedical=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  醫療</h5>'},G.tabbutton.dengueWeather=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  環境氣象</h5>'},G.tabbutton.dengueRisk=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/virus.svg" class="icon" alt="" style="width:20px;height:20px;">  風險評估</h5>'},G.tabbutton.measlesSummary=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/measlesSummary.svg" class="icon" alt="" style="width:20px;height:20px;">  摘要報表</h5>'},G.tabbutton.measlesCase=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/measlesCase.svg" class="icon" alt="" style="width:20px;height:20px;">  個案統計</h5>'},G.tabbutton.measlesCluster=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/measlesCluster.svg" class="icon" alt="" style="width:20px;height:20px;">  群聚</h5>'},G.tabbutton.measlesContact=function(){return'<h5 style="margin-top:7px;"><img src="/map/assets/images/measlesContact.svg" class="icon" alt="" style="width:20px;height:20px;">  接觸者</h5>'},G.tab.DengueSummary=function(e,t,a,n){function r(){p.innerHTML="";var e={};e.grapharea=L.DomUtil.create("div","container",p),e.grapharea.titleDiv=G.ui.create("div","","",e.grapharea),e.grapharea.titleText=G.ui.create("h2","",'<b><i><span style="color:#235989;">'+u+"</span>登革熱個案統計摘要圖表</i></b>",e.grapharea.titleDiv),e.grapharea.selectArea=G.ui.create("select","","",e.grapharea.titleDiv),e.grapharea.selectArea.national=G.ui.create("option","","全國",e.grapharea.selectArea),e.grapharea.selectArea.center=G.ui.create("option","","台北區區管",e.grapharea.selectArea),e.grapharea.selectArea.dist=G.ui.create("option","","高雄市衛生局",e.grapharea.selectArea),e.grapharea.selectArea.village=G.ui.create("option","","高雄市苓雅區衛生所",e.grapharea.selectArea),$(e.grapharea.selectArea).on("change",function(){switch(u=this.value,this.value){case"全國":d={permission_level:1};break;case"台北區區管":d={county:"台北市,新北市,基隆市,宜蘭縣,金門縣,連江縣",permission_level:2};break;case"高雄市衛生局":d={county:"高雄市",permission_level:3};break;case"高雄市苓雅區衛生所":d={county:"高雄市",dist:"苓雅區",permission_level:4}}r()}),e.grapharea.selectArea.value=u,e.grapharea.line=G.ui.create("hr","","",e.grapharea.titleDiv),e.grapharea.style.display="",e.grapharea.row1=L.DomUtil.create("div","row",e.grapharea),e.grapharea.row2=L.DomUtil.create("div","row",e.grapharea),e.grapharea.row3=L.DomUtil.create("div","row",e.grapharea),e.grapharea.div_case_compare=L.DomUtil.create("div","col-sm-6",e.grapharea.row1),e.grapharea.div_case_compare.id="summary-chart-case-compare",G.ui.create("p","","<h4><b>歷年確定病例數比較</b></h4>",e.grapharea.div_case_compare),e.grapharea.div_case_summer=L.DomUtil.create("div","col-sm-6",e.grapharea.row1),e.grapharea.div_case_summer.id="summary-chart-case-summer";var t=(new Date).getFullYear(),a=(new Date).getMonth();a<=3&&t--,G.ui.create("p","","<h4><b>入夏後本土病例統計 ("+t+"年5月迄今)</b></h4>",e.grapharea.div_case_summer),e.grapharea.div_case_trend=L.DomUtil.create("div","col-sm-6",e.grapharea.row2),e.grapharea.div_case_trend.id="summary-chart-case-trend",G.ui.create("p","","<h4><b>歷年同期確定病例比較</b></h4>",e.grapharea.div_case_trend),e.grapharea.div_case_hidden=L.DomUtil.create("div","col-sm-6",e.grapharea.row2),e.grapharea.div_case_hidden.id="summary-chart-case-hidden",G.ui.create("p","","<h4><b>登革熱通報個案隱藏期趨勢</b></h4>",e.grapharea.div_case_hidden),e.grapharea.div_case_determine=L.DomUtil.create("div","col-sm-9",e.grapharea.row2),e.grapharea.div_case_determine.id="summary-chart-case-determine",G.ui.create("p","","<h4><b>近26週確定病例熱度圖</b></h4>",e.grapharea.div_case_determine),o(),i(),s(),l(),c()}function o(){$.ajax({url:"/map/data/dengue/tab/summary/compare",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){function t(e){var t=e;t.length>8&&(t=t.slice(t.length-8,t.length)),s.domain(d3.keys(t[0]).filter(function(e){return"sick_year"!==e})),t.forEach(function(e){var t=0;e.ages=s.domain().map(function(a){return{name:a,y0:t,y1:t+=+e[a]}}),e.total=e.ages[e.ages.length-1].y1}),o.domain(t.map(function(e){return e.sick_year})),i.domain([0,d3.max(t,function(e){return e.total})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.axisBottom(o)).append("text").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("fill","#000").attr("font-size",12).text("年份"),l.append("g").attr("class","y axis").call(d3.axisLeft(i)).append("text").attr("x",-50).attr("y",105).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("病例數");var a=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e,t){return"<span style='color:lightblue'>"+e.name+"</span><br>病例數： <span style='color:lightblue'>"+(e.y1-e.y0).toString()+"</span>"}),c=l.selectAll(".sick_year").data(t).enter().append("g").attr("class","g").attr("transform",function(e){return"translate("+o(e.sick_year)+",0)"});c.selectAll("rect").data(function(e){return e.ages}).enter().append("rect").attr("width",o.bandwidth()).attr("y",function(e){return i(e.y1)}).attr("height",function(e){return i(e.y0)-i(e.y1)}).style("fill",function(e){return s(e.name)}).on("mouseover",a.show).on("mouseout",a.hide).call(a);var u=l.selectAll(".legend").data(s.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+20*t+")"});u.append("rect").attr("x",n).attr("width",18).attr("height",18).style("fill",s),u.append("text").attr("x",n-6).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})}var a={top:20,right:20,bottom:30,left:60},n=450-a.left-a.right,r=350-a.top-a.bottom,o=d3.scaleBand().range([0,n]).padding(.1),i=d3.scaleLinear().range([r,0]),s=d3.scaleOrdinal(["#235989","#7fa8cb"]),l=d3.select("#summary-chart-case-compare").append("svg").attr("width",n+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");t(e)})}function i(){$.ajax({url:"/map/data/dengue/tab/summary/summer",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=document.getElementById("summary-chart-case-summer");t.table=L.DomUtil.create("table","table table-striped",t),t.table.head=G.ui.create("thead","",'<tr style="background-color:#699ad0"><th style="background-color:#699ad0" scope="col-md-2">行政區</th><th style="background-color:#699ad0" scope="col-md-2">通報病例</th><th style="background-color:#699ad0" scope="col-md-2">確定病例</th><th style="background-color:#699ad0" scope="col-md-2">重症病例</th><th style="background-color:#699ad0" scope="col-md-2">死亡病例</th></tr>',t.table),t.table.body=L.DomUtil.create("tbody","",t.table),e.forEach(function(e){G.ui.create("tr","",'<td scope="row">'+e["行政區"]+"</td><td>"+e["通報病例"]+"</td><td>"+e["確定病例"]+"</td><td>"+e["重症病例"]+"</td><td>"+e["死亡病例"]+"</td>",t.table.body)})})}function s(){$.ajax({url:"/map/data/dengue/tab/summary/trend",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=d3.select("#summary-chart-case-trend").append("svg"),a={top:20,right:20,bottom:30,left:50},n=450-a.left-a.right,r=300-a.top-a.bottom,o=t.append("g").attr("transform","translate("+a.left+","+a.top+")");t.attr("width",n+a.left+a.right),t.attr("height",r+a.top+a.bottom);var i=d3.scaleLinear().range([0,n]),s=d3.scaleLinear().range([r,0]),l=d3.scaleOrdinal(d3.schemeCategory10),c=d3.scaleOrdinal(["#235989","#7fa8cb","#c0d5ec","#bfbfbf"]),u=d3.line().x(function(e){return i(e.Week)}).y(function(e){return s(e.Value)}),d=e,p=Object.keys(e[0]).slice(0,4).map(function(e){return{id:e,values:d.map(function(t){return{Week:t.Week,Value:t[e]}})}});i.domain(d3.extent(d,function(e){return e.Week})),s.domain([d3.min(p,function(e){return d3.min(e.values,function(e){return e.Value})}),d3.max(p,function(e){return d3.max(e.values,function(e){return e.Value})})]),l.domain(p.map(function(e){return e.id})),c.domain(p.map(function(e){return e.id})),o.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+r+")").call(d3.axisBottom(i)).append("text").attr("fill","#000").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("font-size",12).text("發病週"),o.append("g").attr("class","axis axis--y").call(d3.axisLeft(s)),o.append("text").attr("x",-45).attr("y",75).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("病例數");var g=o.selectAll(".Trend").data(p).enter().append("g").attr("class","Trend").attr("height","300px");g.append("path").attr("class","line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width","1.5px").attr("d",function(e){return u(e.values)}).style("stroke",function(e){return c(e.id)});var m=t.selectAll(".legend").data(c.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+20*t+")"});m.append("rect").attr("x",n+24).attr("width",18).attr("height",18).style("fill",c),m.append("text").attr("x",n+18).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})})}function l(){$.ajax({url:"/map/data/dengue/tab/summary/hidden",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=d3.select("#summary-chart-case-hidden").append("svg"),a={top:20,right:20,bottom:30,left:50},n=450-a.left-a.right,r=300-a.top-a.bottom,o=t.append("g").attr("transform","translate("+a.left+","+a.top+")");t.attr("width",n+a.left+a.right),t.attr("height",r+a.top+a.bottom);var i=d3.scaleLinear().range([0,n]),s=d3.scaleLinear().range([r,0]),l=d3.scaleOrdinal(d3.schemeCategory10),c=d3.scaleOrdinal(["#bfbfbf","#235989","#7fa8cb","#c0d5ec"]),u=d3.line().x(function(e){return i(e.Week)}).y(function(e){return s(e.Value)}),d=e,p=[];Object.keys(e[0]).forEach(function(e){"Week"!=e&&p.push(e)});var g=p.map(function(e){return{id:e,values:d.map(function(t){return{Week:t.Week,Value:t[e]}})}});i.domain(d3.extent(d,function(e){return e.Week})),s.domain([d3.min(g,function(e){return d3.min(e.values,function(e){return e.Value})}),d3.max(g,function(e){return d3.max(e.values,function(e){return e.Value})})]),l.domain(g.map(function(e){return e.id})),c.domain(g.map(function(e){
return e.id})),o.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+r+")").call(d3.axisBottom(i)).append("text").attr("fill","#000").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("font-size",12).text("報告週"),o.append("g").attr("class","axis axis--y").call(d3.axisLeft(s)),o.append("text").attr("x",-45).attr("y",75).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("週平均（日）");var m=o.selectAll(".Trend").data(g).enter().append("g").attr("class","Trend").attr("height","300px");m.append("path").attr("class","line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width","1.5px").attr("d",function(e){return u(e.values)}).style("stroke",function(e){return c(e.id)});var h=t.selectAll(".legend").data(c.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+20*t+")"});h.append("rect").attr("x",n+24).attr("width",18).attr("height",18).style("fill",c),h.append("text").attr("x",n+18).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})})}function c(){$.ajax({url:"/map/data/dengue/tab/summary/determine",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=0,a=[],n=0;e.forEach(function(e){e.values.forEach(function(e){e.count>t&&(t=e.count),e.id=n,a[n]=e,n++})}),t%4!=0&&(t+=4-t%4);var r=[],o=[];e.length>0&&e[0].values.forEach(function(e){r.push(e.week)}),e.forEach(function(e){o.push(e.id)});var i={top:30,right:20,bottom:80,left:50},s=600-i.left-i.right,l=Math.floor(s/27),c=l*e.length,u=5*l,d=["#f0eef5","#c5cde0","#7fa8cb","#3c759d","#235989"],p=d3.select("#summary-chart-case-determine").append("svg").attr("width",s+i.left+i.right).attr("height",c+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"),g=(p.selectAll(".cityLabel").data(o).enter().append("text").text(function(e){return e}).attr("x",0).attr("y",function(e,t){return t*l}).style("text-anchor","end").attr("transform","translate(-6,"+l/1.5+")").attr("class",function(e,t){return t>=0&&t<=4?"cityLabel mono axis axis-workweek":"cityLabel mono axis"}),p.selectAll(".weekLabel").data(r).enter().append("text").text(function(e){return e}).attr("x",function(e,t){return t*l}).attr("y",0).style("text-anchor","middle").attr("transform","translate("+l/2+", -6)").attr("class",function(e,t){return t>=7&&t<=16?"weekLabel mono axis axis-worktime":"weekLabel mono axis"}),d3.scaleLinear().domain([0,t/4,2*t/4,3*t/4,t]).range(d)),m=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return"地區： <span style='color:lightblue'>"+e.city+"</span><br>週次： <span style='color:lightblue'>"+e.week+"</span><br>病例數： <span style='color:lightblue'>"+e.count+"</span>"}),h=p.selectAll(".count").data(a,function(e){return e.city+":"+e.week});h.append("title"),h.enter().append("rect").attr("x",function(e,t){return r.indexOf(e.week)*l}).attr("y",function(e,t){return o.indexOf(e.city)*l}).attr("class","count bordered").attr("width",l-1).attr("height",l-1).style("fill",function(e,t){return g(e.count)}).on("mouseover",m.show).on("mouseout",m.hide).call(m),h.transition().duration(1e3).style("fill",function(e,t){return g(e.count)}),h.select("title").text(function(e){return e.count}),h.exit().remove();var y=p.selectAll(".legend").data(g.domain().slice()).enter().append("g").attr("class","legend");y.enter().append("g").attr("class","legend"),y.append("rect").attr("x",function(e,t){return u*t}).attr("y",function(e,t){return c+l}).attr("width",u).attr("height",l).style("fill",g),y.append("text").attr("class","mono").text(function(e,a){return 0==a?"0":"≤ "+t*a/4}).attr("x",function(e,t){return u*(t+1)-5}).attr("y",c+3*l),y.exit().remove()})}var u="全國",d={permission_level:1},p=e.createTabControl("摘要報表",G.tabbutton.dengueSummary(),t,"DengueSummary",G.tab.tabClick);r()},G.tab.dengueSummary=function(e,t,a,n){return new G.tab.DengueSummary(e,t,a,n)},G.tab.DengueCase=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=p.queryObjects;$(m).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(m).on("itemAddedOnInit",function(e){}),$(m).on("beforeItemAdd",function(e){}),$(m).on("itemAdded",function(e){}),$(m).on("beforeItemRemove",function(e){}),$(m).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.case_static_time.text=p.timeType+"："+e(p.startTime)+"-"+e(p.endTime),$(m).tagsinput("add",{id:"case_static_time",text:a.case_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="case_static_time",r.case_static_time=$(".label-static span")[n],n++,a.case_static_determine.text="狀態：診斷中+確診個案",a.case_static_determine.query="診斷中+確診個案",$(m).tagsinput("add",{id:"case_static_determine",text:a.case_static_determine.text,type:"barStatic"}),$(".label-static span")[n].id="case_static_determine",r.case_static_determine=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"case_static_time":var i=document.createElement("select"),s=["發病日","診斷日","疾管署收到日"];s.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,i.appendChild(t)}),i.value=p.timeType;var l=!1;$(i).on("change",function(){l=!0});var c=document.createElement("div"),u=document.createElement("input");u.placeholder="起始日期",u.type="text",$(u).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:p.startTime.getFullYear(),month:p.startTime.getMonth(),day:p.startTime.getDate()}}),u.value=t(p.startTime);var d=p.startTime,g=!1;$(u).on("change",function(){g=!0,d=new Date(this.value)});var m=document.createElement("p");m.innerText=" 至 ";var h=document.createElement("input");h.placeholder="結束日期",h.type="text",$(h).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:p.endTime.getFullYear(),month:p.endTime.getMonth(),day:p.endTime.getDate()}}),h.value=t(p.endTime);var y=p.endTime,b=!1;$(h).on("change",function(){b=!0,y=new Date(this.value)}),c.appendChild(i),c.appendChild(document.createElement("p")),c.appendChild(u),c.appendChild(m),c.appendChild(h),swal({text:"選擇區間：",content:c}).then(function(t){if(l||g||b){p.startTime=d,p.endTime=y,p.timeType=i.value,o.text=p.timeType+"："+e(p.startTime)+"-"+e(p.endTime);var a=r.case_static_time,n=$(r.case_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"case_static_determine":var i=document.createElement("select"),s=["診斷中+確診個案","診斷中個案","確診個案"];s.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,i.appendChild(t)}),i.value=o.query;var f;$(i).on("change",function(){f=this.value}),swal({text:"個案診斷狀態：",content:i}).then(function(e){if(e&&f){o.query=f,o.text="狀態："+f;var t=r.case_static_determine,a=$(r.case_static_determine).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(p.startTime),end:e(p.endTime),timeType:p.timeType};p.dataCategory.forEach(function(e,a,n){p.queryObjects[e]&&p.queryObjects[e].query&&(t[e]=p.queryObjects[e].query)}),g.container.col_lineChart.noLocateData.style="margin:5px;display:none;";var a="/map/data/dengue/tab/case/query",n=L.DomUtil.create("div","lmask",d);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){if($(n).remove(),p.dataContent=e,g.container.divTableNoLocate.innerHTML="",g.container.divTableNoLocate.style="display:none",p.dataContent.noLocateData&&p.dataContent.noLocateData.length>0){g.container.col_lineChart.noLocateData.style="margin:5px;",g.container.col_lineChart.noLocateData.text.innerHTML="注意：此搜尋含有未定位的資料 ("+p.dataContent.noLocateData.length.toString()+")     ";var a=L.DomUtil.create("table","",g.container.divTableNoLocate);a.style="margin:5px",a.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-4">地區</th></tr>',a),a.body=L.DomUtil.create("tbody","",a);var r=0;p.dataContent.noLocateData.forEach(function(e){r++;var t=r.toString();G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.REPORT+"</td><td>"+new Date(e.SICK_DATE).toLocaleDateString()+"</td><td>"+e.RESIDENCE_COUNTY_NAME+e.RESIDENCE_TOWN_NAME+e.RESIDENCE_VILLAGE_NAME+"</td>",a.body)})}else g.container.col_lineChart.noLocateData.style="margin:5px;display:none;";G.menu.DengueGraph.refresh("DengueCase",t),s(p.dataContent.week_line),c(p.dataContent.week_hidden),u(x.immigration,p.dataContent.immigration),u(x.city,p.dataContent.city),u(x.age,p.dataContent.age),u(x.gender,p.dataContent.gender),u(x.country,p.dataContent.country),u(x.ns1,p.dataContent.ns1),u(x.illness,p.dataContent.illness),u(x.death,p.dataContent.death)})}function s(e){l(e)}function l(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+u(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-u(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=0;n<e.length;n++)0!=e[n].count&&(a=!1),a&&(e[n].count=null);a=!0;for(var n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==p.hasLineChart&&(d3.select("#TabDengueCase_lineChart svg").remove(),p.hasLineChart=!1),p.hasLineChart=!0;var r=540,o=200,i=d3.select("#TabDengueCase_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var u=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),d=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(u);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(d),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return null==e.count?null:e}).x(function(e){return c(e.id)}).y(function(e){return u(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("個案數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function c(e){for(var t=!0,a=0;a<e.length;a++)0!=e[a].count&&(t=!1),t&&(e[a].count=null);t=!0;for(var a=e.length-1;a>=0;a--)0!=e[a].count&&(t=!1),t&&(e[a].count=null);1==p.hasHiddenChart&&(d3.select("#TabDengueCase_hiddenChart svg").remove(),p.hasHiddenChart=!1),p.hasHiddenChart=!0;var n=e,r=[];Object.keys(e[0]).forEach(function(e){"Week"!=e&&"id"!=e&&r.push(e)});var o=d3.select("#TabDengueCase_hiddenChart").append("svg"),i={top:20,right:20,bottom:30,left:50},s=540-i.left-i.right,l=200-i.top-i.bottom,c=o.append("g").attr("transform","translate("+i.left+","+i.top+")");o.attr("width",s+i.left+i.right),o.attr("height",l+i.top+i.bottom);var a=d3.scaleLinear().range([0,s]),u=d3.scaleLinear().range([l,0]),d=d3.scaleOrdinal(d3.schemeCategory10),g=d3.scaleOrdinal(["#bfbfbf","#235989","#7fa8cb","#c0d5ec"]),m=d3.line().defined(function(e){return e.Value?e:null}).x(function(e){return a(e.Week)}).y(function(e){return u(e.Value)}),h=r.map(function(e){return{id:e,values:n.map(function(t){return{UID:t.id,Week:t.Week,Value:t[e]}})}});a.domain(d3.extent(n,function(e){return e.Week})),u.domain([d3.min(h,function(e){return d3.min(e.values,function(e){return e.Value})}),d3.max(h,function(e){return d3.max(e.values,function(e){return e.Value})})]),d.domain(h.map(function(e){return e.id})),g.domain(h.map(function(e){return e.id})),c.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+l+")").call(d3.axisBottom(a).tickFormat(function(e,t){return e})),c.append("text").attr("fill","#000").attr("x",s/2-45).attr("y",l+20).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),c.append("g").attr("class","axis axis--y").call(d3.axisLeft(u)),c.append("text").attr("x",-30).attr("y",50).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("隱藏期（日）");var y=c.selectAll(".Trend").data(h).enter().append("g").attr("class","Trend").attr("height","300px");y.append("path").attr("class","line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width","1.5px").attr("d",function(e){return m(e.values)}).style("stroke",function(e){return g(e.id)})}function u(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],u=0;u<i.length;u++)c.push(i[u][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var d=[],l=0;l<i.length;l++){for(var g=0,h=0,u=0;u<i[l].length;u++)h+=i[l][u];for(var u=0;u<i[l].length;u++){var y=(i[l][u]/h*100).toFixed(0);if(y>20){var b=n[0][u]+"<br>("+i[l][u]+" / "+y+"%)";d.push({xref:"x",yref:"y",x:g+i[l][u]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}g+=i[l][u]}}s.annotations=d,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_denguecase_",""),v=p.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(m).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o;break;case"ns1":o="NS1快篩："+o;break;case"illness":o="重症："+o;break;case"death":o="死亡："+o}v.display.push(o),$(m).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var d=e.createTabControl("個案統計",G.tabbutton.dengueCase(),t,"DengueCase",G.tab.tabClick),p={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,timeType:"發病日",hasLineChart:!1,hasHiddenChart:!1,dataCategory:["week_line","immigration","city","age","gender","country","ns1","illness","death","case_static_time","case_static_determine"],dataContent:{},queryItems:{immigration:null,city:null,age:null,gender:null,country:null,ns1:null,illness:null,death:null},queryObjects:{case_static_time:{text:"",query:null},case_static_determine:{text:"",query:null},time:{time_type:"",start:"",end:""},immigration:{title:"是否境外移入",order:["本土","境外移入"],item:[],display:[],query:null},city:{title:"居住地區",item:[],display:[],query:null},age:{title:"年齡層",order:["0-14","15-49","50-64","65+"],item:[],display:[],query:null},gender:{title:"性別",order:["女","男"],item:[],display:[],query:null},country:{title:"感染國家",item:[],display:[],query:null},ns1:{title:"NS1快篩陽性",order:["陰性","陽性"],item:[],display:[],query:null},illness:{title:"重症",order:["重症","非重症"],item:[],display:[],query:null},death:{title:"死亡",order:["死亡","非死亡"],item:[],display:[],query:null}}},g=G.ui.create("div","","",d);g.container=G.ui.create("div","container-fluid","",g),g.container.row=G.ui.create("div","row","",g.container),g.container.col_lineChart=G.ui.create("div","col-md-6","",g.container.row),g.container.col_barChart1=G.ui.create("div","col-md-3","",g.container.row),g.container.col_barChart2=G.ui.create("div","col-md-3","",g.container.row),g.container.col_lineChart.searchBar=G.ui.create("div","","",g.container.col_lineChart),g.container.col_lineChart.noLocateData=G.ui.create("div","","",g.container.col_lineChart),g.container.col_lineChart.noLocateData.style="margin:5px;display:none;",g.container.col_lineChart.noLocateData.text=G.ui.create("span","h5","注意：此搜尋含有未定位的資料     ",g.container.col_lineChart.noLocateData),g.container.col_lineChart.noLocateData.button=G.ui.create("button","btn btn-warning btn-xs","檢視未定位資料",g.container.col_lineChart.noLocateData),$(g.container.col_lineChart.noLocateData.button).on("click",function(){$(g.container.divTableNoLocate).toggle()}),g.container.divTableNoLocate=G.ui.create("div","","",g.container.col_lineChart.noLocateData);var m=G.ui.create("input","","",g.container.col_lineChart.searchBar);m.type="text",m["data-role"]="tagsinput";var h=G.ui.create("button","btn btn-primary btn-xs","更新",g.container.col_lineChart.searchBar);h.type="submit",$(h).on("click",function(){i()});var y='<div class="barChart"><p class="barChart barChartTitle"> 個案數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',b=G.ui.create("div","col",y,g.container.col_lineChart);b.id="TabDengueCase_lineChart",b.tooltip=G.ui.create("div","","",b),b.tooltip.id="TabDengueCase_lineChart_tooltip",b.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var f='<div class="barChart"><p class="barChart barChartTitle"> 週平均隱藏期統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',v=G.ui.create("div","col",f,g.container.col_lineChart);v.id="TabDengueCase_hiddenChart";var C=["immigration","age","ns1","country"],D=["city","gender","illness","death"],x={};C.forEach(function(e){var t='<p class="barChartTitle"> '+p.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,g.container.col_barChart1);x[e]=G.ui.create("div","","",a),x[e].id="barChart_denguecase_"+e,x[e].style="min-width: 240px; width: 240px; height: 60px;"}),D.forEach(function(e){var t='<p class="barChartTitle"> '+p.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,g.container.col_barChart2);x[e]=G.ui.create("div","","",a),x[e].id="barChart_denguecase_"+e,x[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.dengueCase=function(e,t,a,n){return new G.tab.DengueCase(e,t,a,n)},G.tab.DengueCluster=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=d.queryObjects;$(g).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(g).on("itemAddedOnInit",function(e){}),$(g).on("beforeItemAdd",function(e){}),$(g).on("itemAdded",function(e){}),$(g).on("beforeItemRemove",function(e){}),$(g).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.cluster_static_time.text="首例發病日："+e(d.startTime)+"-"+e(d.endTime),$(g).tagsinput("add",{id:"cluster_static_time",text:a.cluster_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="cluster_static_time",r.cluster_static_time=$(".label-static span")[n],n++,a.cluster_static_determine.text="狀態：所有個案",a.cluster_static_determine.query="所有個案",$(g).tagsinput("add",{id:"cluster_static_determine",text:a.cluster_static_determine.text,type:"barStatic"}),$(".label-static span")[n].id="cluster_static_determine",r.cluster_static_determine=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"cluster_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.startTime.getFullYear(),month:d.startTime.getMonth(),day:d.startTime.getDate()}}),s.value=t(d.startTime);var l=d.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var u=document.createElement("p");u.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.endTime.getFullYear(),month:d.endTime.getMonth(),day:d.endTime.getDate()}}),p.value=t(d.endTime);var g=d.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(u),i.appendChild(p),swal({text:"首例發病：",content:i}).then(function(t){if(c||m){d.startTime=l,d.endTime=g,o.text="首例發病："+e(d.startTime)+"-"+e(d.endTime);var a=r.cluster_static_time,n=$(r.cluster_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"cluster_static_determine":var h=document.createElement("select"),y=["所有個案","診斷中個案","確診個案"];y.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,h.appendChild(t)}),h.value=o.query;var b;$(h).on("change",function(){b=this.value}),swal({text:"個案診斷狀態：",content:h}).then(function(e){if(e&&b){o.query=b,o.text="狀態："+b;var t=r.cluster_static_determine,a=$(r.cluster_static_determine).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(d.startTime),end:e(d.endTime)};d.dataCategory.forEach(function(e,a,n){d.queryObjects[e]&&d.queryObjects[e].query&&(t[e]=d.queryObjects[e].query)});var a="/map/data/dengue/tab/cluster/query",n=L.DomUtil.create("div","lmask",u);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){$(n).remove(),d.dataContent=e,G.menu.DengueGraph.refresh("DengueCluster",t),s(d.dataContent.week_line),l(d.dataContent.week_line_people),c(D.closed,d.dataContent.closed),c(D.city,d.dataContent.city),c(D.case_count,d.dataContent.case_count),c(D.remain,d.dataContent.remain)})}function s(e){for(var t=!0,a=e.length-1;a>=0;a--)0!=e[a].count&&(t=!1),t&&(e[a].count=null);1==d.hasLineChart&&(d3.select("#TabDengueCluster_lineChart svg").remove(),d.hasLineChart=!1),d.hasLineChart=!0;var n=($(document).width()-200)/2;n=n>540?n:540;var r=200,o=d3.select("#TabDengueCluster_lineChart").append("svg").attr("width",n+"px").attr("height",r+"px"),i={top:20,right:20,bottom:30,left:50},s=Math.max.apply(Math,e.map(function(e){return e.count})),l=d3.scaleBand().rangeRound([0,n-i.left-i.right]).domain(e.map(function(e){return e.id})),c=d3.scaleLinear().domain([0,s]).range([r-i.top-i.bottom,0]),u=d3.axisBottom(l).tickFormat(function(t,a){return 1!=e[a].week&&e[a].week%5?"":e[a].week}),p=d3.axisLeft().scale(c);o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+(r-i.bottom)+")").call(u),o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+i.top+")").call(p);var g=d3.line().defined(function(e){return e.count||0==e.count?e:null}).x(function(e){return l(e.id)}).y(function(e){return c(e.count)}).curve(d3.curveCardinal.tension(1));o.append("g").append("path").attr("class","line-path").attr("transform","translate("+i.left+","+i.top+")").attr("d",g(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),o.append("text").attr("fill","#000").attr("x",n/2-30).attr("y",r-10).attr("dy","0.71em").attr("font-size",12).text("群聚首例發病時間（週）"),o.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("群聚數")}function l(e){for(var t=!0,a=e.length-1;a>=0;a--)0!=e[a].count&&(t=!1),t&&(e[a].count=null);1==d.hasLineChartPeople&&(d3.select("#TabDengueCluster_lineChart_people svg").remove(),d.hasLineChartPeople=!1),d.hasLineChartPeople=!0;var n=($(document).width()-200)/2;n=n>540?n:540;var r=200,o=d3.select("#TabDengueCluster_lineChart_people").append("svg").attr("width",n+"px").attr("height",r+"px"),i={top:20,right:20,bottom:30,left:50},s=Math.max.apply(Math,e.map(function(e){return e.count})),l=d3.scaleBand().rangeRound([0,n-i.left-i.right]).domain(e.map(function(e){return e.id})),c=d3.scaleLinear().domain([0,s]).range([r-i.top-i.bottom,0]),u=d3.axisBottom(l).tickFormat(function(t,a){return 1!=e[a].week&&e[a].week%5?"":e[a].week}),p=d3.axisLeft().scale(c);o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+(r-i.bottom)+")").call(u),o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+i.top+")").call(p);var g=d3.line().defined(function(e){return e.count||0==e.count?e:null}).x(function(e){return l(e.id)}).y(function(e){return c(e.count)}).curve(d3.curveCardinal.tension(1));o.append("g").append("path").attr("class","line-path").attr("transform","translate("+i.left+","+i.top+")").attr("d",g(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),o.append("text").attr("fill","#000").attr("x",n/2-30).attr("y",r-10).attr("dy","0.71em").attr("font-size",12).text("群聚首例發病時間（週）"),o.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("人數")}function c(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],u=0;u<i.length;u++)c.push(i[u][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var p=[],l=0;l<i.length;l++){for(var m=0,h=0,u=0;u<i[l].length;u++)h+=i[l][u];for(var u=0;u<i[l].length;u++){var y=(i[l][u]/h*100).toFixed(0);if(y>20){var b=n[0][u]+"<br>("+i[l][u]+" / "+y+"%)";p.push({xref:"x",yref:"y",x:m+i[l][u]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][u]}}s.annotations=p,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_denguecluster_",""),v=d.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(g).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"closed":o="結案狀態："+o;break;case"city":o="群聚地區："+o;break;case"case_count":o="群聚規模："+o;break;case"remain":o="群聚持續時間："+o}v.display.push(o),$(g).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var u=(a.mainMap,a.tileLayers,n.tile,e.createTabControl("群聚",G.tabbutton.dengueCluster(),t,"DengueCluster",G.tab.tabClick)),d={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,timeType:"發病日",hasLineChart:!1,hasLineChartPeople:!1,dataCategory:["week_line","week_line_people","closed","city","case_count","remain","cluster_static_time","cluster_static_determine"],dataContent:{},queryItems:{closed:null,city:null,case_count:null,remain:null},queryObjects:{cluster_static_time:{text:"",query:null},cluster_static_determine:{text:"",query:null},time:{time_type:"",start:"",end:""},closed:{title:"結案狀態",order:["未結案","已結案"],item:[],display:[],query:null},city:{title:"群聚地區",item:[],display:[],query:null},case_count:{title:"群聚規模",order:["2人","3-5人","6-10人","11人以上"],item:[],display:[],query:null},remain:{title:"群聚持續時間",order:["1-2週","3-4週","5-8週","9週以上"],item:[],display:[],query:null}}},p=G.ui.create("div","","",u);p.id="DengueCluster_app",p.container=G.ui.create("div","container-fluid","",p),p.container.row=G.ui.create("div","row","",p.container),p.container.col_lineChart=G.ui.create("div","col-md-6","",p.container.row),p.container.col_barChart1=G.ui.create("div","col-md-3","",p.container.row),p.container.col_barChart2=G.ui.create("div","col-md-3","",p.container.row),p.container.col_lineChart.searchBar=G.ui.create("div","","",p.container.col_lineChart);var g=G.ui.create("input","","",p.container.col_lineChart.searchBar);g.type="text",g["data-role"]="tagsinput";var m=G.ui.create("button","btn btn-primary btn-xs","更新",p.container.col_lineChart.searchBar);m.type="submit",$(m).on("click",function(){i()});var h='<div class="barChart"><p class="barChart barChartTitle"> 群聚群數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',y=G.ui.create("div","col",h,p.container.col_lineChart);y.id="TabDengueCluster_lineChart";var b='<div class="barChart"><p class="barChart barChartTitle"> 群聚人數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',f=G.ui.create("div","col",b,p.container.col_lineChart);f.id="TabDengueCluster_lineChart_people";var v=["closed","case_count"],C=["city","remain"],D={};v.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart1);D[e]=G.ui.create("div","","",a),D[e].id="barChart_denguecluster_"+e,D[e].style="min-width: 240px; width: 240px; height: 60px;"}),C.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart2);
D[e]=G.ui.create("div","","",a),D[e].id="barChart_denguecluster_"+e,D[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.dengueCluster=function(e,t,a,n){return new G.tab.DengueCluster(e,t,a,n)},G.tab.DenguePest=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=d.queryObjects;$(g).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(g).on("itemAddedOnInit",function(e){}),$(g).on("beforeItemAdd",function(e){}),$(g).on("itemAdded",function(e){}),$(g).on("beforeItemRemove",function(e){}),$(g).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.pest_static_time.text="調查期間："+e(d.startTime)+"-"+e(d.endTime),$(g).tagsinput("add",{id:"pest_static_time",text:a.pest_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="pest_static_time",r.pest_static_time=$(".label-static span")[n],n++,a.pest_static_check.text="調查結果：最近一次調查結果",a.pest_static_check.query="最近一次調查結果",$(g).tagsinput("add",{id:"pest_static_check",text:a.pest_static_check.text,type:"barStatic"}),$(".label-static span")[n].id="pest_static_check",r.pest_static_check=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"pest_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.startTime.getFullYear(),month:d.startTime.getMonth(),day:d.startTime.getDate()}}),s.value=t(d.startTime);var l=d.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var u=document.createElement("p");u.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.endTime.getFullYear(),month:d.endTime.getMonth(),day:d.endTime.getDate()}}),p.value=t(d.endTime);var g=d.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(u),i.appendChild(p),swal({text:"調查期間：",content:i}).then(function(t){if(c||m){d.startTime=l,d.endTime=g,o.text="調查期間："+e(d.startTime)+"-"+e(d.endTime);var a=r.pest_static_time,n=$(r.pest_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"pest_static_check":var h=document.createElement("select"),y=["最近一次調查結果","平均調查結果"];y.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,h.appendChild(t)}),h.value=o.query;var b;$(h).on("change",function(){b=this.value}),swal({text:"病媒指數調查結果：",content:h}).then(function(e){if(e&&b){o.query=b,o.text="調查結果："+b;var t=r.pest_static_check,a=$(r.pest_static_check).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(d.startTime),end:e(d.endTime)};d.dataCategory.forEach(function(e,a,n){d.queryObjects[e]&&d.queryObjects[e].query&&(t[e]=d.queryObjects[e].query)});var a="/map/data/dengue/tab/pest/query",n=L.DomUtil.create("div","lmask",u);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){$(n).remove(),d.dataContent=e,G.geo.tile.datajsons.objVillages=e.objVillages,G.menu.DengueGraph.refresh("DenguePest",t),s(d.dataContent.week_line),l(d.dataContent.week_bucket,d.dataContent.week_bucket_egg),c(D.bi,d.dataContent.bi),c(D.check_mosquito,d.dataContent.check_mosquito),c(D.bucket_positive,d.dataContent.bucket_positive),c(D.bucket_egg,d.dataContent.bucket_egg),c(D.check_bucket,d.dataContent.check_bucket),c(D.city,d.dataContent.city)})}function s(e){for(var t=!0,a=0;a<e.length;a++)0!=e[a].count&&(t=!1),t&&(e[a].count=null);t=!0;for(var a=e.length-1;a>=0;a--)0!=e[a].count&&(t=!1),t&&(e[a].count=null);1==d.hasLineChart&&(d3.select("#TabDenguePest_lineChart svg").remove(),d.hasLineChart=!1),d.hasLineChart=!0;var n=($(document).width()-200)/2;n=n>540?n:540;var r=200,o=d3.select("#TabDenguePest_lineChart").append("svg").attr("width",n+"px").attr("height",r+"px"),i={top:20,right:20,bottom:30,left:50},s=Math.max.apply(Math,e.map(function(e){return e.count})),l=d3.scaleBand().rangeRound([0,n-i.left-i.right]).domain(e.map(function(e){return e.id})),c=d3.scaleLinear().domain([0,s]).range([r-i.top-i.bottom,0]),u=d3.axisBottom(l).tickFormat(function(t,a){return 1!=e[a].week&&e[a].week%5?"":e[a].week}),p=d3.axisLeft().scale(c);o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+(r-i.bottom)+")").call(u),o.append("g").attr("class","axis").attr("transform","translate("+i.left+","+i.top+")").call(p);var g=d3.line().defined(function(e){return e.count||0==e.count?e:null}).x(function(e){return l(e.id)}).y(function(e){return c(e.count)}).curve(d3.curveCardinal.tension(1));o.append("g").append("path").attr("class","line-path").attr("transform","translate("+i.left+","+i.top+")").attr("d",g(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),o.append("text").attr("fill","#000").attr("x",n/2-30).attr("y",r-10).attr("dy","0.71em").attr("font-size",12).text("調查週"),o.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("比率（%）")}function l(e,t){for(var a=!0,n=0;n<e.length;n++)0!=e[n].count&&(a=!1),a&&(e[n].count=null);a=!0;for(var n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);a=!0;for(var n=0;n<t.length;n++)0!=t[n].count&&(a=!1),a&&(t[n].count=null);a=!0;for(var n=t.length-1;n>=0;n--)0!=t[n].count&&(a=!1),a&&(t[n].count=null);1==d.hasBucketChart&&(d3.select("#TabDenguePest_bucketChart svg").remove(),d.hasBucketChart=!1),d.hasBucketChart=!0;var r=($(document).width()-200)/2;r=r>540?r:540;var o=200,i=d3.select("#TabDenguePest_bucketChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:50,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=Math.max.apply(Math,t.map(function(e){return e.count})),u=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id})),p=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),g=d3.scaleLinear().domain([0,c]).range([o-s.top-s.bottom,0]),m=d3.axisBottom(u).tickFormat(function(t,a){return 1!=e[a].week&&e[a].week%5?"":e[a].week}),h=d3.axisLeft().scale(p),y=d3.axisRight().scale(g);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(m),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(h),i.append("g").attr("class","axis").attr("transform","translate("+(r-s.right)+","+s.top+")").call(y);var b=i.selectAll("rect").data(t).enter().append("g");b.append("rect").attr("x",function(e){return u(e.id)+s.left-u.bandwidth()/2+1}).attr("y",function(e){return g(e.count)+s.top}).attr("width",u.bandwidth()-2>0?u.bandwidth()-2:1).attr("height",function(e){return o-s.top-s.bottom-g(e.count)}).attr("class",function(e){return"area"});var f=d3.line().defined(function(e){return e.count||0==e.count?e:null}).x(function(e){return u(e.id)}).y(function(e){return p(e.count)}).curve(d3.curveCardinal.tension(1));i.data(e).append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",f(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#ffb802"),i.selectAll("dot").data(e).enter().append("circle").attr("r",3).attr("cx",function(e){return e.count||0==e.count?u(e.id)+s.left:-1e4}).attr("cy",function(e){return e.count||0==e.count?p(e.count)+s.top:-1e3}),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("調查週"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("平均陽性率（%）"),i.append("text").attr("x",r-12).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("總卵數（粒）")}function c(e,t){if(t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],u=0;u<i.length;u++)c.push(i[u][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var p=[],l=0;l<i.length;l++){for(var m=0,h=0,u=0;u<i[l].length;u++)h+=i[l][u];for(var u=0;u<i[l].length;u++){var y=(i[l][u]/h*100).toFixed(0);if(y>20){var b=n[0][u]+"<br>("+i[l][u]+" / "+y+"%)";p.push({xref:"x",yref:"y",x:m+i[l][u]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][u]}}s.annotations=p,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_denguepest_",""),v=d.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(g).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"bi":o="布氏指數級數："+o;break;case"check_mosquito":o="有無病媒調查："+o;break;case"bucket_positive":o="誘卵桶陽性率："+o;break;case"bucket_egg":o="誘卵桶卵數："+o;break;case"check_bucket":o="有無誘卵桶調查："+o;break;case"city":o="調查地區："+o}v.display.push(o),$(g).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}}var u=(a.mainMap,a.tileLayers,n.tile,e.createTabControl("病媒",G.tabbutton.denguePest(),t,"DenguePest",G.tab.tabClick)),d={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,hasLineChart:!1,hasBucketChart:!1,dataCategory:["week_line","week_bucket","week_bucket_egg","bi","check_mosquito","bucket_positive","bucket_egg","check_bucket","city","pest_static_time","pest_static_check"],dataContent:{},queryItems:{bi:null,check_mosquito:null,bucket_positive:null,bucket_egg:null,check_bucket:null,city:null},queryObjects:{pest_static_time:{text:"",query:null},pest_static_check:{text:"",query:null},time:{time_type:"",start:"",end:""},bi:{title:"布氏指數級數（村里別）",order:["未調查","0級","1級","2級","3級","4級","5級","6級","7級","8級","9級"],item:[],display:[],query:null},check_mosquito:{title:"有無病媒資料",order:["有調查里別","無調查里別"],item:[],display:[],query:null},bucket_positive:{title:"誘卵桶陽性率（村里別）",order:["未調查","< 30%","30-59%",">= 60%"],item:[],display:[],query:null},bucket_egg:{title:"誘卵桶卵數（村里別）",order:["未調查","< 250粒","250-499粒","500粒以上"],item:[],display:[],query:null},check_bucket:{title:"有無誘卵桶資料",order:["有調查里別","無調查里別"],item:[],display:[],query:null},city:{title:"調查地區",item:[],display:[],query:null}}},p=G.ui.create("div","","",u);p.id="DenguePest_app",p.container=G.ui.create("div","container-fluid","",p),p.container.row=G.ui.create("div","row","",p.container),p.container.col_lineChart=G.ui.create("div","col-md-6","",p.container.row),p.container.col_barChart1=G.ui.create("div","col-md-3","",p.container.row),p.container.col_barChart2=G.ui.create("div","col-md-3","",p.container.row),p.container.col_lineChart.searchBar=G.ui.create("div","","",p.container.col_lineChart);var g=G.ui.create("input","","",p.container.col_lineChart.searchBar);g.type="text",g["data-role"]="tagsinput";var m=G.ui.create("button","btn btn-primary btn-xs","更新",p.container.col_lineChart.searchBar);m.type="submit",$(m).on("click",function(){i()});var h='<div class="barChart"><p class="barChart barChartTitle"> 布氏指數三級以上村里比率統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',y=G.ui.create("div","col",h,p.container.col_lineChart);y.id="TabDenguePest_lineChart";var b='<div class="barChart"><p class="barChart barChartTitle"> 誘卵桶村里別卵數/陽性率統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',f=G.ui.create("div","col",b,p.container.col_lineChart);f.id="TabDenguePest_bucketChart";var v=["bi","bucket_positive","check_bucket"],C=["check_mosquito","bucket_egg","city"],D={};v.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart1);D[e]=G.ui.create("div","","",a),D[e].id="barChart_denguepest_"+e,D[e].style="min-width: 270px; width: 270px; height: 60px;"}),C.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart2);D[e]=G.ui.create("div","","",a),D[e].id="barChart_denguepest_"+e,D[e].style="min-width: 270px; width: 270px; height: 60px;"}),r(),i()},G.tab.denguePest=function(e,t,a,n){return new G.tab.DenguePest(e,t,a,n)},G.tab.DenguePrevent=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=u.queryObjects;$(p).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(p).on("itemAddedOnInit",function(e){}),$(p).on("beforeItemAdd",function(e){}),$(p).on("itemAdded",function(e){}),$(p).on("beforeItemRemove",function(e){}),$(p).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.prevent_static_time.text="防治："+e(u.startTime)+"-"+e(u.endTime),$(p).tagsinput("add",{id:"prevent_static_time",text:a.prevent_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="prevent_static_time",r.prevent_static_time=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"prevent_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.startTime.getFullYear(),month:u.startTime.getMonth(),day:u.startTime.getDate()}}),s.value=t(u.startTime);var l=u.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var d=document.createElement("p");d.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.endTime.getFullYear(),month:u.endTime.getMonth(),day:u.endTime.getDate()}}),p.value=t(u.endTime);var g=u.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(d),i.appendChild(p),swal({text:"發病：",content:i}).then(function(t){if(c||m){u.startTime=l,u.endTime=g,o.text="發病："+e(u.startTime)+"-"+e(u.endTime);var a=r.prevent_static_time,n=$(r.prevent_static_time).parent()[0];n.innerText=o.text,n.append(a)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(u.startTime),end:e(u.endTime)};u.dataCategory.forEach(function(e,a,n){u.queryObjects[e]&&u.queryObjects[e].query&&(t[e]=u.queryObjects[e].query)});var a="/map/data/dengue/tab/prevent/query",n=L.DomUtil.create("div","lmask",c);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){$(n).remove(),u.dataContent=e,G.menu.DengueGraph.refresh("DenguePrevent",t),s(u.dataContent.week_line),l(f.execute,u.dataContent.execute),l(f.city,u.dataContent.city)})}function s(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+d(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-d(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=0;n<e.length;n++)0!=e[n].count&&(a=!1),a&&(e[n].count=null);a=!0;for(var n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==u.hasLineChart&&(d3.select("#TabDenguePrevent_lineChart svg").remove(),u.hasLineChart=!1),u.hasLineChart=!0;var r=540,o=200,i=d3.select("#TabDenguePrevent_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var d=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),p=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(d);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(p),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return null==e.count?null:e}).x(function(e){return c(e.id)}).y(function(e){return d(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("防治時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("防治次數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function l(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],d=0;d<i.length;d++)c.push(i[d][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var g=[],l=0;l<i.length;l++){for(var m=0,h=0,d=0;d<i[l].length;d++)h+=i[l][d];for(var d=0;d<i[l].length;d++){var y=(i[l][d]/h*100).toFixed(0);if(y>20){var b=n[0][d]+"<br>("+i[l][d]+" / "+y+"%)";g.push({xref:"x",yref:"y",x:m+i[l][d]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][d]}}s.annotations=g,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_denguecase_",""),v=u.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(p).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o;break;case"ns1":o="NS1快篩："+o;break;case"illness":o="重症："+o;break;case"death":o="死亡："+o}v.display.push(o),$(p).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var c=e.createTabControl("個案統計",G.tabbutton.denguePrevent(),t,"DenguePrevent",G.tab.tabClick),u={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,hasLineChart:!1,dataCategory:["week_line","execute","city","prevent_static_time"],dataContent:{},queryItems:{execute:null,city:null},queryObjects:{prevent_static_time:{text:"",query:null},time:{time_type:"",start:"",end:""},execute:{title:"防治時間",order:["14日內執行","15日以上執行"],item:[],display:[],query:null},city:{title:"化學防治地區",item:[],display:[],query:null}}},d=G.ui.create("div","","",c);d.container=G.ui.create("div","container-fluid","",d),d.container.row=G.ui.create("div","row","",d.container),d.container.col_lineChart=G.ui.create("div","col-md-6","",d.container.row),d.container.col_barChart1=G.ui.create("div","col-md-3","",d.container.row),d.container.col_barChart2=G.ui.create("div","col-md-3","",d.container.row),d.container.col_lineChart.searchBar=G.ui.create("div","","",d.container.col_lineChart);var p=G.ui.create("input","","",d.container.col_lineChart.searchBar);p.type="text",p["data-role"]="tagsinput";var g=G.ui.create("button","btn btn-primary btn-xs","更新",d.container.col_lineChart.searchBar);g.type="submit",$(g).on("click",function(){i()});var m='<div class="barChart"><p class="barChart barChartTitle"> 防治統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',h=G.ui.create("div","col",m,d.container.col_lineChart);h.id="TabDenguePrevent_lineChart",h.tooltip=G.ui.create("div","","",h),h.tooltip.id="TabDenguePrevent_lineChart_tooltip",h.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var y=["execute"],b=["city"],f={};y.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart1);f[e]=G.ui.create("div","","",a),f[e].id=e,f[e].style="min-width: 240px; width: 240px; height: 60px;"}),b.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart2);f[e]=G.ui.create("div","","",a),f[e].id=e,f[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.denguePrevent=function(e,t,a,n){return new G.tab.DenguePrevent(e,t,a,n)},G.tab.DengueMedical=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=p.queryObjects;$(m).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(m).on("itemAddedOnInit",function(e){}),$(m).on("beforeItemAdd",function(e){}),$(m).on("itemAdded",function(e){}),$(m).on("beforeItemRemove",function(e){}),$(m).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.medical_static_time.text=p.timeType+"："+e(p.startTime)+"-"+e(p.endTime),$(m).tagsinput("add",{id:"medical_static_time",text:a.medical_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="medical_static_time",r.medical_static_time=$(".label-static span")[n],n++,a.medical_static_determine.text="診斷：診斷中+確診個案",a.medical_static_determine.query="診斷中+確診個案",$(m).tagsinput("add",{id:"medical_static_determine",text:a.medical_static_determine.text,type:"barStatic"}),$(".label-static span")[n].id="medical_static_determine",r.medical_static_determine=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"medical_static_time":var i=document.createElement("select"),s=["發病日","診斷日","疾管署收到日"];s.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,i.appendChild(t)}),i.value=p.timeType;var l=!1;$(i).on("change",function(){l=!0});var c=document.createElement("div"),u=document.createElement("input");u.placeholder="起始日期",u.type="text",$(u).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:p.startTime.getFullYear(),month:p.startTime.getMonth(),day:p.startTime.getDate()}}),u.value=t(p.startTime);var d=p.startTime,g=!1;$(u).on("change",function(){g=!0,d=new Date(this.value)});var m=document.createElement("p");m.innerText=" 至 ";var h=document.createElement("input");h.placeholder="結束日期",h.type="text",$(h).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:p.endTime.getFullYear(),month:p.endTime.getMonth(),day:p.endTime.getDate()}}),h.value=t(p.endTime);var y=p.endTime,b=!1;$(h).on("change",function(){b=!0,y=new Date(this.value)}),c.appendChild(i),c.appendChild(document.createElement("p")),c.appendChild(u),c.appendChild(m),c.appendChild(h),swal({text:"選擇區間：",content:c}).then(function(t){if(l||g||b){p.startTime=d,p.endTime=y,p.timeType=i.value,o.text=p.timeType+"："+e(p.startTime)+"-"+e(p.endTime);var a=r.medical_static_time,n=$(r.medical_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"medical_static_determine":var i=document.createElement("select"),s=["診斷中+確診個案","診斷中個案","確診個案"];s.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,i.appendChild(t)}),i.value=o.query;var f;$(i).on("change",function(){f=this.value}),swal({text:"個案診斷狀態：",content:i}).then(function(e){if(e&&f){o.query=f,o.text="診斷："+f;var t=r.medical_static_determine,a=$(r.medical_static_determine).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(p.startTime),end:e(p.endTime),timeType:p.timeType};p.dataCategory.forEach(function(e,a,n){p.queryObjects[e]&&p.queryObjects[e].query&&(t[e]=p.queryObjects[e].query)}),g.container.col_lineChart.noLocateData.style="margin:5px;display:none;";var a="/map/data/dengue/tab/medical/query",n=L.DomUtil.create("div","lmask",d);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){if($(n).remove(),p.dataContent=e,g.container.divTableNoLocate.innerHTML="",g.container.divTableNoLocate.style="display:none",p.dataContent.noLocateData&&p.dataContent.noLocateData.length>0){g.container.col_lineChart.noLocateData.style="margin:5px;",g.container.col_lineChart.noLocateData.text.innerHTML="注意：此搜尋含有未定位的資料 ("+p.dataContent.noLocateData.length.toString()+")     ";var a=L.DomUtil.create("table","",g.container.divTableNoLocate);a.style="margin:5px",a.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-4">醫療院所名稱</th><th scope="col-md-4">地區</th></tr>',a),a.body=L.DomUtil.create("tbody","",a);var r=0;p.dataContent.noLocateData.forEach(function(e){r++;var t=r.toString();G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.ID+"</td><td>"+e.NAME+"</td><td>"+e.COUNTY_NAME+e.TOWN_NAME+"</td>",a.body)})}else g.container.col_lineChart.noLocateData.style="margin:5px;display:none;";G.menu.DengueGraph.refresh("DengueMedical",t),s(p.dataContent.week_line),c(p.dataContent.week_hidden),u(x.city,p.dataContent.city),u(x.ns1,p.dataContent.ns1),u(x.category,p.dataContent.category),u(x.hidden,p.dataContent.hidden)})}function s(e){l(e)}function l(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+u(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-u(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=0;n<e.length;n++)0!=e[n].count&&(a=!1),a&&(e[n].count=null);a=!0;for(var n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==p.hasLineChart&&(d3.select("#TabDengueMedical_lineChart svg").remove(),p.hasLineChart=!1),p.hasLineChart=!0;var r=540,o=200,i=d3.select("#TabDengueMedical_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var u=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),d=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(u);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(d),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return null==e.count?null:e}).x(function(e){return c(e.id)}).y(function(e){return u(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("個案數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){
y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function c(e){for(var t=!0,a=0;a<e.length;a++)0!=e[a].count&&(t=!1),t&&(e[a].count=null);t=!0;for(var a=e.length-1;a>=0;a--)0!=e[a].count&&(t=!1),t&&(e[a].count=null);1==p.hasHiddenChart&&(d3.select("#TabDengueMedical_hiddenChart svg").remove(),p.hasHiddenChart=!1),p.hasHiddenChart=!0;var n=e,r=[];Object.keys(e[0]).forEach(function(e){"Week"!=e&&"id"!=e&&r.push(e)});var o=d3.select("#TabDengueMedical_hiddenChart").append("svg"),i={top:20,right:20,bottom:30,left:50},s=540-i.left-i.right,l=200-i.top-i.bottom,c=o.append("g").attr("transform","translate("+i.left+","+i.top+")");o.attr("width",s+i.left+i.right),o.attr("height",l+i.top+i.bottom);var a=d3.scaleLinear().range([0,s]),u=d3.scaleLinear().range([l,0]),d=d3.scaleOrdinal(d3.schemeCategory10),g=d3.scaleOrdinal(["#bfbfbf","#235989","#7fa8cb","#c0d5ec"]),m=d3.line().defined(function(e){return e.Value?e:null}).x(function(e){return a(e.Week)}).y(function(e){return u(e.Value)}),h=r.map(function(e){return{id:e,values:n.map(function(t){return{UID:t.id,Week:t.Week,Value:t[e]}})}});a.domain(d3.extent(n,function(e){return e.Week})),u.domain([d3.min(h,function(e){return d3.min(e.values,function(e){return e.Value})}),d3.max(h,function(e){return d3.max(e.values,function(e){return e.Value})})]),d.domain(h.map(function(e){return e.id})),g.domain(h.map(function(e){return e.id})),c.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+l+")").call(d3.axisBottom(a).tickFormat(function(e,t){return e})),c.append("text").attr("fill","#000").attr("x",s/2-45).attr("y",l+20).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),c.append("g").attr("class","axis axis--y").call(d3.axisLeft(u)),c.append("text").attr("x",-30).attr("y",50).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("隱藏期（日）");var y=c.selectAll(".Trend").data(h).enter().append("g").attr("class","Trend").attr("height","300px");y.append("path").attr("class","line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width","1.5px").attr("d",function(e){return m(e.values)}).style("stroke",function(e){return g(e.id)})}function u(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],u=0;u<i.length;u++)c.push(i[u][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var d=[],l=0;l<i.length;l++){for(var g=0,h=0,u=0;u<i[l].length;u++)h+=i[l][u];for(var u=0;u<i[l].length;u++){var y=(i[l][u]/h*100).toFixed(0);if(y>20){var b=n[0][u]+"<br>("+i[l][u]+" / "+y+"%)";d.push({xref:"x",yref:"y",x:g+i[l][u]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}g+=i[l][u]}}s.annotations=d,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_denguemedical_",""),v=p.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(m).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o;break;case"ns1":o="NS1快篩："+o;break;case"illness":o="重症："+o;break;case"death":o="死亡："+o}v.display.push(o),$(m).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var d=e.createTabControl("個案統計",G.tabbutton.dengueMedical(),t,"DengueMedical",G.tab.tabClick),p={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,timeType:"發病日",hasLineChart:!1,hasHiddenChart:!1,dataCategory:["week_line","city","category","ns1","hidden","medical_static_time","medical_static_determine"],dataContent:{},queryItems:{city:null,category:null,ns1:null,hidden:null},queryObjects:{medical_static_time:{text:"",query:null},medical_static_determine:{text:"",query:null},time:{time_type:"",start:"",end:""},city:{title:"醫療機構所在地區",item:[],display:[],query:null},category:{title:"健保特約類別",order:["醫學中心","區域醫院","地區醫院","診所","藥局","居家護理","康復之家","助產所","檢驗所","物理治療所","特約醫事放射機構","不詳"],item:[],display:[],query:null},ns1:{title:"提供快篩醫療機構",order:["是","否"],item:[],display:[],query:null},hidden:{title:"平均隱藏期",order:["<= 3","> 3"],item:[],display:[],query:null}}},g=G.ui.create("div","","",d);g.container=G.ui.create("div","container-fluid","",g),g.container.row=G.ui.create("div","row","",g.container),g.container.col_lineChart=G.ui.create("div","col-md-6","",g.container.row),g.container.col_barChart1=G.ui.create("div","col-md-3","",g.container.row),g.container.col_barChart2=G.ui.create("div","col-md-3","",g.container.row),g.container.col_lineChart.searchBar=G.ui.create("div","","",g.container.col_lineChart),g.container.col_lineChart.noLocateData=G.ui.create("div","","",g.container.col_lineChart),g.container.col_lineChart.noLocateData.style="margin:5px;display:none;",g.container.col_lineChart.noLocateData.text=G.ui.create("span","h5","注意：此搜尋含有未定位的資料     ",g.container.col_lineChart.noLocateData),g.container.col_lineChart.noLocateData.button=G.ui.create("button","btn btn-warning btn-xs","檢視未定位資料",g.container.col_lineChart.noLocateData),$(g.container.col_lineChart.noLocateData.button).on("click",function(){$(g.container.divTableNoLocate).toggle()}),g.container.divTableNoLocate=G.ui.create("div","","",g.container.col_lineChart.noLocateData);var m=G.ui.create("input","","",g.container.col_lineChart.searchBar);m.type="text",m["data-role"]="tagsinput";var h=G.ui.create("button","btn btn-primary btn-xs","更新",g.container.col_lineChart.searchBar);h.type="submit",$(h).on("click",function(){i()});var y='<div class="barChart"><p class="barChart barChartTitle"> 個案數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',b=G.ui.create("div","col",y,g.container.col_lineChart);b.id="TabDengueMedical_lineChart",b.tooltip=G.ui.create("div","","",b),b.tooltip.id="TabDengueMedical_lineChart_tooltip",b.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var f='<div class="barChart"><p class="barChart barChartTitle"> 週平均隱藏期統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',v=G.ui.create("div","col",f,g.container.col_lineChart);v.id="TabDengueMedical_hiddenChart";var C=["city","ns1"],D=["category","hidden"],x={};C.forEach(function(e){var t='<p class="barChartTitle"> '+p.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,g.container.col_barChart1);x[e]=G.ui.create("div","","",a),x[e].id="barChart_denguemedical_"+e,x[e].style="min-width: 240px; width: 240px; height: 60px;"}),D.forEach(function(e){var t='<p class="barChartTitle"> '+p.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,g.container.col_barChart2);x[e]=G.ui.create("div","","",a),x[e].id="barChart_denguemedical_"+e,x[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.dengueMedical=function(e,t,a,n){return new G.tab.DengueMedical(e,t,a,n)},G.tab.DengueWeather=function(e,t,a,n){e.createTabControl("個案統計",G.tabbutton.dengueWeather(),t,"DengueWeather",G.tab.tabClick)},G.tab.dengueWeather=function(e,t,a,n){return new G.tab.DengueWeather(e,t,a,n)},G.tab.DengueRisk=function(e,t,a,n){e.createTabControl("個案統計",G.tabbutton.dengueRisk(),t,"DengueRisk",G.tab.tabClick);G.menu.DengueGraph.refresh("DengueRiskSpatial"),G.menu.DengueGraph.refresh("DengueRiskMST")},G.tab.dengueRisk=function(e,t,a,n){return new G.tab.DengueRisk(e,t,a,n)},G.tab.MeaslesSummary=function(e,t,a,n){function r(){p.innerHTML="";var e={};e.grapharea=L.DomUtil.create("div","container",p),e.grapharea.titleDiv=G.ui.create("div","","",e.grapharea),e.grapharea.titleText=G.ui.create("h2","",'<b><i><span style="color:#235989;">'+u+"</span>範圍 麻疹個案統計摘要圖表</i></b>",e.grapharea.titleDiv),e.grapharea.line=G.ui.create("hr","","",e.grapharea.titleDiv),e.grapharea.style.display="",e.grapharea.row1=L.DomUtil.create("div","row",e.grapharea),e.grapharea.row2=L.DomUtil.create("div","row",e.grapharea),e.grapharea.row3=L.DomUtil.create("div","row",e.grapharea),e.grapharea.div_case_compare=L.DomUtil.create("div","col-sm-6",e.grapharea.row1),e.grapharea.div_case_compare.id="summary-chart-case-compare",G.ui.create("p","","<h4><b>歷年確定病例數比較</b></h4>",e.grapharea.div_case_compare),e.grapharea.div_case_counting=L.DomUtil.create("div","col-sm-6",e.grapharea.row1),e.grapharea.div_case_counting.id="summary-chart-case-counting";var t=(new Date).getFullYear();G.ui.create("p","","<h4><b>"+t+"年病例統計("+t+"年迄今)</b></h4>",e.grapharea.div_case_counting),e.grapharea.div_case_mmr=L.DomUtil.create("div","col-sm-6",e.grapharea.row2),e.grapharea.div_case_mmr.id="summary-chart-case-mmr",G.ui.create("p","","<h4><b>"+LanguageValue.Tab.MeaslesSummary.Mmr.Title+"</b></h4>",e.grapharea.div_case_mmr),e.grapharea.div_case_cluster=L.DomUtil.create("div","col-sm-6",e.grapharea.row2),e.grapharea.div_case_cluster.id="summary-chart-case-cluster";var t=(new Date).getFullYear();G.ui.create("p","","<h4><b>"+t+"年群聚事件健康監測統計表</b></h4>",e.grapharea.div_case_cluster),e.grapharea.div_case_age=L.DomUtil.create("div","col-sm-6",e.grapharea.row3),e.grapharea.div_case_age.id="summary-chart-case-age",G.ui.create("p","","<h4><b>麻疹確定個案年齡分布</b></h4>",e.grapharea.div_case_age),o(),i(),s(),l(),c()}function o(){$.ajax({url:"/map/data/measles/tab/summary/compare",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){function t(e){var t=e;t.length>8&&(t=t.slice(t.length-8,t.length)),s.domain(d3.keys(t[0]).filter(function(e){return"sick_year"!==e})),t.forEach(function(e){var t=0;e.ages=s.domain().map(function(a){return{name:a,y0:t,y1:t+=+e[a]}}),e.total=e.ages[e.ages.length-1].y1}),o.domain(t.map(function(e){return e.sick_year})),i.domain([0,d3.max(t,function(e){return e.total})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.axisBottom(o)).append("text").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("fill","#000").attr("font-size",12).text("發病年"),l.append("g").attr("class","y axis").call(d3.axisLeft(i)).append("text").attr("x",-50).attr("y",105).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("病例數");var a=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e,t){return"<span style='color:lightblue'>"+e.name+"</span><br>病例數： <span style='color:lightblue'>"+(e.y1-e.y0).toString()+"</span>"}),c=l.selectAll(".sick_year").data(t).enter().append("g").attr("class","g").attr("transform",function(e){return"translate("+o(e.sick_year)+",0)"});c.selectAll("rect").data(function(e){return e.ages}).enter().append("rect").attr("width",o.bandwidth()).attr("y",function(e){return i(e.y1)}).attr("height",function(e){return i(e.y0)-i(e.y1)}).style("fill",function(e){return s(e.name)}).on("mouseover",a.show).on("mouseout",a.hide).call(a);var u=l.selectAll(".legend").data(s.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate("+120*t+",0)"});u.append("rect").attr("x",n-240).attr("y",-24).attr("width",18).attr("height",18).style("fill",s),u.append("text").attr("x",n-244).attr("y",-16).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})}var a={top:30,right:20,bottom:30,left:60},n=450-a.left-a.right,r=350-a.top-a.bottom,o=d3.scaleBand().range([0,n]).padding(.1),i=d3.scaleLinear().range([r,0]),s=d3.scaleOrdinal(["#235989","#7fa8cb"]),l=d3.select("#summary-chart-case-compare").append("svg").attr("width",n+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");t(e)})}function i(){$.ajax({url:"/map/data/measles/tab/summary/counting",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=document.getElementById("summary-chart-case-counting");t.table=L.DomUtil.create("table","table table-striped",t),t.table.head=G.ui.create("thead","",'<tr style="background-color:#699ad0"><th style="background-color:#699ad0" scope="col-md-2">行政區</th><th style="background-color:#699ad0" scope="col-md-2">通報病例</th><th style="background-color:#699ad0" scope="col-md-2">確定病例(本土)</th><th style="background-color:#699ad0" scope="col-md-2">確定病例(境外)</th></tr>',t.table),t.table.body=L.DomUtil.create("tbody","",t.table),e.forEach(function(e){G.ui.create("tr","",'<td scope="row">'+e["行政區"]+"</td><td>"+e["通報病例"]+"</td><td>"+e["確定病例(本土)"]+"</td><td>"+e["確定病例(境外)"]+"</td>",t.table.body)})})}function s(){$.ajax({url:"/map/data/measles/tab/summary/mmr",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){function t(e){var t=e;t.length>8&&(t=t.slice(t.length-8,t.length)),s.domain(d3.keys(t[0]).filter(function(e){return"sick_year"!==e})),t.forEach(function(e){var t=0;e.mmr=s.domain().map(function(a){return{name:a,y0:t,y1:t+=+e[a]}}),e.total=e.mmr[e.mmr.length-1].y1}),o.domain(t.map(function(e){return e.sick_year})),i.domain([0,d3.max(t,function(e){return e.total})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.axisBottom(o)).append("text").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("fill","#000").attr("font-size",12).text("發病年"),l.append("g").attr("class","y axis").call(d3.axisLeft(i)).append("text").attr("x",-50).attr("y",105).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("病例數");var a=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e,t){return"<span style='color:lightblue'>"+e.name+"</span><br>病例數： <span style='color:lightblue'>"+(e.y1-e.y0).toString()+"</span>"}),c=l.selectAll(".sick_year").data(t).enter().append("g").attr("class","g").attr("transform",function(e){return"translate("+o(e.sick_year)+",0)"});c.selectAll("rect").data(function(e){return e.mmr}).enter().append("rect").attr("width",o.bandwidth()).attr("y",function(e){return i(e.y1)}).attr("height",function(e){return i(e.y0)-i(e.y1)}).style("fill",function(e){return s(e.name)}).on("mouseover",a.show).on("mouseout",a.hide).call(a);var u=l.selectAll(".legend").data(s.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate("+75*t+",0)"});u.append("rect").attr("x",n-290).attr("y",-24).attr("width",18).attr("height",18).style("fill",s),u.append("text").attr("x",n-294).attr("y",-16).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})}var a={top:30,right:20,bottom:30,left:60},n=450-a.left-a.right,r=350-a.top-a.bottom,o=d3.scaleBand().range([0,n]).padding(.1),i=d3.scaleLinear().range([r,0]),s=d3.scaleOrdinal(["#315498","#3B67BC","#B0C3E6","#E2E9E9"]),l=d3.select("#summary-chart-case-mmr").append("svg").attr("width",n+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");t(e)})}function l(){$.ajax({url:"/map/data/measles/tab/summary/cluster",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){var t=document.getElementById("summary-chart-case-cluster");t.table=L.DomUtil.create("table","table table-striped",t),t.table.head=G.ui.create("thead","",'<tr style="background-color:#699ad0"><th style="background-color:#699ad0" scope="col-md-3">群聚事件名稱</th><th style="background-color:#699ad0" scope="col-md-2">個案總數</th><th style="background-color:#699ad0" scope="col-md-2">目前監測人數</th><th style="background-color:#699ad0" scope="col-md-2">有症狀人數</th><th style="background-color:#699ad0" scope="col-md-3">最後監測日期</th></tr>',t.table),e&&e.data&&(t.table.body=L.DomUtil.create("tbody","",t.table),e.data.forEach(function(e){G.ui.create("tr","",'<td scope="row">'+e["群聚事件名稱"]+"</td><td>"+e["個案總數"]+"</td><td>"+e["目前監測人數"]+"</td><td>"+e["有症狀人數"]+"</td><td>"+(e["最後監測日期"]?new Date(e["最後監測日期"]).toLocaleDateString():"無")+"</td>",t.table.body)}))})}function c(){$.ajax({url:"/map/data/measles/tab/summary/age",async:!0,dataType:"json",data:d,type:"POST"}).done(function(e){function t(e){var t=e;t.length>8&&(t=t.slice(t.length-8,t.length)),s.domain(d3.keys(t[0]).filter(function(e){return"sick_year"!==e})),t.forEach(function(e){var t=0;e.ages=s.domain().map(function(a){return{name:a,y0:t,y1:t+=+e[a]}}),e.total=e.ages[e.ages.length-1].y1}),o.domain(t.map(function(e){return e.sick_year})),i.domain([0,d3.max(t,function(e){return e.total})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.axisBottom(o)).append("text").attr("x",n/2).attr("y",20).attr("dy","0.71em").attr("fill","#000").attr("font-size",12).text("發病年"),l.append("g").attr("class","y axis").call(d3.axisLeft(i)).append("text").attr("x",-50).attr("y",105).attr("fill","#000").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("病例數");var a=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e,t){return"<span style='color:lightblue'>"+e.name+"</span><br>病例數： <span style='color:lightblue'>"+(e.y1-e.y0).toString()+"</span>"}),c=l.selectAll(".sick_year").data(t).enter().append("g").attr("class","g").attr("transform",function(e){return"translate("+o(e.sick_year)+",0)"});c.selectAll("rect").data(function(e){return e.ages}).enter().append("rect").attr("width",o.bandwidth()).attr("y",function(e){return i(e.y1)}).attr("height",function(e){return i(e.y0)-i(e.y1)}).style("fill",function(e){return s(e.name)}).on("mouseover",a.show).on("mouseout",a.hide).call(a);var u=l.selectAll(".legend").data(s.domain().slice()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate("+75*t+",0)"});u.append("rect").attr("x",n-290).attr("y",-24).attr("width",18).attr("height",18).style("fill",s),u.append("text").attr("x",n-294).attr("y",-16).attr("dy",".35em").style("text-anchor","end").text(function(e){return e})}var a={top:30,right:20,bottom:30,left:60},n=450-a.left-a.right,r=350-a.top-a.bottom,o=d3.scaleBand().range([0,n]).padding(.1),i=d3.scaleLinear().range([r,0]),s=d3.scaleOrdinal(["#BE4F12","#F7C4A4","#FFD35B","#D4D4D4"]),l=d3.select("#summary-chart-case-age").append("svg").attr("width",n+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");t(e)})}var u=User.org_name?User.org_name:"全國",d={permission_level:null},p=e.createTabControl("摘要報表",G.tabbutton.measlesSummary(),t,"measlesSummary",G.tab.tabClick);r()},G.tab.measlesSummary=function(e,t,a,n){return new G.tab.MeaslesSummary(e,t,a,n)},G.tab.MeaslesCase=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=u.queryObjects;$(p).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(p).on("itemAddedOnInit",function(e){}),$(p).on("beforeItemAdd",function(e){}),$(p).on("itemAdded",function(e){}),$(p).on("beforeItemRemove",function(e){}),$(p).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.case_static_time.text="發病："+e(u.startTime)+"-"+e(u.endTime),$(p).tagsinput("add",{id:"case_static_time",text:a.case_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="case_static_time",r.case_static_time=$(".label-static span")[n],n++,a.case_static_determine.text="診斷：診斷中+確診個案",a.case_static_determine.query="診斷中+確診個案",$(p).tagsinput("add",{id:"case_static_determine",text:a.case_static_determine.text,type:"barStatic"}),$(".label-static span")[n].id="case_static_determine",r.case_static_determine=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"case_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.startTime.getFullYear(),month:u.startTime.getMonth(),day:u.startTime.getDate()}}),s.value=t(u.startTime);var l=u.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var d=document.createElement("p");d.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.endTime.getFullYear(),month:u.endTime.getMonth(),day:u.endTime.getDate()}}),p.value=t(u.endTime);var g=u.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(d),i.appendChild(p),swal({text:"發病：",content:i}).then(function(t){if(c||m){u.startTime=l,u.endTime=g,o.text="發病："+e(u.startTime)+"-"+e(u.endTime);var a=r.case_static_time,n=$(r.case_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"case_static_determine":var h=document.createElement("select"),y=["診斷中+確診個案","診斷中個案","確診個案"];y.forEach(function(e){var t=document.createElement("option");t.value=e,t.innerHTML=e,h.appendChild(t)}),h.value=o.query;var b;$(h).on("change",function(){b=this.value}),swal({text:"個案診斷狀態：",content:h}).then(function(e){if(e&&b){o.query=b,o.text="診斷："+b;var t=r.case_static_determine,a=$(r.case_static_determine).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(u.startTime),end:e(u.endTime)};u.dataCategory.forEach(function(e,a,n){u.queryObjects[e]&&u.queryObjects[e].query&&(t[e]=u.queryObjects[e].query)}),d.container.col_lineChart.noLocateData.style="margin:5px;display:none;";var a="/map/data/measles/tab/case/query",n=L.DomUtil.create("div","lmask",c);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){if($(n).remove(),u.dataContent=e,d.container.divTableNoLocate.innerHTML="",d.container.divTableNoLocate.style="display:none",u.dataContent.noLocateData&&u.dataContent.noLocateData.length>0){d.container.col_lineChart.noLocateData.style="margin:5px;",d.container.col_lineChart.noLocateData.text.innerHTML="注意：此搜尋含有未定位的資料 ("+u.dataContent.noLocateData.length.toString()+")     ";var a=L.DomUtil.create("table","",d.container.divTableNoLocate);a.style="margin:5px",a.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-4">地區</th></tr>',a),a.body=L.DomUtil.create("tbody","",a);var r=0;u.dataContent.noLocateData.forEach(function(e){r++;var t=r.toString();G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.REPORT+"</td><td>"+new Date(e.SICK_DATE).toLocaleDateString()+"</td><td>"+e.RESIDENCE_COUNTY_NAME+e.RESIDENCE_TOWN_NAME+e.RESIDENCE_VILLAGE_NAME+"</td>",a.body)})}else d.container.col_lineChart.noLocateData.style="margin:5px;display:none;";G.menu.MeaslesGraph.refresh("MeaslesCase",t),s(u.dataContent.week_line),l(f.immigration,u.dataContent.immigration),l(f.city,u.dataContent.city),l(f.age,u.dataContent.age),l(f.gender,u.dataContent.gender),l(f.country,u.dataContent.country),l(f.mmr,u.dataContent.mmr)})}function s(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+d(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-d(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==u.hasLineChart&&(d3.select("#zone_measlescase_lineChart svg").remove(),u.hasLineChart=!1),u.hasLineChart=!0;var r=540,o=200,i=d3.select("#zone_measlescase_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var d=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),p=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(d);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(p),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return e.count||e.count>=0?e:null}).x(function(e){return c(e.id)}).y(function(e){return d(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("個案數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function l(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],d=0;d<i.length;d++)c.push(i[d][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var g=[],l=0;l<i.length;l++){for(var m=0,h=0,d=0;d<i[l].length;d++)h+=i[l][d];for(var d=0;d<i[l].length;d++){var y=(i[l][d]/h*100).toFixed(0);if(y>20){var b=n[0][d]+"<br>("+i[l][d]+" / "+y+"%)";g.push({xref:"x",yref:"y",x:m+i[l][d]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][d]}}s.annotations=g,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_measlescase_",""),v=u.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(p).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o;break;case"mmr":o="疫苗："+o}v.display.push(o),$(p).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var c=e.createTabControl("個案統計",G.tabbutton.measlesCase(),t,"measlesCase",G.tab.tabClick),u={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,hasLineChart:!1,dataCategory:["week_line","immigration","city","age","gender","country","mmr","case_static_time","case_static_determine"],dataContent:{},queryItems:{immigration:null,city:null,age:null,gender:null,country:null,mmr:null},queryObjects:{case_static_time:{text:"",query:null},case_static_determine:{text:"",query:null},time:{time_type:"",start:"",end:""},immigration:{title:"是否境外移入",order:["本土","境外移入"],item:[],display:[],query:null},city:{title:"居住地區",item:[],display:[],query:null},age:{title:"年齡層",order:["0","1-6","7-19","20-39","40+"],item:[],display:[],query:null},gender:{title:"性別",order:["女","男"],item:[],display:[],query:null},country:{title:"感染國家",item:[],display:[],query:null},mmr:{title:"疫苗接種情形",order:["未接種","1劑","2劑","不明"],item:[],display:[],query:null}}},d=G.ui.create("div","","",c);d.container=G.ui.create("div","container-fluid","",d),d.container.row=G.ui.create("div","row","",d.container),d.container.col_lineChart=G.ui.create("div","col-md-6","",d.container.row),d.container.col_barChart1=G.ui.create("div","col-md-3","",d.container.row),d.container.col_barChart2=G.ui.create("div","col-md-3","",d.container.row),d.container.col_lineChart.searchBar=G.ui.create("div","","",d.container.col_lineChart),d.container.col_lineChart.noLocateData=G.ui.create("div","","",d.container.col_lineChart),d.container.col_lineChart.noLocateData.style="margin:5px;display:none;",d.container.col_lineChart.noLocateData.text=G.ui.create("span","h5","注意：此搜尋含有未定位的資料     ",d.container.col_lineChart.noLocateData),d.container.col_lineChart.noLocateData.button=G.ui.create("button","btn btn-warning btn-xs","檢視未定位資料",d.container.col_lineChart.noLocateData),$(d.container.col_lineChart.noLocateData.button).on("click",function(){$(d.container.divTableNoLocate).toggle()}),d.container.divTableNoLocate=G.ui.create("div","","",d.container.col_lineChart.noLocateData);var p=G.ui.create("input","","",d.container.col_lineChart.searchBar);p.type="text",p["data-role"]="tagsinput";var g=G.ui.create("button","btn btn-primary btn-xs","更新",d.container.col_lineChart.searchBar);g.type="submit",$(g).on("click",function(){i()});var m='<div class="barChart"><p class="barChart barChartTitle"> 個案數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',h=G.ui.create("div","col",m,d.container.col_lineChart);h.id="zone_measlescase_lineChart",h.tooltip=G.ui.create("div","","",h),h.tooltip.id="zone_measlescase_lineChart_tooltip",h.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var y=["immigration","age","country"],b=["city","gender","mmr"],f={};y.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart1);f[e]=G.ui.create("div","","",a),f[e].id="barChart_measlescase_"+e,
f[e].style="min-width: 240px; width: 240px; height: 60px;"}),b.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart2);f[e]=G.ui.create("div","","",a),f[e].id="barChart_measlescase_"+e,f[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.measlesCase=function(e,t,a,n){return new G.tab.MeaslesCase(e,t,a,n)},G.tab.MeaslesCluster=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=d.queryObjects;$(g).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(g).on("itemAddedOnInit",function(e){}),$(g).on("beforeItemAdd",function(e){}),$(g).on("itemAdded",function(e){}),$(g).on("beforeItemRemove",function(e){}),$(g).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.cluster_static_time.text="發病："+e(d.startTime)+"-"+e(d.endTime),$(g).tagsinput("add",{id:"cluster_static_time",text:a.cluster_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="cluster_static_time",r.cluster_static_time=$(".label-static span")[n],n++,a.cluster_static_info.text="群聚：所有群聚事件",a.cluster_static_info.query=-1,$(g).tagsinput("add",{id:"cluster_static_info",text:a.cluster_static_info.text,type:"barStatic"}),$(".label-static span")[n].id="cluster_static_info",r.cluster_static_info=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"cluster_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.startTime.getFullYear(),month:d.startTime.getMonth(),day:d.startTime.getDate()}}),s.value=t(d.startTime);var l=d.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var u=document.createElement("p");u.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:d.endTime.getFullYear(),month:d.endTime.getMonth(),day:d.endTime.getDate()}}),p.value=t(d.endTime);var g=d.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(u),i.appendChild(p),swal({text:"發病：",content:i}).then(function(t){if(c||m){d.startTime=l,d.endTime=g,o.text="發病："+e(d.startTime)+"-"+e(d.endTime);var a=r.cluster_static_time,n=$(r.cluster_static_time).parent()[0];n.innerText=o.text,n.append(a)}});break;case"cluster_static_info":var h=document.createElement("select"),y=d.dataContent.cluster,b=[{case_name:"所有群聚事件",id:-1}];y&&y.length>0&&y.forEach(function(e){b.push(e)}),b.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.innerHTML=e.case_name,h.appendChild(t)}),h.value=o.query;var f,v;$(h).on("change",function(){f=this.selectedOptions[0].value,v=this.selectedOptions[0].text}),swal({text:"群聚事件選擇：",content:h}).then(function(e){if(e&&v){o.query=f,o.text="群聚："+v;var t=r.cluster_static_info,a=$(r.cluster_static_info).parent()[0];a.innerText=o.text,a.append(t)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(d.startTime),end:e(d.endTime)};d.dataCategory.forEach(function(e,a,n){d.queryObjects[e]&&d.queryObjects[e].query&&(t[e]=d.queryObjects[e].query)});var a="/map/data/measles/tab/cluster/query",n=L.DomUtil.create("div","lmask",u);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){$(n).remove(),d.dataContent=e,G.menu.MeaslesGraph.refresh("MeaslesCluster",t),G.menu.MeaslesGraph.refresh("MeaslesClusterContact",t),s(d.dataContent.week_line),l(v.closed,d.dataContent.closed),l(v.city,d.dataContent.city),c(v.cluster,d.dataContent.cluster)})}function s(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+u(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-u(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==d.hasLineChart&&(d3.select("#zone_measlescluster_lineChart svg").remove(),d.hasLineChart=!1),d.hasLineChart=!0;var r=540,o=200,i=d3.select("#zone_measlescluster_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var u=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),p=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(u);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(p),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return e.count||e.count>=0?e:null}).x(function(e){return c(e.id)}).y(function(e){return u(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("發病時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("個案數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function l(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],u=0;u<i.length;u++)c.push(i[u][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var p=[],l=0;l<i.length;l++){for(var m=0,h=0,u=0;u<i[l].length;u++)h+=i[l][u];for(var u=0;u<i[l].length;u++){var y=(i[l][u]/h*100).toFixed(0);if(y>20){var b=n[0][u]+"<br>("+i[l][u]+" / "+y+"%)";p.push({xref:"x",yref:"y",x:m+i[l][u]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][u]}}s.annotations=p,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_measlescluster_",""),v=d.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(g).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o}v.display.push(o),$(g).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}function c(e,t){}var u=e.createTabControl("群聚",G.tabbutton.measlesCluster(),t,"measlesCluster",G.tab.tabClick),d={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,hasLineChart:!1,dataCategory:["week_line","closed","city","cluster_static_time","cluster_static_info"],dataContent:{},queryItems:{closed:null,city:null},queryObjects:{cluster_static_time:{text:"",query:null},cluster_static_info:{text:"",query:null},time:{time_type:"",start:"",end:""},closed:{title:"結案狀態",order:["未結案","已結案"],item:[],display:[],query:null},city:{title:"居住地區",item:[],display:[],query:null}}},p=G.ui.create("div","","",u);p.container=G.ui.create("div","container-fluid","",p),p.container.row=G.ui.create("div","row","",p.container),p.container.col_lineChart=G.ui.create("div","col-md-6","",p.container.row),p.container.col_barChart1=G.ui.create("div","col-md-3","",p.container.row),p.container.col_barChart2=G.ui.create("div","col-md-3","",p.container.row),p.container.col_selectCluster=G.ui.create("div","col-md-3","",p.container.row),p.container.col_lineChart.searchBar=G.ui.create("div","","",p.container.col_lineChart);var g=G.ui.create("input","","",p.container.col_lineChart.searchBar);g.type="text",g["data-role"]="tagsinput";var m=G.ui.create("button","btn btn-primary btn-xs","更新",p.container.col_lineChart.searchBar);m.type="submit",$(m).on("click",function(){i()});var h='<div class="barChart"><p class="barChart barChartTitle"> 群聚個案數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',y=G.ui.create("div","col",h,p.container.col_lineChart);y.id="zone_measlescluster_lineChart",y.tooltip=G.ui.create("div","","",y),y.tooltip.id="zone_measlescluster_lineChart_tooltip",y.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var b=["closed"],f=["city"],v={};b.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart1);v[e]=G.ui.create("div","","",a),v[e].id="barChart_measlescluster_"+e,v[e].style="min-width: 240px; width: 240px; height: 60px;"}),f.forEach(function(e){var t='<p class="barChartTitle"> '+d.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,p.container.col_barChart2);v[e]=G.ui.create("div","","",a),v[e].id="barChart_measlescluster_"+e,v[e].style="min-width: 240px; width: 240px; height: 60px;"}),v.cluster=G.ui.create("div","","",p.container.col_selectCluster),r(),i()},G.tab.measlesCluster=function(e,t,a,n){return new G.tab.MeaslesCluster(e,t,a,n)},G.tab.MeaslesContact=function(e,t,a,n){function r(){o()}function o(){function e(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+a+n}function t(e){var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),n=e.getDate().toString();return 1==a.length&&(a="0"+a),1==n.length&&(n="0"+n),t+"-"+a+"-"+n}var a=u.queryObjects;$(p).tagsinput({tagClass:function(e){switch(e.type){case"barChart":return"label label-barchart";case"barStatic":return"label label-static"}},itemValue:"id",itemText:"text"}),$(p).on("itemAddedOnInit",function(e){}),$(p).on("beforeItemAdd",function(e){}),$(p).on("itemAdded",function(e){}),$(p).on("beforeItemRemove",function(e){}),$(p).on("itemRemoved",function(e){var t=a[e.item.id];t.item=[],t.display=[],t.query=null});var n=$(".label-static span").length,r={};a.contact_static_time.text="接觸："+e(u.startTime)+"-"+e(u.endTime),$(p).tagsinput("add",{id:"contact_static_time",text:a.contact_static_time.text,type:"barStatic"}),$(".label-static span")[n].id="contact_static_time",r.contact_static_time=$(".label-static span")[n],n++,$(".label-static span").attr("data-role","static"),$(".label-static span").text(" +"),$(".label-static span").css("cursor","pointer"),$(".label-static span").click(function(n){var o=a[this.id];switch(this.id){case"contact_static_time":var i=document.createElement("div"),s=document.createElement("input");s.placeholder="起始日期",s.type="text",$(s).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.startTime.getFullYear(),month:u.startTime.getMonth(),day:u.startTime.getDate()}}),s.value=t(u.startTime);var l=u.startTime,c=!1;$(s).on("change",function(){c=!0,l=new Date(this.value)});var d=document.createElement("p");d.innerText=" 至 ";var p=document.createElement("input");p.placeholder="結束日期",p.type="text",$(p).datepicker({format:"yyyy-mm-dd",todayHighlight:!0,calendarWeeks:!0,language:"zh-TW",defaultViewDate:{year:u.endTime.getFullYear(),month:u.endTime.getMonth(),day:u.endTime.getDate()}}),p.value=t(u.endTime);var g=u.endTime,m=!1;$(p).on("change",function(){m=!0,g=new Date(this.value)}),i.appendChild(s),i.appendChild(d),i.appendChild(p),swal({text:"接觸：",content:i}).then(function(t){if(c||m){u.startTime=l,u.endTime=g,o.text="接觸："+e(u.startTime)+"-"+e(u.endTime);var a=r.contact_static_time,n=$(r.contact_static_time).parent()[0];n.innerText=o.text,n.append(a)}})}})}function i(){function e(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()}var t={start:e(u.startTime),end:e(u.endTime)};u.dataCategory.forEach(function(e,a,n){u.queryObjects[e]&&u.queryObjects[e].query&&(t[e]=u.queryObjects[e].query)}),d.container.col_lineChart.noLocateData.style="margin:5px;display:none;";var a="/map/data/measles/tab/contact/query",n=L.DomUtil.create("div","lmask",c);$.ajax({url:a,async:!0,dataType:"json",type:"POST",data:t}).done(function(e){if($(n).remove(),u.dataContent=e,d.container.divTableNoLocate.innerHTML="",d.container.divTableNoLocate.style="display:none",u.dataContent.noLocateData&&u.dataContent.noLocateData.length>0){d.container.col_lineChart.noLocateData.style="margin:5px;",d.container.col_lineChart.noLocateData.text.innerHTML="注意：此搜尋含有未定位的資料 ("+u.dataContent.noLocateData.length.toString()+")     ";var a=L.DomUtil.create("table","",d.container.divTableNoLocate);a.style="margin:5px",a.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th><th scope="col-md-3">接觸日</th><th scope="col-md-4">地區</th></tr>',a),a.body=L.DomUtil.create("tbody","",a);var r=0;u.dataContent.noLocateData.forEach(function(e){r++;var t=r.toString();G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.GENDER+"</td><td>"+e.AGE+"</td><td>"+new Date(e.CONTACT_DATE).toLocaleDateString()+"</td><td>"+e.RESIDENTIAL_COUNTY_NAME+e.RESIDENTIAL_TOWN_NAME+"</td>",a.body)})}else d.container.col_lineChart.noLocateData.style="margin:5px;display:none;";G.menu.MeaslesGraph.refresh("MeaslesContact",t),s(u.dataContent.week_line),l(f.watch,u.dataContent.watch),l(f.city,u.dataContent.city)})}function s(e){function t(){var t=c.invert(d3.mouse(this)[0]),a=b(e,t,1),n=e[a-1],i=e[a],s=t-n.id>i.id-t?i:n;y.attr("transform","translate("+c(s.id)+","+d(s.count)+")"),y.select("text").text(function(){return"第"+s.week+"週："+(s.count?s.count:"無資料")}),y.select(".x-hover-line").attr("y2",o-d(s.count)),y.select(".y-hover-line").attr("x2",r+r)}for(var a=!0,n=e.length-1;n>=0;n--)0!=e[n].count&&(a=!1),a&&(e[n].count=null);1==u.hasLineChart&&(d3.select("#zone_measlescontact_lineChart svg").remove(),u.hasLineChart=!1),u.hasLineChart=!0;var r=540,o=200,i=d3.select("#zone_measlescontact_lineChart").append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:20,right:20,bottom:30,left:50},l=Math.max.apply(Math,e.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(e.map(function(e){return e.id}));c.invert=function(){var e=c.domain(),t=c.range(),a=d3.scaleQuantize().domain(t).range(e);return function(e){return a(e)}}();var d=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),p=d3.axisBottom(c).tickFormat(function(t,a){return e.length<=5||1==e[a].week||!(e[a].week%5)?e[a].week:""}),g=d3.axisLeft().scale(d);i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(p),i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+s.top+")").call(g);var m=d3.line().defined(function(e){return e.count||e.count>=0?e:null}).x(function(e){return c(e.id)}).y(function(e){return d(e.count)}).curve(d3.curveCardinal.tension(1));i.append("g").append("path").attr("class","line-path").attr("transform","translate("+s.left+","+s.top+")").attr("d",m(e)).attr("fill","none").attr("stroke-width",3).attr("stroke","#235989"),i.append("text").attr("fill","#000").attr("x",r/2-30).attr("y",o-10).attr("dy","0.71em").attr("font-size",12).text("接觸時間（週）"),i.append("text").attr("x",16).attr("y",70).attr("id","title").attr("font-size",12).attr("style","writing-mode: tb; glyph-orientation-vertical: 0").text("接觸者人數");var h=i.append("g").attr("transform","translate("+s.left+","+s.top+")"),y=h.append("g").attr("class","focus").style("display","none");y.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",o),y.append("line").attr("class","y-hover-line hover-line").attr("x1",r).attr("x2",r),y.append("circle").attr("r",4.5),y.append("text").attr("x",15).attr("dy",".31em"),i.append("rect").attr("transform","translate("+s.left+","+s.top+")").attr("class","overlay").attr("width",r).attr("height",o).on("mouseover",function(){y.style("display",null)}).on("mouseout",function(){y.style("display","none")}).on("mousemove",t);var b=d3.bisector(function(e){return e.id}).left}function l(e,t){var a="rgb(33, 42, 69)",n=[],r=[],o=[],i=[];t.forEach(function(e){o.push(e.count),i.push(e.type)}),r.push(o),n.push(i);var s={barmode:"stack",paper_bgcolor:"rgb(255, 255, 255)",plot_bgcolor:"rgb(255, 255, 255)",margin:{l:0,r:0,t:0,b:0},xaxis:{fixedrange:!0,visible:!1},yaxis:{fixedrange:!0,visible:!1},showlegend:!1,hovermode:"closest",showticklabels:!0};r.forEach(function(t,r){var o=[],i=[];i.push(t);for(var l=0;l<i[0].length;l++){for(var c=[],d=0;d<i.length;d++)c.push(i[d][l]);o.push({x:c,name:"",text:n[0][l]+"："+c[0],orientation:"h",type:"bar",marker:{color:a,line:{color:"rgb(255, 255, 255)",width:1}},hoverinfo:"text"})}for(var g=[],l=0;l<i.length;l++){for(var m=0,h=0,d=0;d<i[l].length;d++)h+=i[l][d];for(var d=0;d<i[l].length;d++){var y=(i[l][d]/h*100).toFixed(0);if(y>20){var b=n[0][d]+"<br>("+i[l][d]+" / "+y+"%)";g.push({xref:"x",yref:"y",x:m+i[l][d]/2,y:0,xanchor:"center",yanchor:"center",text:b,font:{family:"Arial",size:12,color:"rgb(255,255,255)"},showarrow:!1})}m+=i[l][d]}}s.annotations=g,Plotly.newPlot(e,o,s,{displayModeBar:!1});var f=e.id.replace("barChart_measlescontact_",""),v=u.queryObjects[f];e.on("plotly_click",function(e){var t=e.points[0].curveNumber,a=(e.points[0].x,n[0][t]);"city"==f?(v.item=[],v.item.push(a)):v.item.indexOf(a)>=0?v.item.splice(v.item.indexOf(a),1):v.item.push(a);var r=[];if(v.item.forEach(function(e){r.push(e)}),v.display.forEach(function(e){$(p).tagsinput("remove",{id:f,text:e,type:"barChart"})}),v.display=[],v.item=r,v.order&&v.item.sort(function(e,t){return v.order.indexOf(e)>v.order.indexOf(t)?1:-1}),v.query=null,v.item.length>0){v.query="";var o="",i=0;switch(v.item.forEach(function(e){0!=i&&(o+=" & ",v.query+="&"),o+=e,v.query+=e,i++}),f){case"immigration":o="境外移入："+o;break;case"city":o="區域："+o;break;case"age":o="年齡層："+o;break;case"gender":o="性別："+o;break;case"country":o="國家："+o}v.display.push(o),$(p).tagsinput("add",{id:f,text:o,type:"barChart"})}}).on("plotly_unhover",function(e){})})}var c=e.createTabControl("接觸者",G.tabbutton.measlesContact(),t,"measlesContact",G.tab.tabClick),u={format:"yyyy-MM-dd",startTime:n.tabStartTime,endTime:n.tabEndTime,hasLineChart:!1,dataCategory:["week_line","watch","city","contact_static_time"],dataContent:{},queryItems:{watch:null,city:null},queryObjects:{contact_static_time:{text:"",query:null},time:{time_type:"",start:"",end:""},watch:{title:"健康監測",order:["進行中","已完成"],item:[],display:[],query:null},city:{title:"居住地區",item:[],display:[],query:null}}},d=G.ui.create("div","","",c);d.container=G.ui.create("div","container-fluid","",d),d.container.row=G.ui.create("div","row","",d.container),d.container.col_lineChart=G.ui.create("div","col-md-6","",d.container.row),d.container.col_barChart1=G.ui.create("div","col-md-3","",d.container.row),d.container.col_barChart2=G.ui.create("div","col-md-3","",d.container.row),d.container.col_lineChart.searchBar=G.ui.create("div","","",d.container.col_lineChart),d.container.col_lineChart.noLocateData=G.ui.create("div","","",d.container.col_lineChart),d.container.col_lineChart.noLocateData.style="margin:5px;display:none;",d.container.col_lineChart.noLocateData.text=G.ui.create("span","h5","注意：此搜尋含有未定位的資料     ",d.container.col_lineChart.noLocateData),d.container.col_lineChart.noLocateData.button=G.ui.create("button","btn btn-warning btn-xs","檢視未定位資料",d.container.col_lineChart.noLocateData),$(d.container.col_lineChart.noLocateData.button).on("click",function(){$(d.container.divTableNoLocate).toggle()}),d.container.divTableNoLocate=G.ui.create("div","","",d.container.col_lineChart.noLocateData);var p=G.ui.create("input","","",d.container.col_lineChart.searchBar);p.type="text",p["data-role"]="tagsinput";var g=G.ui.create("button","btn btn-primary btn-xs","更新",d.container.col_lineChart.searchBar);g.type="submit",$(g).on("click",function(){i()});var m='<div class="barChart"><p class="barChart barChartTitle"> 接觸者人數統計 </p><hr class="my-4" width="150px" align="left" color="black"></div>',h=G.ui.create("div","col",m,d.container.col_lineChart);h.id="zone_measlescontact_lineChart",h.tooltip=G.ui.create("div","","",h),h.tooltip.id="zone_measlescontact_lineChart_tooltip",h.tooltip.style="position:absolute;background-color:lightgray;padding:5px";var y=["watch"],b=["city"],f={};y.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart1);f[e]=G.ui.create("div","","",a),f[e].id="barChart_measlescontact_"+e,f[e].style="min-width: 240px; width: 240px; height: 60px;"}),b.forEach(function(e){var t='<p class="barChartTitle"> '+u.queryObjects[e].title+' </p><hr class="my-4" width="150px" align="left" color="black"> ',a=G.ui.create("div","barChart",t,d.container.col_barChart2);f[e]=G.ui.create("div","","",a),f[e].id="barChart_measlescontact_"+e,f[e].style="min-width: 240px; width: 240px; height: 60px;"}),r(),i()},G.tab.measlesContact=function(e,t,a,n){return new G.tab.MeaslesContact(e,t,a,n)},G.popup={},G.ui.popupInfoWindow=function(e){switch(G.ui.Zone_PopupInfoWindow.type=e,G.ui.PopupInfoWindow.type=e,e){case"DengueCase":return G.ui.Zone_PopupInfoWindow.DengueCase;case"DengueCluster":return G.ui.Zone_PopupInfoWindow.DengueCluster;case"DengueClusterArea":case"DengueClusterGroupAreaCity":case"DengueClusterGroupAreaDist":case"DengueClusterGroupAreaVillage":case"DengueClusterPeopleAreaCity":case"DengueClusterPeopleAreaDist":case"DengueClusterPeopleAreaVillage":return G.ui.Zone_PopupInfoWindow.DengueClusterArea;case"DenguePestMosquitoAreaBi":case"DenguePestMosquitoAreaHouse":case"DenguePestMosquitoAreaContainer":case"DenguePestMosquitoAreaWorm":case"DenguePestBucketAreaEgg":case"DenguePestBucketAreaPositive":return G.ui.Zone_PopupInfoWindow.DenguePestArea;case"DenguePestBucketPoint":return G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint;case"DenguePestVegetablePoint":return G.popup.DenguePestVegetablePoint;case"DenguePrevent":return G.popup.DenguePrevent;case"DengueMedical":return G.popup.DengueMedical;case"MeaslesCase":return G.ui.PopupInfoWindow.MeaslesCase;case"MeaslesCluster":return G.ui.PopupInfoWindow.MeaslesCase;case"MeaslesContact":return G.ui.PopupInfoWindow.MeaslesContact;case"MeaslesClusterContactAreaCity":case"MeaslesClusterContactAreaDist":case"MeaslesContactAreaCity":case"MeaslesContactAreaDist":return G.ui.PopupInfoWindow.MeaslesContactArea}},G.ui.Zone_PopupInfoWindow={},G.ui.Zone_PopupInfoWindow.type="DengueCase",G.ui.PopupInfoWindow={},G.ui.PopupInfoWindow.type="MeaslesCase",G.ui.Zone_PopupInfoWindow.DengueCase=function(e,t,a){function n(){t.on("popupclose",function(e){e.popup===a&&(b&&b.geo&&(t.removeLayer(b.geo),b.geo=null),h&&t.removeLayer(h),h=null,f&&t.removeLayer(f),f=null,y&&y.length>0&&y.forEach(function(e){t.removeLayer(e)}),y=[]),v={}})}function r(){var t=!1;!User.regional||User.city==e.RESIDENCE_COUNTY_NAME&&User.dist==e.RESIDENCE_TOWN_NAME||(t=!0),D.summary.desc=[],D.summary.desc.push(G.ui.create("div","","<b>法傳編號：</b>"+e.REPORT+" ("+e.DETERMINED_STATUS_DESC+")",D.summary)),D.summary.desc.push(G.ui.create("div","","<b>發病日：</b>"+new Date(e.SICK_DATE).toLocaleDateString(),D.summary)),D.summary.desc.push(G.ui.create("div","","<b>報告日：</b>"+new Date(e.REPORT_DATE).toLocaleDateString(),D.summary)),D.summary.desc.push(G.ui.create("div","","<b>診斷日：</b>"+new Date(e.DIAGNOSE_DATE).toLocaleDateString(),D.summary)),t||(D.summary.desc.push(G.ui.create("div","","<b>性別：</b>"+e.GENDER_DESC,D.summary)),D.summary.desc.push(G.ui.create("div","","<b>發病年齡：</b>"+e.SICK_AGE,D.summary)),D.summary.desc.push(G.ui.create("div","","<b>居住地址：</b>"+e.RESIDENCE_COUNTY_NAME+e.RESIDENCE_TOWN_NAME+e.RESIDENCE_VILLAGE_NAME+e.ADDRESS,D.summary)));var a="<b>境外移入：</b>";a+="0"==e.IMMIGRATION?"否":"是","1"==e.IMMIGRATION&&(a+=e.INFECTED_COUNTRY_NAME&&e.INFECTED_COUNTRY_NAME.length>0?" ("+e.INFECTED_COUNTRY_NAME+")":"未註明"),D.summary.desc.push(G.ui.create("div","",a,D.summary));var n=G.ui.create("div","","<b>地理群聚：</b>",D.summary);D.summary.desc.push(n);var r="無結果或未檢驗";switch(e.PATHOGEN_DETAIL_NAME){case"第一型":r="第一型";break;case"第二型":r="第二型";break;case"第三型":r="第三型";break;case"第四型":r="第四型";break;default:r="無結果或未檢驗"}D.summary.desc.push(G.ui.create("div","","<b>血清型：</b>"+r,D.summary))}function o(){function a(e){return L.geoJson(e,{pointToLayer:function(e,t){var a=new L.Icon({iconSize:[24,24],iconUrl:e.properties.iconUrl}),n=L.marker(t,{icon:a});return n},style:{color:"#777777",weight:3,opacity:1}})}D.geo.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked="false"><span>顯示所有點位</span></label>',D.geo);var n=e.RESIDENCE_COUNTY_NAME+e.RESIDENCE_TOWN_NAME+e.RESIDENCE_VILLAGE_NAME+e.ADDRESS;if(G.ui.create("div","","<label>居住地：</label>",D.geo),G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+n+"</span></label>",D.geo),G.ui.create("div","","<label>工作/就學：</label>",D.geo),G.ui.create("div","","無資料",D.geo),G.ui.create("div","","<label>活動點：</label>",D.geo),G.ui.create("div","","無資料",D.geo),x){json=x,G.ui.create("div","","<label>通報醫院：</label>",D.geo),json.data&&json.data.length>=1&&json.data[0].NAME?G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+json.data[0].NAME+"</span></label>",D.geo):G.ui.create("div","","無資料",D.geo);var r={type:"FeatureCollection",features:[]};if(r.features.push({type:"Feature",geometry:{type:"Point",coordinates:[e.LON,e.LAT]},properties:{iconUrl:"/map/images/icon/icon_house.png"}}),json.data&&json.data.length>=1&&json.data.forEach(function(e){e.lon&&e.lat&&r.features.push({type:"Feature",geometry:{type:"Point",coordinates:[e.lon,e.lat]},properties:{iconUrl:"/map/images/icon/icon_hospital.png"}})}),r.features.length>1)for(var o=r.features.length,i=1;i<o;i++)r.features.push({type:"Feature",geometry:{type:"LineString",coordinates:[r.features[0].geometry.coordinates,r.features[i].geometry.coordinates]},properties:{}});b.geo=a(r).addTo(t),b&&("geo"==G.ui.Zone_PopupInfoWindow.DengueCase.tab&&b.geo?b.geo.addTo(t):t.removeLayer(b.geo))}}function i(){x&&(json=x,D.hospital.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>顯示所有點位</span></label>',D.hospital),G.ui.create("div","","<label>通報醫院：</label>",D.hospital),json.data&&json.data.length>=1&&json.data[0].NAME?G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+json.data[0].NAME+"</span></label>",D.hospital):G.ui.create("div","","無資料",D.hospital),G.ui.create("div","","<label>就醫歷程：</label>",D.hospital),G.ui.create("div","","無資料",D.hospital))}function s(){function a(a){D.area.innerHTML="",D.area.condition=L.DomUtil.create("div","",D.area);G.ui.create("div","","",D.area.condition);n(D.area.condition,a);var o=new Date(e.SICK_DATE),i=new Date(o.getFullYear(),o.getMonth(),o.getDate()-a.date_minus),m=new Date(o.getFullYear(),o.getMonth(),o.getDate()+a.date_bonus),y=r(e.LAT,e.LON,a.distance),b=[{lat:e.LAT,lng:e.LON}];if("所有關聯點位"==a.point_type&&x)for(var C=0;C<x.data.length;C++)if(x.data[C]&&x.data[C].lat&&x.data[C].lon){b.push({lat:x.data[C].lat,lng:x.data[C].lon});var _=r(x.data[C].lat,x.data[C].lon,a.distance);y.xmin>_.xmin&&(y.xmin=_.xmin),y.ymin>_.ymin&&(y.ymin=_.ymin),y.xmax<_.xmax&&(y.xmax=_.xmax),y.ymax<_.ymax&&(y.ymax=_.ymax)}switch(a.points=b,h&&t.removeLayer(h),h=null,f&&t.removeLayer(f),f=null,v={},h=s(b,a.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCase.tab&&h.setStyle({fillOpacity:0}),a.result_type){case"個案情形":h.setStyle({fillColor:"#ff7800"});break;case"醫療院所/醫療資源":h.setStyle({fillColor:"#ff7800"});break;case"最近一次布氏指數":h.setStyle({fillColor:"#000000"});break;case"平均布氏指數":h.setStyle({fillColor:"#000000"});break;case"高風險農園":h.setStyle({fillColor:"#ff7800"})}var w=L.DomUtil.create("div","lmask",D.area);$.ajax({url:"/map/data/dengue/info/case/area",async:!0,dataType:"json",type:"POST",data:{xmin:y.xmin,xmax:y.xmax,ymin:y.ymin,ymax:y.ymax,date_start:i,date_end:m,lat:a.lat,lng:a.lng,points:JSON.stringify(a.points),distance:a.distance,point_type:a.point_type,result_type:a.result_type}}).done(function(n){switch($(w).remove(),a.result_type){case"個案情形":f=c(n).addTo(t);break;case"醫療院所/醫療資源":f=u(n).addTo(t);break;case"最近一次布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level-e.properties.bi_level:t.properties.bi_hasdata?1:-1}),f=d(n).addTo(t);break;case"平均布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level[0]-e.properties.bi_level[0]:t.properties.bi_hasdata?1:-1}),f=p(n).addTo(t);break;case"高風險農園":f=g(n).addTo(t)}switch(f&&("area"==G.ui.Zone_PopupInfoWindow.DengueCase.tab?f.addTo(t):t.removeLayer(f)),D.area.tableDiv=L.DomUtil.create("div","",D.area),D.area.table=L.DomUtil.create("table","table table-striped",D.area.tableDiv),a.result_type){case"個案情形":D.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',D.area.table),
D.area.table.body=L.DomUtil.create("tbody","",D.area.table);var r=0;n.features.forEach(function(t){var a="";e.REPORT==t.properties.REPORT?a="*":(r++,a=r.toString());var n=G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.REPORT+"</td><td>"+new Date(t.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+t.properties.GENDER_DESC+"</td><td>"+t.properties.SICK_AGE+"</td>",D.area.table.body);e.REPORT==t.properties.REPORT&&(n.style["background-color"]="#FFD27F"),n.id="popupDataTrHover_"+t.properties.REPORT,$(n).mouseover(function(){$(this).addClass("popupDataTrHover"),v[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),$(n).mouseleave(function(){$(this).removeClass("popupDataTrHover"),v[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))})});break;case"醫療院所/醫療資源":D.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-5">醫療院所名稱</th><th scope="col-md-3">電話</th></tr>',D.area.table),D.area.table.body=L.DomUtil.create("tbody","",D.area.table);var r=0;n.features.forEach(function(e){r++;var t=r.toString(),a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.ID+"</td><td>"+e.properties.AKA+"</td><td>"+e.properties.TEL+"</td>",D.area.table.body);a.id="popupDataTrHover_"+e.properties.ID,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),v[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),v[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"}))})});break;case"最近一次布氏指數":D.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',D.area.table),D.area.table.body=L.DomUtil.create("tbody","",D.area.table);var r=0;n.features.forEach(function(e){r++;var t;e.properties.bi_hasdata?(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+new Date(e.properties.checkdate).toLocaleDateString()+"</td><td>"+e.properties.bi_level+"</td>",D.area.table.body),t.style["background-color"]=l(e.properties.bi_level)):(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",D.area.table.body),t.style["background-color"]="#ffffff"),t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),v[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),v[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"平均布氏指數":D.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',D.area.table),D.area.table.body=L.DomUtil.create("tbody","",D.area.table);var r=0;n.features.forEach(function(e){r++;var t;if(e.properties.bi_hasdata){t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+e.properties.checkdate[0]+"</td><td>"+e.properties.bi_level[0]+"</td>",D.area.table.body),t.style["background-color"]=l(e.properties.bi_level[0]);for(var a=1;a<e.properties.checkdate.length;a++)tr_subdata=G.ui.create("tr","",'<td scope="row"></td><td>'+new Date(e.properties.checkdate[a]).toLocaleDateString()+"</td><td>"+e.properties.bi_level[a]+"</td>",D.area.table.body),tr_subdata.style["background-color"]="lightgray"}else t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",D.area.table.body),t.style["background-color"]="#ffffff";t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),v[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),v[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"高風險農園":D.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-5">農園編號</th><th scope="col-md-6">列管原因</th></tr>',D.area.table),D.area.table.body=L.DomUtil.create("tbody","",D.area.table);var r=0;n.features.forEach(function(e){var t="";r++,t=r.toString();var a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.NO+"</td><td>"+e.properties.Type+"</td>",D.area.table.body);a.id="popupDataTrHover_"+e.properties.NO,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),v[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),v[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"}))})})}})}function n(e,t){var n="發病日";switch(t.date_type){case"sick_date":n="發病日"}e.innerHTML="",G.ui.create("span","","自 ",e);var r=G.ui.create("a","",n+"-"+t.date_minus+"日▼",e);G.ui.create("span",""," 至 ",e);var o=G.ui.create("a","",n+"+"+t.date_bonus+"日▼",e);G.ui.create("br","","",e),G.ui.create("span",""," 個案 ",e);var i=G.ui.create("a","",t.point_type+"▼",e);G.ui.create("br","","",e);var s=G.ui.create("a","",t.distance+"公尺▼",e);G.ui.create("span",""," 環域內 ",e);var l=G.ui.create("a","",t.result_type+"▼",e);G.ui.create("p","","",e),r.addEventListener("click",function(){swal({text:"發病日往前天數",content:{element:"input",attributes:{type:"number",value:t.date_minus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_minus=parseInt(e),a(t))})}),o.addEventListener("click",function(){swal({text:"發病日往後天數",content:{element:"input",attributes:{type:"number",value:t.date_bonus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_bonus=parseInt(e),a(t))})}),i.addEventListener("click",function(){var e=document.createElement("select"),n=["居住地點位","所有關聯點位"];n.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)}),e.value=t.point_type;var r;$(e).on("change",function(){r=this.value}),swal({text:"點位類型",content:e}).then(function(e){e&&r&&(t.point_type=r,a(t))})}),s.addEventListener("click",function(){swal({text:"距離",content:{element:"input",attributes:{type:"number",value:t.distance,min:1}}}).then(function(e){e&&e.length>0&&(t.distance=parseInt(e),a(t))})}),l.addEventListener("click",function(){var e=document.createElement("select"),n=["個案情形","醫療院所/醫療資源","最近一次布氏指數","平均布氏指數","高風險農園"];n.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)});var r=["化學防治(未開放)","Ovitrap(未開放)"];r.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,a.disabled=!0,e.appendChild(a)}),e.value=t.result_type;var o;$(e).on("change",function(){o=this.value}),swal({text:"環域結果呈現",content:e}).then(function(e){e&&o&&(t.result_type=o,G.ui.Zone_PopupInfoWindow.DengueCase.result_type=o,a(t))})})}function r(e,t,a){var n=turf.point([t,e]),r={units:"kilometers"},o=turf.destination(n,a/1e3,0,r),i=turf.destination(n,a/1e3,90,r),s=turf.destination(n,a/1e3,180,r),l=turf.destination(n,a/1e3,270,r),c=o.geometry.coordinates[1],u=i.geometry.coordinates[0],d=s.geometry.coordinates[1],p=l.geometry.coordinates[0];return{xmin:p,xmax:u,ymin:d,ymax:c}}function o(e,t,a){var n=[t,e],r=a/1e3,o={steps:256,units:"kilometers",properties:{}};return turf.circle(n,r,o)}function i(e,t,a,n){var r=o(e,t,a),i=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:i};return n&&(s.fillColor=n),new L.geoJson(r,s)}function s(e,t,a){var n=[];e.forEach(function(e){n.push(o(e.lat,e.lng,t))});for(var r=1;r<n.length;r++)n[0]=turf.union(n[0],n[r]);var i=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:i};return a&&(s.fillColor=a),new L.geoJson(n[0],s)}function l(e){var t=["#ffffff","#f4daca","#edae86","#d46d6e"],a=t[0];if(!e||e<0)return a;switch(e){case 0:a=t[0];break;case 1:a=t[1];break;case 2:a=t[2];break;default:a=t[3]}return a}function c(e){v={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.REPORT,r=L.marker(a,{icon:t});return v[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function u(e){v={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.ID,r=L.marker(a,{icon:t});return v[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function d(e){v={};var t=function(e,t){var a=.75,n=.5,r=l(e.properties.bi_level),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;v[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function p(e){v={};var t=function(e,t){var a=.75,n=.5,r=l(e.properties.bi_hasdata?e.properties.bi_level[0]:0),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;v[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function g(e){v={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.NO,r=L.marker(a,{icon:t});return v[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}var m={date:new Date(e.SICK_DATE),date_type:"sick_date",date_minus:7,date_bonus:7,lat:e.LAT,lng:e.LON,points:[e.LAT,e.LON],distance:150,point_type:"居住地點位",result_type:"個案情形"};G.ui.Zone_PopupInfoWindow.DengueCase.result_type="個案情形",h=i(e.LAT,e.LON,m.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCase.tab&&h.setStyle({fillOpacity:0}),a(m)}function l(){D.streetview.streetview=L.DomUtil.create("div","",D.streetview),D.streetview.streetview.id="google-street-view",D.streetview.streetview.style.height="270px",$(D.streetview).mouseover(function(){c.dragging&&c.dragging.disable()}),$(D.streetview).mouseout(function(){c.dragging&&c.dragging.enable()});var t=new google.maps.LatLng(e.LAT,e.LON),a={heading:270,pitch:0},n=new google.maps.StreetViewPanorama(D.streetview.streetview);n.setOptions({position:t,pov:a}),D.streetview.streetview.visible=function(){n.setVisible(!1),n.setVisible(!0)}}var c=document.createElement("div");c.className="leaflet-popup-content-sub";var u=document.createElement("div");u.className="leaflet-popup-content-sub-header",u.innerHTML="登革熱";var d=document.createElement("div");d.className="leaflet-popup-content-sub-content",u.invisible=G.ui.create("input","","透明化",u),u.invisible.type="checkbox",u.invisible.checked=!1,u.invisible.style.position="fixed",u.invisible.style.right="30px",u.invisible.style.top="10px",$(u.invisible).click(function(){$(u.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),c.appendChild(u),c.appendChild(d);var p=[{id:"summary",name:"摘要"},{id:"geo",name:"地理資訊"},{id:"hospital",name:"就醫"},{id:"area",name:"環域分析"},{id:"streetview",name:"街景"}],g=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",d),m=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",d),h=null,y=[],b={};b.geo=null;var f=null,v={},C=0,D={},x=null;return p.forEach(function(e){C++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==C?" leaflet-popup-content-sub-content-tab--active":"");D[e.id]=G.ui.create("div",n,"",m),D[e.id].id=a;var r="popupTabLink"+(1==C?" is-active":""),o=L.DomUtil.create("li","",g),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.ui.Zone_PopupInfoWindow.DengueCase.tab=e.id,G.util.each(g.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(m.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),h&&("area"==G.ui.Zone_PopupInfoWindow.DengueCase.tab?h.setStyle({fillOpacity:.2}):h.setStyle({fillOpacity:0})),f&&("area"==G.ui.Zone_PopupInfoWindow.DengueCase.tab?f.addTo(t):t.removeLayer(f)),b&&("geo"==G.ui.Zone_PopupInfoWindow.DengueCase.tab&&b.geo?b.geo.addTo(t):t.removeLayer(b.geo)),"streetview"==G.ui.Zone_PopupInfoWindow.DengueCase.tab&&D.streetview.streetview.visible&&D.streetview.streetview.visible()})}),G.ui.Zone_PopupInfoWindow.DengueCase.tab="summary",n(),$.ajax({url:"/map/data/dengue/info/case/hospital",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT}}).done(function(e){x=e,r(),o(),i(),s(),l()}),c},G.ui.Zone_PopupInfoWindow.DengueCase.tab="summary",G.ui.Zone_PopupInfoWindow.DengueCase.result_type="個案情形",G.ui.Zone_PopupInfoWindow.DengueCluster=function(e,t,a){function n(){var t=!1;!User.regional||User.city==e.ResidenceCity&&User.dist==e.ResidenceDist||(t=!0),f.summary.desc=[],f.summary.desc.push(G.ui.create("div","","<b>首例發病日：</b>"+new Date(e.sickdate_first).toLocaleDateString(),f.summary)),f.summary.desc.push(G.ui.create("div","","<b>末例發病日：</b>"+new Date(e.sickdate_last).toLocaleDateString(),f.summary)),f.summary.desc.push(G.ui.create("div","","<b>群聚人數：</b>"+e.case_count,f.summary)),f.summary.desc.push(G.ui.create("div","","<b>行政區：</b>"+e.residence_city+e.residence_dist+e.residence_village,f.summary)),f.summary.desc.push(G.ui.create("div","","<b>首例個案：</b>"+e.report_first,f.summary))}function r(){$.ajax({url:"/map/data/dengue/info/cluster/point/case",async:!0,dataType:"json",type:"POST",data:{id:e.id}}).done(function(e){f["case"].tableDiv=L.DomUtil.create("div","",f["case"]),f["case"].table=L.DomUtil.create("table","table table-striped",f["case"].tableDiv),f["case"].table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',f["case"].table),f["case"].table.body=L.DomUtil.create("tbody","",f["case"].table);var t=0;e.features.forEach(function(e){t++;var a=t.toString();G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+e.properties.REPORT+"</td><td>"+new Date(e.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+e.properties.GENDER_DESC+"</td><td>"+e.properties.SICK_AGE+"</td>",f["case"].table.body)})})}function o(){function n(a){f.area.innerHTML="",f.area.condition=L.DomUtil.create("div","",f.area);G.ui.create("div","","",f.area.condition);r(f.area.condition,a);var n=new Date(e.sickdate_first),s=new Date(n.getFullYear(),n.getMonth(),n.getDate()-a.date_minus),m=new Date(n.getFullYear(),n.getMonth(),n.getDate()+a.date_bonus),C=(i(e.LAT,e.LON,a.distance),o(e.LAT,e.LON,a.distance));switch(g&&t.removeLayer(g),g=null,h&&t.removeLayer(h),h=null,y={},g=l([{lat:e.LAT,lng:e.LON}],a.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCluster.tab&&g.setStyle({fillOpacity:0}),a.result_type){case"個案情形":g.setStyle({fillColor:"#ff7800"});break;case"醫療院所/醫療資源":g.setStyle({fillColor:"#ff7800"});break;case"最近一次布氏指數":g.setStyle({fillColor:"#000000"});break;case"平均布氏指數":g.setStyle({fillColor:"#000000"});break;case"高風險農園":g.setStyle({fillColor:"#ff7800"})}var D=L.DomUtil.create("div","lmask",f.area);$.ajax({url:"/map/data/dengue/info/cluster/point/area",async:!0,dataType:"json",type:"POST",data:{xmin:C.xmin,xmax:C.xmax,ymin:C.ymin,ymax:C.ymax,date_start:s,date_end:m,lat:a.lat,lng:a.lng,distance:a.distance,point_type:a.point_type,result_type:a.result_type}}).done(function(n){switch($(D).remove(),a.result_type){case"個案情形":h=u(n).addTo(t);break;case"醫療院所/醫療資源":h=d(n).addTo(t);break;case"最近一次布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level-e.properties.bi_level:t.properties.bi_hasdata?1:-1}),h=p(n).addTo(t);break;case"平均布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level[0]-e.properties.bi_level[0]:t.properties.bi_hasdata?1:-1}),h=b(n).addTo(t);break;case"高風險農園":h=v(n).addTo(t)}switch(h&&("area"==G.ui.Zone_PopupInfoWindow.DengueCluster.tab?h.addTo(t):t.removeLayer(h)),f.area.tableDiv=L.DomUtil.create("div","",f.area),f.area.table=L.DomUtil.create("table","table table-striped",f.area.tableDiv),a.result_type){case"個案情形":f.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',f.area.table),f.area.table.body=L.DomUtil.create("tbody","",f.area.table);var r=0;n.features.forEach(function(t){var a="";e.REPORT==t.properties.REPORT?a="*":(r++,a=r.toString());var n=G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.REPORT+"</td><td>"+new Date(t.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+t.properties.GENDER_DESC+"</td><td>"+t.properties.SICK_AGE+"</td>",f.area.table.body);e.REPORT==t.properties.REPORT&&(n.style["background-color"]="#FFD27F"),n.id="popupDataTrHover_"+t.properties.REPORT,$(n).mouseover(function(){$(this).addClass("popupDataTrHover"),y[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),$(n).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))})});break;case"醫療院所/醫療資源":f.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-5">醫療院所名稱</th><th scope="col-md-3">電話</th></tr>',f.area.table),f.area.table.body=L.DomUtil.create("tbody","",f.area.table);var r=0;n.features.forEach(function(e){r++;var t=r.toString(),a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.ID+"</td><td>"+e.properties.AKA+"</td><td>"+e.properties.TEL+"</td>",f.area.table.body);a.id="popupDataTrHover_"+e.properties.ID,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"}))})});break;case"最近一次布氏指數":f.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',f.area.table),f.area.table.body=L.DomUtil.create("tbody","",f.area.table);var r=0;n.features.forEach(function(e){r++;var t;e.properties.bi_hasdata?(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+new Date(e.properties.checkdate).toLocaleDateString()+"</td><td>"+e.properties.bi_level+"</td>",f.area.table.body),t.style["background-color"]=c(e.properties.bi_level)):(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",f.area.table.body),t.style["background-color"]="#ffffff"),t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),y[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"平均布氏指數":f.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',f.area.table),f.area.table.body=L.DomUtil.create("tbody","",f.area.table);var r=0;n.features.forEach(function(e){r++;var t;if(e.properties.bi_hasdata){t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+e.properties.checkdate[0]+"</td><td>"+e.properties.bi_level[0]+"</td>",f.area.table.body),t.style["background-color"]=c(e.properties.bi_level[0]);for(var a=1;a<e.properties.checkdate.length;a++)tr_subdata=G.ui.create("tr","",'<td scope="row"></td><td>'+new Date(e.properties.checkdate[a]).toLocaleDateString()+"</td><td>"+e.properties.bi_level[a]+"</td>",f.area.table.body),tr_subdata.style["background-color"]="lightgray"}else t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",f.area.table.body),t.style["background-color"]="#ffffff";t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),y[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"高風險農園":f.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-5">農園編號</th><th scope="col-md-6">列管原因</th></tr>',f.area.table),f.area.table.body=L.DomUtil.create("tbody","",f.area.table);var r=0;n.features.forEach(function(e){var t="";r++,t=r.toString();var a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.NO+"</td><td>"+e.properties.Type+"</td>",f.area.table.body);a.id="popupDataTrHover_"+e.properties.NO,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"}))})})}})}function r(e,t){var a="發病日";switch(t.date_type){case"sick_date":a="發病日"}e.innerHTML="",G.ui.create("span","","自 ",e);var r=G.ui.create("a","",a+"-"+t.date_minus+"日▼",e);G.ui.create("span",""," 至 ",e);var o=G.ui.create("a","",a+"+"+t.date_bonus+"日▼",e);G.ui.create("br","","",e),G.ui.create("span",""," 個案 ",e);var i=G.ui.create("a","",t.point_type+"▼",e);G.ui.create("br","","",e);var s=G.ui.create("a","",t.distance+"公尺▼",e);G.ui.create("span",""," 環域內 ",e);var l=G.ui.create("a","",t.result_type+"▼",e);G.ui.create("p","","",e),r.addEventListener("click",function(){swal({text:"發病日往前天數",content:{element:"input",attributes:{type:"number",value:t.date_minus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_minus=parseInt(e),n(t))})}),o.addEventListener("click",function(){swal({text:"發病日往後天數",content:{element:"input",attributes:{type:"number",value:t.date_bonus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_bonus=parseInt(e),n(t))})}),i.addEventListener("click",function(){var e=document.createElement("select"),a=["居住地點位","所有關聯點位"];a.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)}),e.value=t.point_type;var r;$(e).on("change",function(){r=this.value}),swal({text:"點位類型",content:e}).then(function(e){e&&r&&(t.point_type=r,n(t))})}),s.addEventListener("click",function(){swal({text:"距離",content:{element:"input",attributes:{type:"number",value:t.distance,min:1}}}).then(function(e){e&&e.length>0&&(t.distance=parseInt(e),n(t))})}),l.addEventListener("click",function(){var e=document.createElement("select"),a=["個案情形","醫療院所/醫療資源","最近一次布氏指數","平均布氏指數"];a.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)});var r=["化學防治(未開放)","Ovitrap(未開放)"];r.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,a.disabled=!0,e.appendChild(a)}),e.value=t.result_type;var o;$(e).on("change",function(){o=this.value}),swal({text:"環域結果呈現",content:e}).then(function(e){e&&o&&(t.result_type=o,G.ui.Zone_PopupInfoWindow.DengueCluster.result_type=o,n(t))})})}function o(e,t,a){var n=turf.point([t,e]),r={units:"kilometers"},o=turf.destination(n,a/1e3,0,r),i=turf.destination(n,a/1e3,90,r),s=turf.destination(n,a/1e3,180,r),l=turf.destination(n,a/1e3,270,r),c=o.geometry.coordinates[1],u=i.geometry.coordinates[0],d=s.geometry.coordinates[1],p=l.geometry.coordinates[0];return{xmin:p,xmax:u,ymin:d,ymax:c}}function i(e,t,a){var n=[t,e],r=a/1e3,o={steps:256,units:"kilometers",properties:{}};return turf.circle(n,r,o)}function s(e,t,a,n){var r=i(e,t,a),o=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:o};return n&&(s.fillColor=n),new L.geoJson(r,s)}function l(e,t,a){var n=[];e.forEach(function(e){n.push(i(e.lat,e.lng,t))});for(var r=1;r<n.length;r++)n[0]=turf.union(n[0],n[r]);var o=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:o};return a&&(s.fillColor=a),new L.geoJson(n[0],s)}function c(e){var t=["#ffffff","#f4daca","#edae86","#d46d6e"],a=t[0];if(!e||e<0)return a;switch(e){case 0:a=t[0];break;case 1:a=t[1];break;case 2:a=t[2];break;default:a=t[3]}return a}function u(e){y={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.REPORT,r=L.marker(a,{icon:t});return y[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function d(e){y={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.ID,r=L.marker(a,{icon:t});return y[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function p(e){y={};var t=function(e,t){var a=.75,n=.5,r=c(e.properties.bi_level),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;y[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function b(e){y={};var t=function(e,t){var a=.75,n=.5,r=c(e.properties.bi_hasdata?e.properties.bi_level[0]:0),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;y[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function v(e){y={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.NO,r=L.marker(a,{icon:t});return y[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_vegetable.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}var C={date:new Date(e.sickdate_first),date_type:"sick_date",date_minus:7,date_bonus:7,lat:e.LAT,lng:e.LON,distance:150,point_type:"居住地點位",result_type:"個案情形"};G.ui.Zone_PopupInfoWindow.DengueCluster.result_type="個案情形",g=s(e.LAT,e.LON,C.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCluster.tab&&g.setStyle({fillOpacity:0}),t.on("popupclose",function(e){e.popup===a&&g&&t.removeLayer(g),g=null,e.popup===a&&h&&t.removeLayer(h),h=null,y={},e.popup===a&&m&&m.length>0&&(m.forEach(function(e){t.removeLayer(e)}),m=[])}),n(C)}function i(){f.streetview.streetview=L.DomUtil.create("div","",f.streetview),f.streetview.streetview.id="google-street-view",f.streetview.streetview.style.height="270px",$(f.streetview).mouseover(function(){s.dragging&&s.dragging.disable()}),$(f.streetview).mouseout(function(){s.dragging&&s.dragging.enable()});var t=new google.maps.LatLng(e.LAT,e.LON),a={heading:270,pitch:0},n=new google.maps.StreetViewPanorama(f.streetview.streetview);n.setOptions({position:t,pov:a}),f.streetview.streetview.visible=function(){n.setVisible(!1),n.setVisible(!0)}}var s=document.createElement("div");s.className="leaflet-popup-content-sub";var l=document.createElement("div");l.className="leaflet-popup-content-sub-header",l.innerHTML="登革熱群聚";var c=document.createElement("div");c.className="leaflet-popup-content-sub-content",l.invisible=G.ui.create("input","","透明化",l),l.invisible.type="checkbox",l.invisible.checked=!1,l.invisible.style.position="fixed",l.invisible.style.right="30px",l.invisible.style.top="10px",$(l.invisible).click(function(){$(l.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),s.appendChild(l),s.appendChild(c);var u=[{id:"summary",name:"摘要"},{id:"case",name:"個案資訊"},{id:"area",name:"環域分析"},{id:"streetview",name:"街景"}],d=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",c),p=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",c),g=null,m=[],h=null,y={},b=0,f={};return u.forEach(function(e){b++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==b?" leaflet-popup-content-sub-content-tab--active":"");f[e.id]=G.ui.create("div",n,"",p),f[e.id].id=a;var r="popupTabLink"+(1==b?" is-active":""),o=L.DomUtil.create("li","",d),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.ui.Zone_PopupInfoWindow.DengueCluster.tab=e.id,G.util.each(d.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(p.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),g&&("area"==G.ui.Zone_PopupInfoWindow.DengueCluster.tab?g.setStyle({fillOpacity:.2}):g.setStyle({fillOpacity:0})),h&&("area"==G.ui.Zone_PopupInfoWindow.DengueCluster.tab?h.addTo(t):t.removeLayer(h)),"streetview"==G.ui.Zone_PopupInfoWindow.DengueCluster.tab&&f.streetview.streetview.visible&&f.streetview.streetview.visible()})}),G.ui.Zone_PopupInfoWindow.DengueCluster.tab="summary",n(),r(),o(),i(),s},G.ui.Zone_PopupInfoWindow.DengueClusterArea=function(e,t,a){function n(){var t=0,a=0,n=e.P_CNT?e.P_CNT:0;c.forEach(function(e){t+=1,a+=e.properties.case_count}),f.summary.desc=[],f.summary.desc.push(G.ui.create("div","","<b>群聚數：</b>"+t+"群",f.summary)),f.summary.desc.push(G.ui.create("div","","<b>群聚人數：</b>"+a+"例",f.summary)),
n>0&&f.summary.desc.push(G.ui.create("div","","<b>人口數：</b>"+n+"人",f.summary)),f.summary.desc.push(G.ui.create("div","","<br />",f.summary));var r={},o=[];switch(G.ui.Zone_PopupInfoWindow.type){case"DengueClusterGroupAreaCity":f.summary.desc.push(G.ui.create("div","","<b>近期趨勢(單位：群)</b>",f.summary));var i=99;c.forEach(function(e){var t=new Date(e.properties.sickdate_first),a=t.toLocaleDateString(),n=t.getMonth()+1+"/"+t.getDate();r[a]||(r[a]={cid:i--,date_short:n,count:0}),r[a].count+=1});break;case"DengueClusterPeopleAreaCity":f.summary.desc.push(G.ui.create("div","","<b>近期趨勢(單位：人)</b>",f.summary));var i=99;c.forEach(function(e){var t=new Date(e.properties.sickdate_first),a=t.toLocaleDateString(),n=t.getMonth()+1+"/"+t.getDate();r[a]||(r[a]={cid:i--,date_short:n,count:0}),r[a].count+=e.properties.case_count})}if(Object.keys(r).forEach(function(e){o.push(r[e])}),o.length>0){f.summary.graphDiv=L.DomUtil.create("div","",f.summary),f.summary.graphDiv.id="PopupInfoWindowDengueClusterAreaGraph";var s=300,l=100,u=d3.select(f.summary.graphDiv).append("svg").attr("width",s+"px").attr("height",l+"px"),d={top:12,right:10,bottom:20,left:10},p=Math.max.apply(Math,o.map(function(e){return e.count})),g=d3.scaleBand().rangeRound([0,s-d.left-d.right]).domain(o.map(function(e){return e.cid})),m=d3.scaleLinear().domain([0,p]).range([l-d.top-d.bottom,0]),h=d3.axisBottom(g).tickFormat(function(e,t){return o[t].date_short});u.append("g").attr("class","axis").attr("transform","translate("+d.left+","+(l-d.bottom)+")").call(h);var y=u.selectAll("rect").data(o).enter().append("g");y.append("rect").attr("x",function(e){return g(e.cid)+d.left+g.bandwidth()/4+g.bandwidth()/8}).attr("y",function(e){return m(e.count)+d.top}).attr("width",g.bandwidth()/4>0?g.bandwidth()/4:1).attr("height",function(e){return l-d.top-d.bottom-m(e.count)}).attr("class",function(e){return"area"}),y.append("text").attr("dy","1.3em").attr("x",function(e){return g(e.cid)+d.left+g.bandwidth()/2}).attr("y",function(e){return m(e.count)-5}).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","10px").attr("fill","black").text(function(e){return e.count})}else f.summary.desc.push(G.ui.create("div","","無資料",f.summary))}function r(){f.cluster.tableDiv=L.DomUtil.create("div","",f.cluster),f.cluster.table=L.DomUtil.create("table","table table-striped",f.cluster.tableDiv),f.cluster.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">群聚編號</th><th scope="col-md-4">首例發病日</th><th scope="col-md-3">狀態</th></tr>',f.cluster.table),f.cluster.table.body=L.DomUtil.create("tbody","",f.cluster.table);var e=0;c.forEach(function(t){e++;var a=e.toString();G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.report_first+"</td><td>"+new Date(t.properties.sickdate_first).toLocaleDateString()+"</td><td>"+(t.properties.closed?"已結案":"未結案")+"</td>",f.cluster.table.body)})}function o(){var e="";c.forEach(function(t){""!=e&&(e+=","),e+=t.properties.id.toString()}),e.length>0&&$.ajax({url:"/map/data/dengue/info/cluster/point/case",async:!0,dataType:"json",type:"POST",data:{id:e}}).done(function(e){f["case"].tableDiv=L.DomUtil.create("div","",f["case"]),f["case"].table=L.DomUtil.create("table","table table-striped",f["case"].tableDiv),f["case"].table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',f["case"].table),f["case"].table.body=L.DomUtil.create("tbody","",f["case"].table);var t=0;e.features.forEach(function(e){t++;var a=t.toString();G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+e.properties.REPORT+"</td><td>"+new Date(e.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+e.properties.GENDER_DESC+"</td><td>"+e.properties.SICK_AGE+"</td>",f["case"].table.body)})})}var i=document.createElement("div");i.className="leaflet-popup-content-sub";var s=document.createElement("div");s.className="leaflet-popup-content-sub-header",s.innerHTML="登革熱群聚";var l=G.geo.tile.geojsons.DengueCluster,c=[];switch(G.ui.Zone_PopupInfoWindow.type){case"DengueClusterGroupAreaCity":case"DengueClusterPeopleAreaCity":var u=e.COUNTY;u&&(s.innerHTML=u,l.features.forEach(function(e){e.properties.residence_city==u&&c.push(e)}));break;case"DengueClusterGroupAreaDist":case"DengueClusterPeopleAreaDist":var u=e.COUNTY,d=e.TOWN;u&&d&&(s.innerHTML=u+d,l.features.forEach(function(e){e.properties.residence_city==u&&e.properties.residence_dist==d&&c.push(e)}));break;case"DengueClusterGroupAreaVillage":case"DengueClusterPeopleAreaVillage":var u=e.COUNTYNAME,d=e.TOWNNAME,p=e.VILLNAME;u&&d&&p&&(s.innerHTML=u+d+p,l.features.forEach(function(e){e.properties.residence_city==u&&e.properties.residence_dist==d&&e.properties.residence_village==p&&c.push(e)}))}var g=document.createElement("div");g.className="leaflet-popup-content-sub-content",i.appendChild(s),i.appendChild(g);var m=[{id:"summary",name:"摘要"},{id:"cluster",name:"群聚清單"},{id:"case",name:"個案清單"}];G.ui.Zone_PopupInfoWindow.DengueClusterArea.tab="summary";var h=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",g),y=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",g),b=0,f={};return m.forEach(function(e){b++;var t="content-tab-"+e.id,a="leaflet-popup-content-sub-content-tab"+(1==b?" leaflet-popup-content-sub-content-tab--active":"");f[e.id]=G.ui.create("div",a,"",y),f[e.id].id=t;var n="popupTabLink"+(1==b?" is-active":""),r=L.DomUtil.create("li","",h),o=G.ui.create("a",n,e.name,r);o.addEventListener("click",function(a){G.ui.Zone_PopupInfoWindow.DengueCluster.tab=e.id,G.util.each(h.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(y.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+t)[0].classList.add("leaflet-popup-content-sub-content-tab--active")})}),n(),r(),o(),i},G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint=function(e,t,a){function n(){if(e.record){C.summary.graphDiv=L.DomUtil.create("div","",C.summary),C.summary.graphDiv.id="PopupInfoWindowDenguePestGraph";var t={},a=[],n=99;e.record.forEach(function(e){var a=new Date(e.investigate_date),r=a.toLocaleDateString(),o=a.getMonth()+1+"/"+a.getDate();t[r]||(t[r]={cid:n--,date_short:o,count:0}),t[r].count+=e.egg_count}),Object.keys(t).forEach(function(e){a.push(t[e])});var r=300,o=100,i=d3.select(C.summary.graphDiv).append("svg").attr("width",r+"px").attr("height",o+"px"),s={top:12,right:10,bottom:20,left:10},l=Math.max.apply(Math,a.map(function(e){return e.count})),c=d3.scaleBand().rangeRound([0,r-s.left-s.right]).domain(a.map(function(e){return e.cid})),u=d3.scaleLinear().domain([0,l]).range([o-s.top-s.bottom,0]),d=d3.axisBottom(c).tickFormat(function(e,t){return a[t].date_short});i.append("g").attr("class","axis").attr("transform","translate("+s.left+","+(o-s.bottom)+")").call(d);var p=i.selectAll("rect").data(a).enter().append("g");p.append("rect").attr("x",function(e){return c(e.cid)+s.left+c.bandwidth()/4+c.bandwidth()/8}).attr("y",function(e){return u(e.count)+s.top}).attr("width",c.bandwidth()/4>0?c.bandwidth()/4:1).attr("height",function(e){return o-s.top-s.bottom-u(e.count)}).attr("class",function(e){return"area"}),p.append("text").attr("dy","1.3em").attr("x",function(e){return c(e.cid)+s.left+c.bandwidth()/2}).attr("y",function(e){return u(e.count)-5}).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","10px").attr("fill","black").text(function(e){return e.count})}C.summary.tableDiv=L.DomUtil.create("div","",C.summary),C.summary.table=L.DomUtil.create("table","table table-striped",C.summary.tableDiv),C.summary.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-9">平均</th><th scope="col-md-2">'+e.egg_average.toFixed(2)+"</th></tr>",C.summary.table),C.summary.table.body=L.DomUtil.create("tbody","",C.summary.table);var g=0;e.record.forEach(function(e){g++;var t=g.toString();G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+new Date(e.investigate_date).toLocaleDateString()+"</td><td>"+e.egg_count+"</td>",C.summary.table.body)})}function r(){function n(a){C.area.innerHTML="",C.area.condition=L.DomUtil.create("div","",C.area);G.ui.create("div","","",C.area.condition);r(C.area.condition,a);var n=new Date(e.record[e.record.length-1].investigate_date),s=new Date(n.getFullYear(),n.getMonth(),n.getDate()-a.date_minus),m=new Date(n.getFullYear(),n.getMonth(),n.getDate()+a.date_bonus),y=(i(e.LAT,e.LON,a.distance),o(e.LAT,e.LON,a.distance));switch(h&&t.removeLayer(h),h=null,b&&t.removeLayer(b),b=null,f={},h=l([{lat:e.LAT,lng:e.LON}],a.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCase.tab&&h.setStyle({fillOpacity:0}),a.result_type){case"個案情形":h.setStyle({fillColor:"#ff7800"});break;case"醫療院所/醫療資源":h.setStyle({fillColor:"#ff7800"});break;case"最近一次布氏指數":h.setStyle({fillColor:"#000000"});break;case"平均布氏指數":h.setStyle({fillColor:"#000000"})}var v=L.DomUtil.create("div","lmask",C.area);$.ajax({url:"/data/dengue/map/case_info/area",async:!0,dataType:"json",type:"POST",data:{xmin:y.xmin,xmax:y.xmax,ymin:y.ymin,ymax:y.ymax,date_start:s,date_end:m,lat:a.lat,lng:a.lng,distance:a.distance,point_type:a.point_type,result_type:a.result_type}}).done(function(n){switch($(v).remove(),a.result_type){case"個案情形":b=u(n).addTo(t);break;case"醫療院所/醫療資源":b=d(n).addTo(t);break;case"最近一次布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level-e.properties.bi_level:t.properties.bi_hasdata?1:-1}),b=p(n).addTo(t);break;case"平均布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level[0]-e.properties.bi_level[0]:t.properties.bi_hasdata?1:-1}),b=g(n).addTo(t)}switch(b&&("area"==G.ui.Zone_PopupInfoWindow.DengueCase.tab?b.addTo(t):t.removeLayer(b)),C.area.tableDiv=L.DomUtil.create("div","",C.area),C.area.table=L.DomUtil.create("table","table table-striped",C.area.tableDiv),a.result_type){case"個案情形":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(t){var a="";e.REPORT==t.properties.REPORT?a="*":(r++,a=r.toString());var n=G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.REPORT+"</td><td>"+new Date(t.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+t.properties.GENDER_DESC+"</td><td>"+t.properties.SICK_AGE+"</td>",C.area.table.body);e.REPORT==t.properties.REPORT&&(n.style["background-color"]="#FFD27F"),n.id="popupDataTrHover_"+t.properties.REPORT,$(n).mouseover(function(){$(this).addClass("popupDataTrHover"),f[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),$(n).mouseleave(function(){$(this).removeClass("popupDataTrHover"),f[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))})});break;case"醫療院所/醫療資源":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-5">醫療院所名稱</th><th scope="col-md-3">電話</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t=r.toString(),a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.ID+"</td><td>"+e.properties.AKA+"</td><td>"+e.properties.TEL+"</td>",C.area.table.body);a.id="popupDataTrHover_"+e.properties.ID,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),f[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),f[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"}))})});break;case"最近一次布氏指數":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t;e.properties.bi_hasdata?(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+new Date(e.properties.checkdate).toLocaleDateString()+"</td><td>"+e.properties.bi_level+"</td>",C.area.table.body),t.style["background-color"]=c(e.properties.bi_level)):(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",C.area.table.body),t.style["background-color"]="#ffffff"),t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),f[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),f[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"平均布氏指數":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t;if(e.properties.bi_hasdata){t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+e.properties.checkdate[0]+"</td><td>"+e.properties.bi_level[0]+"</td>",C.area.table.body),t.style["background-color"]=c(e.properties.bi_level[0]);for(var a=1;a<e.properties.checkdate.length;a++)tr_subdata=G.ui.create("tr","",'<td scope="row"></td><td>'+new Date(e.properties.checkdate[a]).toLocaleDateString()+"</td><td>"+e.properties.bi_level[a]+"</td>",C.area.table.body),tr_subdata.style["background-color"]="lightgray"}else t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",C.area.table.body),t.style["background-color"]="#ffffff";t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),f[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),f[t.id].setStyle({weight:0,fillOpacity:.5})})})}})}function r(e,t){var a="調查日";e.innerHTML="",G.ui.create("span","","自 ",e);var r=G.ui.create("a","",a+"-"+t.date_minus+"日▼",e);G.ui.create("span",""," 至 ",e);var o=G.ui.create("a","",a+"+"+t.date_bonus+"日▼",e);G.ui.create("br","","",e);var i=G.ui.create("a","",t.distance+"公尺▼",e);G.ui.create("span",""," 環域內 ",e);var s=G.ui.create("a","",t.result_type+"▼",e);G.ui.create("p","","",e),r.addEventListener("click",function(){swal({text:"調查日往前天數",content:{element:"input",attributes:{type:"number",value:t.date_minus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_minus=parseInt(e),n(t))})}),o.addEventListener("click",function(){swal({text:"調查日往後天數",content:{element:"input",attributes:{type:"number",value:t.date_bonus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_bonus=parseInt(e),n(t))})}),i.addEventListener("click",function(){swal({text:"距離",content:{element:"input",attributes:{type:"number",value:t.distance,min:1}}}).then(function(e){e&&e.length>0&&(t.distance=parseInt(e),n(t))})}),s.addEventListener("click",function(){var e=document.createElement("select"),a=["個案情形","醫療院所/醫療資源","最近一次布氏指數","平均布氏指數"];a.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)});var r=["化學防治(未開放)","Ovitrap(未開放)"];r.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,a.disabled=!0,e.appendChild(a)}),e.value=t.result_type;var o;$(e).on("change",function(){o=this.value}),swal({text:"環域結果呈現",content:e}).then(function(e){e&&o&&(t.result_type=o,G.ui.Zone_PopupInfoWindow.DengueCase.result_type=o,n(t))})})}function o(e,t,a){var n=turf.point([t,e]),r={units:"kilometers"},o=turf.destination(n,a/1e3,0,r),i=turf.destination(n,a/1e3,90,r),s=turf.destination(n,a/1e3,180,r),l=turf.destination(n,a/1e3,270,r),c=o.geometry.coordinates[1],u=i.geometry.coordinates[0],d=s.geometry.coordinates[1],p=l.geometry.coordinates[0];return{xmin:p,xmax:u,ymin:d,ymax:c}}function i(e,t,a){var n=[t,e],r=a/1e3,o={steps:256,units:"kilometers",properties:{}};return turf.circle(n,r,o)}function s(e,t,a,n){var r=i(e,t,a),o=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:o};return n&&(s.fillColor=n),new L.geoJson(r,s)}function l(e,t,a){var n=[];e.forEach(function(e){n.push(i(e.lat,e.lng,t))});for(var r=1;r<n.length;r++)n[0]=turf.union(n[0],n[r]);var o=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:o};return a&&(s.fillColor=a),new L.geoJson(n[0],s)}function c(e){var t=["#ffffff","#f4daca","#edae86","#d46d6e"],a=t[0];if(!e||e<0)return a;switch(e){case 0:a=t[0];break;case 1:a=t[1];break;case 2:a=t[2];break;default:a=t[3]}return a}function u(e){f={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.REPORT,r=L.marker(a,{icon:t});return f[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function d(e){f={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.ID,r=L.marker(a,{icon:t});return f[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function p(e){f={};var t=function(e,t){var a=.75,n=.5,r=c(e.properties.bi_level),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;f[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function g(e){f={};var t=function(e,t){var a=.75,n=.5,r=c(e.properties.bi_hasdata?e.properties.bi_level[0]:0),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;f[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}var m={date:new Date,date_type:"sick_date",date_minus:7,date_bonus:7,lat:e.LAT,lng:e.LON,distance:150,point_type:"居住地點位",result_type:"個案情形"};G.ui.Zone_PopupInfoWindow.DengueCase.result_type="個案情形",h=s(e.LAT,e.LON,m.distance).addTo(t),"area"!=G.ui.Zone_PopupInfoWindow.DengueCase.tab&&h.setStyle({fillOpacity:0}),t.on("popupclose",function(e){e.popup===a&&h&&t.removeLayer(h),h=null,e.popup===a&&b&&t.removeLayer(b),b=null,f={},e.popup===a&&y&&y.length>0&&(y.forEach(function(e){t.removeLayer(e)}),y=[])}),n(m)}var o=document.createElement("div");o.className="leaflet-popup-content-sub";var i=document.createElement("div");i.className="leaflet-popup-content-sub-header",i.innerHTML="誘卵桶";var s=e.country,l=e.town,c=e.village,u=e.bucket_id;s&&l&&c&&(i.innerHTML=s+l+c,u&&(i.innerHTML+=" (桶號："+u+")"));var d=document.createElement("div");d.className="leaflet-popup-content-sub-content",i.invisible=G.ui.create("input","","透明化",i),i.invisible.type="checkbox",i.invisible.checked=!1,i.invisible.style.position="fixed",i.invisible.style.right="30px",i.invisible.style.top="10px",$(i.invisible).click(function(){$(i.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),o.appendChild(i),o.appendChild(d);var p=[{id:"summary",name:"調查結果"},{id:"area",name:"環域分析"}],g=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",d),m=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",d),h=null,y=[],b=null,f={},v=0,C={};return p.forEach(function(e){v++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==v?" leaflet-popup-content-sub-content-tab--active":"");C[e.id]=G.ui.create("div",n,"",m),C[e.id].id=a;var r="popupTabLink"+(1==v?" is-active":""),o=L.DomUtil.create("li","",g),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.tab=e.id,G.util.each(g.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(m.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),h&&("area"==G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.tab?h.setStyle({fillOpacity:.2}):h.setStyle({fillOpacity:0})),b&&("area"==G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.tab?b.addTo(t):t.removeLayer(b))})}),G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.tab="summary",n(),r(),o},G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.tab="summary",G.ui.Zone_PopupInfoWindow.DenguePestBucketPoint.result_type="個案情形",G.ui.Zone_PopupInfoWindow.DenguePestArea=function(e,t,a){function n(){var e,t=G.geo.tile.datajsons.objVillages;if(t&&t[c]&&t[c][u]&&t[c][u][d]&&(e=t[c][u][d]),e&&e.data_mosquito.forEach(function(e){var t=i(Math.round(e.p_container_amount/e.c_household*100));e.bi_level=t}),e){v.mosquito.graphDiv=L.DomUtil.create("div","",v.mosquito),v.mosquito.graphDiv.id="PopupInfoWindowDenguePestAreaGraph";var a={},n=[],r=99;e.data_mosquito.forEach(function(e){var t=new Date(e.checkdate),n=t.toLocaleDateString(),o=t.getMonth()+1+"/"+t.getDate();a[n]||(a[n]={cid:r--,date_short:o,count:0,total_p_container_amount:0,total_c_household:0}),a[n].count++,a[n].total_p_container_amount+=e.p_container_amount,a[n].total_c_household+=e.c_household}),Object.keys(a).forEach(function(e){n.push({cid:a[e].cid,date_short:a[e].date_short,bi_level:a[e].count>0&&a[e].total_c_household>0?i(Math.round(a[e].total_p_container_amount/a[e].total_c_household*100)):0})});var o=300,s=100,l=d3.select(v.mosquito.graphDiv).append("svg").attr("width",o+"px").attr("height",s+"px"),p={top:12,right:10,bottom:20,left:10},g=Math.max.apply(Math,n.map(function(e){return e.bi_level})),m=d3.scaleBand().rangeRound([0,o-p.left-p.right]).domain(n.map(function(e){return e.cid})),h=d3.scaleLinear().domain([0,g]).range([s-p.top-p.bottom,0]),y=d3.axisBottom(m).tickFormat(function(e,t){return n[t].date_short});l.append("g").attr("class","axis").attr("transform","translate("+p.left+","+(s-p.bottom)+")").call(y);var b=l.selectAll("rect").data(n).enter().append("g");b.append("rect").attr("x",function(e){return m(e.cid)+p.left+m.bandwidth()/4+m.bandwidth()/8}).attr("y",function(e){return h(e.bi_level)+p.top}).attr("width",m.bandwidth()/4>0?m.bandwidth()/4:1).attr("height",function(e){return s-p.top-p.bottom-h(e.bi_level)}).attr("class",function(e){return"area"}),b.append("text").attr("dy","1.3em").attr("x",function(e){return m(e.cid)+p.left+m.bandwidth()/2}).attr("y",function(e){return h(e.bi_level)-5}).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","10px").attr("fill","black").text(function(e){return e.bi_level})}v.mosquito.tableDiv=L.DomUtil.create("div","",v.mosquito),v.mosquito.table=L.DomUtil.create("table","table table-striped",v.mosquito.tableDiv),v.mosquito.table.head=G.ui.create("thead","",'<tr><th scope="col-md-3">調查日期</th><th scope="col-md-3">地區</th><th scope="col-md-3">布氏級數</th><th scope="col-md-3">調查戶數</th></tr>',v.mosquito.table),v.mosquito.table.body=L.DomUtil.create("tbody","",v.mosquito.table),e&&(G.ui.create("tr","","<td><b>平均值</b></td><td><b>-</td><td><b>"+e.bi_level+"</b></td><td><b>"+e.c_household+"</b></td>",v.mosquito.table.body),e.data_mosquito.forEach(function(e){var t=i(Math.round(e.p_container_amount/e.c_household*100));G.ui.create("tr","","<td>"+new Date(e.checkdate).toLocaleDateString()+"</td><td>-</td><td>"+t+"</td><td>"+e.c_household+"</td>",v.mosquito.table.body)}))}function r(){var e,t=G.geo.tile.datajsons.objVillages;if(t&&t[c]&&t[c][u]&&t[c][u][d]&&(e=t[c][u][d]),e){v.bucket.graphDiv=L.DomUtil.create("div","",v.bucket),v.bucket.graphDiv.id="PopupInfoWindowDenguePestAreaBucketGraph";var a={},n=[],r=99;e.data_bucket.forEach(function(e){var t=new Date(e.starttime),n=t.getFullYear(),o=e.week,i=t.toLocaleDateString(),s=n.toString()+"/"+o.toString();a[i]||(a[i]={cid:r--,date_short:s,count:0,total_positiverate:0,total_totaleggs:0}),a[i].count++,a[i].total_positiverate+=e.positiverate,a[i].total_totaleggs+=e.totaleggs}),Object.keys(a).forEach(function(e){n.push({cid:a[e].cid,date_short:a[e].date_short,positiverate:a[e].count>0?a[e].total_positiverate/a[e].count:0,totaleggs:a[e].total_totaleggs})});var o=300,i=100,s=d3.select(v.bucket.graphDiv).append("svg").attr("width",o+"px").attr("height",i+"px"),l={top:12,right:10,bottom:20,left:10},p=Math.max.apply(Math,n.map(function(e){return e.totaleggs})),g=Math.max.apply(Math,n.map(function(e){return e.positiverate})),m=d3.scaleBand().rangeRound([0,o-l.left-l.right]).domain(n.map(function(e){return e.cid})),h=d3.scaleLinear().domain([0,p]).range([i-l.top-l.bottom,0]),y=(d3.scaleLinear().domain([0,g]).range([i-l.top-l.bottom,0]),d3.axisBottom(m).tickFormat(function(e,t){return n[t].date_short}));s.append("g").attr("class","axis").attr("transform","translate("+l.left+","+(i-l.bottom)+")").call(y);var b=s.selectAll("rect").data(n).enter().append("g");b.append("rect").attr("x",function(e){return m(e.cid)+l.left+m.bandwidth()/4+m.bandwidth()/8}).attr("y",function(e){return h(e.totaleggs)+l.top}).attr("width",m.bandwidth()/4>0?m.bandwidth()/4:1).attr("height",function(e){return i-l.top-l.bottom-h(e.totaleggs)}).attr("class",function(e){return"area"}),b.append("text").attr("dy","1.3em").attr("x",function(e){return m(e.cid)+l.left+m.bandwidth()/2}).attr("y",function(e){return h(e.totaleggs)-5}).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","10px").attr("fill","black").text(function(e){return e.totaleggs})}v.bucket.tableDiv=L.DomUtil.create("div","",v.bucket),v.bucket.table=L.DomUtil.create("table","table table-striped",v.bucket.tableDiv),v.bucket.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">週次</th><th scope="col-md-4">陽性率</th><th scope="col-md-4">總卵數</th></tr>',v.bucket.table),v.bucket.table.body=L.DomUtil.create("tbody","",v.bucket.table),e&&(G.ui.create("tr","","<td><b>平均值</b></td><td><b>"+e.positiverate+"%</b></td><td><b>"+e.totaleggs+"</b></td>",v.bucket.table.body),e.data_bucket.forEach(function(e){var t=new Date(e.starttime).getFullYear(),a=e.week;G.ui.create("tr","","<td>"+t.toString()+"/"+a.toString()+"</td><td>"+e.positiverate+"%</td><td>"+e.totaleggs+"</td>",v.bucket.table.body)}))}function o(){}function i(e){return e<1?0:e<5?1:e<10?2:e<20?3:e<35?4:e<50?5:e<75?6:e<100?7:e<200?8:9}var s=document.createElement("div");s.className="leaflet-popup-content-sub";var l=document.createElement("div");l.className="leaflet-popup-content-sub-header",l.innerHTML="病媒蚊";var c=e.COUNTYNAME,u=e.TOWNNAME,d=e.VILLNAME;c&&u&&d&&(l.innerHTML=c+u+d);var p=document.createElement("div");p.className="leaflet-popup-content-sub-content",s.appendChild(l),s.appendChild(p);var g=[];G.ui.Zone_PopupInfoWindow.DenguePestArea.tab="mosquito";var m=["MosquitoBi","MosquitoHouse","MosquitoContainer","MosquitoWorm"],h=["BucketEgg","BucketPositive"];m.indexOf(G.geo.set.BoundaryVillage.type)>=0?(g=[{id:"mosquito",name:"蚊媒指數調查"},{id:"bucket",name:"誘卵桶調查"}],G.ui.Zone_PopupInfoWindow.DenguePestArea.tab="mosquito"):h.indexOf(G.geo.set.BoundaryVillage.type)>=0&&(g=[{id:"bucket",name:"誘卵桶調查"},{id:"mosquito",name:"蚊媒指數調查"}],G.ui.Zone_PopupInfoWindow.DenguePestArea.tab="bucket");var y=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",p),b=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",p),f=0,v={};return g.forEach(function(e){f++;var t="content-tab-"+e.id,a="leaflet-popup-content-sub-content-tab"+(1==f?" leaflet-popup-content-sub-content-tab--active":"");v[e.id]=G.ui.create("div",a,"",b),v[e.id].id=t;var n="popupTabLink"+(1==f?" is-active":""),r=L.DomUtil.create("li","",y),o=G.ui.create("a",n,e.name,r);o.addEventListener("click",function(a){G.ui.Zone_PopupInfoWindow.DenguePestArea.tab=e.id,G.util.each(y.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(b.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+t)[0].classList.add("leaflet-popup-content-sub-content-tab--active")})}),n(),r(),o(),Date.prototype.getWeek=function(){var e=new Date(this.valueOf()),t=(this.getDay()+6)%7;e.setDate(e.getDate()-t+3);var a=e.valueOf();return e.setMonth(0,1),4!=e.getDay()&&e.setMonth(0,1+(4-e.getDay()+7)%7),1+Math.ceil((a-e)/6048e5)},s},G.ui.Zone_PopupInfoWindow.DenguePestArea.tab="mosquito",G.popup.DenguePestVegetablePoint=function(e,t,a){function n(){t.on("popupclose",function(e){e.popup===a&&(d&&t.removeLayer(d),d=null,g&&t.removeLayer(g),g=null,p&&p.length>0&&p.forEach(function(e){t.removeLayer(e)}),p=[]),m={}})}function r(){y.summary.desc=[],y.summary.desc.push(G.ui.create("div","","<b>編號：</b>"+e.NO,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>縣市：</b>"+e.City,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>鄉鎮市區：</b>"+e.District,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>村里：</b>"+e.Village,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>地址/地號：</b>"+e.Address,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>農園名稱：</b>"+e.Description,y.summary)),y.summary.desc.push(G.ui.create("div","","<b>列管原因：</b>"+e.Type,y.summary))}var o=document.createElement("div");o.className="leaflet-popup-content-sub";var i=document.createElement("div");i.className="leaflet-popup-content-sub-header",i.innerHTML="高風險農園";var s=document.createElement("div");s.className="leaflet-popup-content-sub-content",o.appendChild(i),o.appendChild(s);var l=[{id:"summary",name:"摘要"},{id:"area",name:"環域分析"}],c=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",s),u=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",s),d=null,p=[],g=null,m={},h=0,y={};return l.forEach(function(e){h++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==h?" leaflet-popup-content-sub-content-tab--active":"");y[e.id]=G.ui.create("div",n,"",u),y[e.id].id=a;var r="popupTabLink"+(1==h?" is-active":""),o=L.DomUtil.create("li","",c),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.popup.DenguePestVegetablePoint.tab=e.id,G.util.each(c.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(u.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),d&&("area"==G.popup.DenguePestVegetablePoint.tab?d.setStyle({fillOpacity:.2}):d.setStyle({fillOpacity:0})),g&&("area"==G.popup.DenguePestVegetablePoint.tab?g.addTo(t):t.removeLayer(g)),"streetview"==G.popup.DenguePestVegetablePoint.tab&&y.streetview.streetview.visible&&y.streetview.streetview.visible();
})}),G.popup.DenguePestVegetablePoint.tab="summary",n(),r(),o},G.popup.DenguePestVegetablePoint.tab="summary",G.popup.DenguePestVegetablePoint.result_type="個案情形",G.popup.DenguePrevent=function(e,t,a){function n(){t.on("popupclose",function(e){e.popup===a&&(g&&t.removeLayer(g),g=null,h&&t.removeLayer(h),h=null,m&&m.length>0&&m.forEach(function(e){t.removeLayer(e)}),m=[]),y={}})}function r(){C.summary.desc=[],C.summary.desc.push(G.ui.create("div","","<b>噴藥日期：</b>"+new Date(e.DATE).toLocaleDateString(),C.summary)),C.summary.desc.push(G.ui.create("div","","<b>噴藥地點：</b>"+(e.CITY_NAME?e.CITY_NAME:"")+(e.DISTRICT_NAME?e.DISTRICT_NAME:"")+(e.VILLAGE_NAME?e.VILLAGE_NAME:""),C.summary)),C.summary.desc.push(G.ui.create("div","","<b>集合地點：</b>"+(e.SET_TIME?e.SET_TIME:"")+(e.SITE?e.SITE:""),C.summary))}function o(){function a(a){C.area.innerHTML="",C.area.condition=L.DomUtil.create("div","",C.area);G.ui.create("div","","",C.area.condition);n(C.area.condition,a),g&&t.removeLayer(g),g=null,h&&t.removeLayer(h),h=null,y={},g=r(e.GEOMETRY,a.distance).addTo(t),"area"!=G.popup.DenguePrevent.tab&&g.setStyle({fillOpacity:0});var u=new Date(e.DATE),d=new Date(u.getFullYear(),u.getMonth(),u.getDate()-a.date_minus),p=new Date(u.getFullYear(),u.getMonth(),u.getDate()+a.date_bonus),m=g.getBounds();m.xmax=m.getNorthEast().lng,m.ymax=m.getNorthEast().lat,m.xmin=m.getSouthWest().lng,m.ymin=m.getSouthWest().lat;var b=[{lat:f.lat,lng:f.lng}];switch(a.points=b,a.result_type){case"個案情形":g.setStyle({fillColor:"#ff7800"});break;case"醫療院所/醫療資源":g.setStyle({fillColor:"#ff7800"});break;case"最近一次布氏指數":g.setStyle({fillColor:"#000000"});break;case"平均布氏指數":g.setStyle({fillColor:"#000000"})}var v=L.DomUtil.create("div","lmask",C.area);$.ajax({url:"/map/data/dengue/info/prevent/area",async:!0,dataType:"json",type:"POST",data:{xmin:m.xmin,xmax:m.xmax,ymin:m.ymin,ymax:m.ymax,date_start:d,date_end:p,lat:a.lat,lng:a.lng,polygon:JSON.stringify(g.toGeoJSON()),distance:a.distance,result_type:a.result_type}}).done(function(n){switch($(v).remove(),a.result_type){case"個案情形":h=i(n).addTo(t);break;case"醫療院所/醫療資源":h=s(n).addTo(t);break;case"最近一次布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level-e.properties.bi_level:t.properties.bi_hasdata?1:-1}),h=l(n).addTo(t);break;case"平均布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level[0]-e.properties.bi_level[0]:t.properties.bi_hasdata?1:-1}),h=c(n).addTo(t)}switch(h&&("area"==G.popup.DenguePrevent.tab?h.addTo(t):t.removeLayer(h)),C.area.tableDiv=L.DomUtil.create("div","",C.area),C.area.table=L.DomUtil.create("table","table table-striped",C.area.tableDiv),a.result_type){case"個案情形":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(t){var a="";e.REPORT==t.properties.REPORT?a="*":(r++,a=r.toString());var n=G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.REPORT+"</td><td>"+new Date(t.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+t.properties.GENDER_DESC+"</td><td>"+t.properties.SICK_AGE+"</td>",C.area.table.body);e.REPORT==t.properties.REPORT&&(n.style["background-color"]="#FFD27F"),n.id="popupDataTrHover_"+t.properties.REPORT,$(n).mouseover(function(){$(this).addClass("popupDataTrHover"),y[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),$(n).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))})});break;case"醫療院所/醫療資源":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-5">醫療院所名稱</th><th scope="col-md-3">電話</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t=r.toString(),a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.ID+"</td><td>"+e.properties.AKA+"</td><td>"+e.properties.TEL+"</td>",C.area.table.body);a.id="popupDataTrHover_"+e.properties.ID,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"}))})});break;case"最近一次布氏指數":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t;e.properties.bi_hasdata?(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+new Date(e.properties.checkdate).toLocaleDateString()+"</td><td>"+e.properties.bi_level+"</td>",C.area.table.body),t.style["background-color"]=o(e.properties.bi_level)):(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",C.area.table.body),t.style["background-color"]="#ffffff"),t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),y[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"平均布氏指數":C.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',C.area.table),C.area.table.body=L.DomUtil.create("tbody","",C.area.table);var r=0;n.features.forEach(function(e){r++;var t;if(e.properties.bi_hasdata){t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+e.properties.checkdate[0]+"</td><td>"+e.properties.bi_level[0]+"</td>",C.area.table.body),t.style["background-color"]=o(e.properties.bi_level[0]);for(var a=1;a<e.properties.checkdate.length;a++)tr_subdata=G.ui.create("tr","",'<td scope="row"></td><td>'+new Date(e.properties.checkdate[a]).toLocaleDateString()+"</td><td>"+e.properties.bi_level[a]+"</td>",C.area.table.body),tr_subdata.style["background-color"]="lightgray"}else t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",C.area.table.body),t.style["background-color"]="#ffffff";t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),y[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),y[t.id].setStyle({weight:0,fillOpacity:.5})})})}})}function n(e,t){var n="防治日期";switch(t.date_type){case"prevent_date":n="防治日期"}e.innerHTML="",G.ui.create("span","","自 ",e);var r=G.ui.create("a","",n+"-"+t.date_minus+"日▼",e);G.ui.create("span",""," 至 ",e);var o=G.ui.create("a","",n+"+"+t.date_bonus+"日▼",e);G.ui.create("br","","",e),G.ui.create("span",""," 防治範圍 ",e),G.ui.create("br","","",e);var i=G.ui.create("a","",t.distance+"公尺▼",e);G.ui.create("span",""," 環域內 ",e);var s=G.ui.create("a","",t.result_type+"▼",e);G.ui.create("p","","",e),r.addEventListener("click",function(){swal({text:"防治日期往前天數",content:{element:"input",attributes:{type:"number",value:t.date_minus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_minus=parseInt(e),a(t))})}),o.addEventListener("click",function(){swal({text:"防治日期往後天數",content:{element:"input",attributes:{type:"number",value:t.date_bonus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_bonus=parseInt(e),a(t))})}),i.addEventListener("click",function(){swal({text:"距離",content:{element:"input",attributes:{type:"number",value:t.distance,min:1}}}).then(function(e){e&&e.length>0&&(t.distance=parseInt(e),a(t))})}),s.addEventListener("click",function(){var e=document.createElement("select"),n=["個案情形","醫療院所/醫療資源","最近一次布氏指數","平均布氏指數"];n.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)});var r=["化學防治(未開放)","Ovitrap(未開放)"];r.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,a.disabled=!0,e.appendChild(a)}),e.value=t.result_type;var o;$(e).on("change",function(){o=this.value}),swal({text:"環域結果呈現",content:e}).then(function(e){e&&o&&(t.result_type=o,G.popup.DenguePrevent.result_type=o,a(t))})})}function r(e,t,a){var n=turf.buffer(e,t/1e3,{units:"kilometers"}),r=.2,o={stroke:!1,fillColor:"#ff7800",fillOpacity:r};return a&&(o.fillColor=a),new L.geoJson(n,o)}function o(e){var t=["#ffffff","#f4daca","#edae86","#d46d6e"],a=t[0];if(!e||e<0)return a;switch(e){case 0:a=t[0];break;case 1:a=t[1];break;case 2:a=t[2];break;default:a=t[3]}return a}function i(e){y={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.REPORT,r=L.marker(a,{icon:t});return y[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function s(e){y={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.ID,r=L.marker(a,{icon:t});return y[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function l(e){y={};var t=function(e,t){var a=.75,n=.5,r=o(e.properties.bi_level),i={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return i};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;y[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function c(e){y={};var t=function(e,t){var a=.75,n=.5,r=o(e.properties.bi_hasdata?e.properties.bi_level[0]:0),i={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return i};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;y[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}var u={date:new Date(e.DATE),date_type:"prevent_date",date_minus:7,date_bonus:7,lat:f.lat,lng:f.lng,points:[f.lat,f.lng],distance:150,result_type:"個案情形"};G.popup.DenguePrevent.result_type="個案情形",g=r(e.GEOMETRY,u.distance).addTo(t),"area"!=G.popup.DenguePrevent.tab&&g.setStyle({fillOpacity:0}),a(u)}function i(){C.streetview.streetview=L.DomUtil.create("div","",C.streetview),C.streetview.streetview.id="google-street-view",C.streetview.streetview.style.height="270px",$(C.streetview).mouseover(function(){s.dragging&&s.dragging.disable()}),$(C.streetview).mouseout(function(){s.dragging&&s.dragging.enable()});var e=new google.maps.LatLng(f.lat,f.lng),t={heading:270,pitch:0},a=new google.maps.StreetViewPanorama(C.streetview.streetview);a.setOptions({position:e,pov:t}),C.streetview.streetview.visible=function(){a.setVisible(!1),a.setVisible(!0)}}var s=document.createElement("div");s.className="leaflet-popup-content-sub";var l=document.createElement("div");l.className="leaflet-popup-content-sub-header",l.innerHTML="登革熱化學防治";var c=document.createElement("div");c.className="leaflet-popup-content-sub-content",s.appendChild(l),s.appendChild(c);var u=[{id:"summary",name:"摘要"},{id:"area",name:"環域分析"},{id:"streetview",name:"街景"}],d=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",c),p=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",c),g=null,m=[],h=null,y={},b=null,f=null;e.GEOMETRY&&(b=L.geoJson(e.GEOMETRY),f=b.getBounds().getCenter());var v=0,C={};return u.forEach(function(e){v++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==v?" leaflet-popup-content-sub-content-tab--active":"");C[e.id]=G.ui.create("div",n,"",p),C[e.id].id=a;var r="popupTabLink"+(1==v?" is-active":""),o=L.DomUtil.create("li","",d),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.popup.DenguePrevent.tab=e.id,G.util.each(d.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(p.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),g&&("area"==G.popup.DenguePrevent.tab?g.setStyle({fillOpacity:.2}):g.setStyle({fillOpacity:0})),h&&("area"==G.popup.DenguePrevent.tab?h.addTo(t):t.removeLayer(h)),"streetview"==G.popup.DenguePrevent.tab&&C.streetview.streetview.visible&&C.streetview.streetview.visible()})}),G.popup.DenguePrevent.tab="summary",n(),r(),o(),i(),s},G.popup.DenguePrevent.tab="summary",G.popup.DenguePrevent.result_type="個案情形",G.popup.DengueMedical=function(e,t,a){function n(){t.on("popupclose",function(e){e.popup===a&&(m&&t.removeLayer(m),m=null,y&&t.removeLayer(y),y=null,h&&h.length>0&&h.forEach(function(e){t.removeLayer(e)}),h=[]),b={}})}function r(){v.summary.desc=[],v.summary.desc.push(G.ui.create("div","","<b>醫事機構代碼：</b>"+e.ID,v.summary));var t="不詳";switch(e.specialcatrgory){case"1":t="醫學中心";break;case"2":t="區域醫院";break;case"3":t="地區醫院";break;case"4":t="診所";break;case"5":t="藥局";break;case"6":t="居家護理";break;case"7":t="康復之家";break;case"8":t="助產所";break;case"9":t="檢驗所";break;case"A":t="物理治療所";break;case"B":t="特約醫事放射機構";break;case"X":t="不詳"}v.summary.desc.push(G.ui.create("div","","<b>醫療機構診療類別：</b>"+t,v.summary)),v.summary.desc.push(G.ui.create("div","","<b>地址：</b>"+e.ADDRESS,v.summary)),v.summary.desc.push(G.ui.create("div","","<b>電話：</b>"+e.TEL,v.summary))}function o(){v["case"].tableDiv=L.DomUtil.create("div","",v["case"]),v["case"].table=L.DomUtil.create("table","table table-striped",v["case"].tableDiv),v["case"].table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',v["case"].table),v["case"].table.body=L.DomUtil.create("tbody","",v["case"].table);var t=0;e.cases.forEach(function(e){t++;var a=t.toString();G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+e.REPORT+"</td><td>"+new Date(e.SICK_DATE).toLocaleDateString()+"</td><td>"+e.GENDER_DESC+"</td><td>"+e.SICK_AGE+"</td>",v["case"].table.body)})}function i(){function a(a){v.area.innerHTML="",v.area.condition=L.DomUtil.create("div","",v.area);G.ui.create("div","","",v.area.condition);n(v.area.condition,a);var o=new Date(e.SICK_DATE),i=new Date(o.getFullYear(),o.getMonth(),o.getDate()-a.date_minus),g=new Date(o.getFullYear(),o.getMonth(),o.getDate()+a.date_bonus),h=r(e.lat,e.lon,a.distance),f=[{lat:e.lat,lng:e.lon}];if("所有關聯點位"==a.point_type&&C)for(var D=0;D<C.data.length;D++)if(C.data[D]&&C.data[D].lat&&C.data[D].lon){f.push({lat:C.data[D].lat,lng:C.data[D].lon});var x=r(C.data[D].lat,C.data[D].lon,a.distance);h.xmin>x.xmin&&(h.xmin=x.xmin),h.ymin>x.ymin&&(h.ymin=x.ymin),h.xmax<x.xmax&&(h.xmax=x.xmax),h.ymax<x.ymax&&(h.ymax=x.ymax)}switch(a.points=f,m&&t.removeLayer(m),m=null,y&&t.removeLayer(y),y=null,b={},m=s(f,a.distance).addTo(t),"area"!=G.popup.DengueMedical.tab&&m.setStyle({fillOpacity:0}),a.result_type){case"個案情形":m.setStyle({fillColor:"#ff7800"});break;case"醫療院所/醫療資源":m.setStyle({fillColor:"#ff7800"});break;case"最近一次布氏指數":m.setStyle({fillColor:"#000000"});break;case"平均布氏指數":m.setStyle({fillColor:"#000000"})}var _=L.DomUtil.create("div","lmask",v.area);$.ajax({url:"/map/data/dengue/info/case/area",async:!0,dataType:"json",type:"POST",data:{xmin:h.xmin,xmax:h.xmax,ymin:h.ymin,ymax:h.ymax,date_start:i,date_end:g,lat:a.lat,lng:a.lng,points:JSON.stringify(a.points),distance:a.distance,point_type:a.point_type,result_type:a.result_type}}).done(function(n){switch($(_).remove(),a.result_type){case"個案情形":y=c(n).addTo(t);break;case"醫療院所/醫療資源":y=u(n).addTo(t);break;case"最近一次布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level-e.properties.bi_level:t.properties.bi_hasdata?1:-1}),y=d(n).addTo(t);break;case"平均布氏指數":n.features.sort(function(e,t){return e.properties.bi_hasdata&&t.properties.bi_hasdata?t.properties.bi_level[0]-e.properties.bi_level[0]:t.properties.bi_hasdata?1:-1}),y=p(n).addTo(t)}switch(y&&("area"==G.popup.DengueMedical.tab?y.addTo(t):t.removeLayer(y)),v.area.tableDiv=L.DomUtil.create("div","",v.area),v.area.table=L.DomUtil.create("table","table table-striped",v.area.tableDiv),a.result_type){case"個案情形":v.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-4">法傳編號</th><th scope="col-md-3">發病日</th><th scope="col-md-2">性別</th><th scope="col-md-2">年齡</th></tr>',v.area.table),v.area.table.body=L.DomUtil.create("tbody","",v.area.table);var r=0;n.features.forEach(function(t){var a="";e.REPORT==t.properties.REPORT?a="*":(r++,a=r.toString());var n=G.ui.create("tr","",'<td scope="row">'+a+"</td><td>"+t.properties.REPORT+"</td><td>"+new Date(t.properties.SICK_DATE).toLocaleDateString()+"</td><td>"+t.properties.GENDER_DESC+"</td><td>"+t.properties.SICK_AGE+"</td>",v.area.table.body);e.REPORT==t.properties.REPORT&&(n.style["background-color"]="#FFD27F"),n.id="popupDataTrHover_"+t.properties.REPORT,$(n).mouseover(function(){$(this).addClass("popupDataTrHover"),b[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),$(n).mouseleave(function(){$(this).removeClass("popupDataTrHover"),b[n.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))})});break;case"醫療院所/醫療資源":v.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-1">#</th><th scope="col-md-3">十碼章</th><th scope="col-md-5">醫療院所名稱</th><th scope="col-md-3">電話</th></tr>',v.area.table),v.area.table.body=L.DomUtil.create("tbody","",v.area.table);var r=0;n.features.forEach(function(e){r++;var t=r.toString(),a=G.ui.create("tr","",'<td scope="row">'+t+"</td><td>"+e.properties.ID+"</td><td>"+e.properties.AKA+"</td><td>"+e.properties.TEL+"</td>",v.area.table.body);a.id="popupDataTrHover_"+e.properties.ID,$(a).mouseover(function(){$(this).addClass("popupDataTrHover"),b[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"}))}),$(a).mouseleave(function(){$(this).removeClass("popupDataTrHover"),b[a.id].setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"}))})});break;case"最近一次布氏指數":v.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',v.area.table),v.area.table.body=L.DomUtil.create("tbody","",v.area.table);var r=0;n.features.forEach(function(e){r++;var t;e.properties.bi_hasdata?(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+new Date(e.properties.checkdate).toLocaleDateString()+"</td><td>"+e.properties.bi_level+"</td>",v.area.table.body),t.style["background-color"]=l(e.properties.bi_level)):(t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",v.area.table.body),t.style["background-color"]="#ffffff"),t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),b[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),b[t.id].setStyle({weight:0,fillOpacity:.5})})});break;case"平均布氏指數":v.area.table.head=G.ui.create("thead","",'<tr><th scope="col-md-4">村里名稱</th><th scope="col-md-4">調查日期</th><th scope="col-md-4">布氏指數級數</th></tr>',v.area.table),v.area.table.body=L.DomUtil.create("tbody","",v.area.table);var r=0;n.features.forEach(function(e){r++;var t;if(e.properties.bi_hasdata){t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>"+e.properties.checkdate[0]+"</td><td>"+e.properties.bi_level[0]+"</td>",v.area.table.body),t.style["background-color"]=l(e.properties.bi_level[0]);for(var a=1;a<e.properties.checkdate.length;a++)tr_subdata=G.ui.create("tr","",'<td scope="row"></td><td>'+new Date(e.properties.checkdate[a]).toLocaleDateString()+"</td><td>"+e.properties.bi_level[a]+"</td>",v.area.table.body),tr_subdata.style["background-color"]="lightgray"}else t=G.ui.create("tr","",'<td scope="row">'+e.properties.VILLNAME+"</td><td>無資料</td><td>無資料</td>",v.area.table.body),t.style["background-color"]="#ffffff";t.id="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME,$(t).mouseover(function(){$(this).addClass("popupDataTrHover"),b[t.id].setStyle({weight:5,fillOpacity:.75})}),$(t).mouseleave(function(){$(this).removeClass("popupDataTrHover"),b[t.id].setStyle({weight:0,fillOpacity:.5})})})}})}function n(e,t){var n="發病日";switch(t.date_type){case"sick_date":n="發病日"}e.innerHTML="",G.ui.create("span","","自 ",e);var r=G.ui.create("a","",n+"-"+t.date_minus+"日▼",e);G.ui.create("span",""," 至 ",e);var o=G.ui.create("a","",n+"+"+t.date_bonus+"日▼",e);G.ui.create("br","","",e),G.ui.create("span",""," 此醫療院所 ",e);var i=G.ui.create("a","",t.distance+"公尺▼",e);G.ui.create("span",""," 環域內 ",e);var s=G.ui.create("a","",t.result_type+"▼",e);G.ui.create("p","","",e),r.addEventListener("click",function(){swal({text:"發病日往前天數",content:{element:"input",attributes:{type:"number",value:t.date_minus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_minus=parseInt(e),a(t))})}),o.addEventListener("click",function(){swal({text:"發病日往後天數",content:{element:"input",attributes:{type:"number",value:t.date_bonus,min:1}}}).then(function(e){e&&e.length>0&&(t.date_bonus=parseInt(e),a(t))})}),i.addEventListener("click",function(){swal({text:"距離",content:{element:"input",attributes:{type:"number",value:t.distance,min:1}}}).then(function(e){e&&e.length>0&&(t.distance=parseInt(e),a(t))})}),s.addEventListener("click",function(){var e=document.createElement("select"),n=["個案情形","醫療院所/醫療資源","最近一次布氏指數","平均布氏指數"];n.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,e.appendChild(a)});var r=["化學防治(未開放)","Ovitrap(未開放)"];r.forEach(function(t){var a=document.createElement("option");a.value=t,a.innerHTML=t,a.disabled=!0,e.appendChild(a)}),e.value=t.result_type;var o;$(e).on("change",function(){o=this.value}),swal({text:"環域結果呈現",content:e}).then(function(e){e&&o&&(t.result_type=o,G.popup.DengueMedical.result_type=o,a(t))})})}function r(e,t,a){var n=turf.point([t,e]),r={units:"kilometers"},o=turf.destination(n,a/1e3,0,r),i=turf.destination(n,a/1e3,90,r),s=turf.destination(n,a/1e3,180,r),l=turf.destination(n,a/1e3,270,r),c=o.geometry.coordinates[1],u=i.geometry.coordinates[0],d=s.geometry.coordinates[1],p=l.geometry.coordinates[0];return{xmin:p,xmax:u,ymin:d,ymax:c}}function o(e,t,a){var n=[t,e],r=a/1e3,o={steps:256,units:"kilometers",properties:{}};return turf.circle(n,r,o)}function i(e,t,a,n){var r=o(e,t,a),i=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:i};return n&&(s.fillColor=n),new L.geoJson(r,s)}function s(e,t,a){var n=[];e.forEach(function(e){n.push(o(e.lat,e.lng,t))});for(var r=1;r<n.length;r++)n[0]=turf.union(n[0],n[r]);var i=.2,s={stroke:!1,fillColor:"#ff7800",fillOpacity:i};return a&&(s.fillColor=a),new L.geoJson(n[0],s)}function l(e){var t=["#ffffff","#f4daca","#edae86","#d46d6e"],a=t[0];if(!e||e<0)return a;switch(e){case 0:a=t[0];break;case 1:a=t[1];break;case 2:a=t[2];break;default:a=t[3]}return a}function c(e){b={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.REPORT,r=L.marker(a,{icon:t});return b[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function u(e){b={};var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n="popupDataTrHover_"+e.properties.ID,r=L.marker(a,{icon:t});return b[n]=r,r.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital_highlight.png"})),$("#"+n).addClass("popupDataTrHover")}),r.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_hospital.png"})),$("#"+n).removeClass("popupDataTrHover")}),r}})}function d(e){b={};var t=function(e,t){var a=.75,n=.5,r=l(e.properties.bi_level),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;b[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}function p(e){b={};var t=function(e,t){var a=.75,n=.5,r=l(e.properties.bi_hasdata?e.properties.bi_level[0]:0),o={stroke:!0,color:r,weight:0,opacity:a,fillColor:r,fillOpacity:n};return o};return new L.geoJson(e,{style:t,onEachFeature:function(e,t){var a="popupDataTrHover_"+e.properties.COUNTYNAME+e.properties.TOWNNAME+e.properties.VILLNAME;b[a]=t,t.on("mouseover",function(e){t.setStyle({weight:5,fillOpacity:.75}),$("#"+a).addClass("popupDataTrHover")}),t.on("mouseout",function(e){t.setStyle({weight:0,fillOpacity:.5}),$("#"+a).removeClass("popupDataTrHover")})}})}e.SICK_DATE=new Date;var g={date:new Date(e.SICK_DATE),date_type:"sick_date",date_minus:7,date_bonus:7,lat:e.lat,lng:e.lon,points:[e.lat,e.lon],distance:150,point_type:"居住地點位",result_type:"個案情形"};G.popup.DengueMedical.result_type="個案情形",m=i(e.lat,e.lon,g.distance).addTo(t),"area"!=G.popup.DengueMedical.tab&&m.setStyle({fillOpacity:0}),a(g)}function s(){v.streetview.streetview=L.DomUtil.create("div","",v.streetview),v.streetview.streetview.id="google-street-view",v.streetview.streetview.style.height="270px",$(v.streetview).mouseover(function(){l.dragging&&l.dragging.disable()}),$(v.streetview).mouseout(function(){l.dragging&&l.dragging.enable()});var t=new google.maps.LatLng(e.lat,e.lon),a={heading:270,pitch:0},n=new google.maps.StreetViewPanorama(v.streetview.streetview);n.setOptions({position:t,pov:a}),v.streetview.streetview.visible=function(){n.setVisible(!1),n.setVisible(!0)}}var l=document.createElement("div");l.className="leaflet-popup-content-sub";var c=document.createElement("div");c.className="leaflet-popup-content-sub-header",c.innerHTML="醫療院所";var u=document.createElement("div");u.className="leaflet-popup-content-sub-content",c.invisible=G.ui.create("input","","透明化",c),c.invisible.type="checkbox",c.invisible.checked=!1,c.invisible.style.position="fixed",c.invisible.style.right="30px",c.invisible.style.top="10px",$(c.invisible).click(function(){$(c.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),l.appendChild(c),l.appendChild(u);var d=[{id:"summary",name:"摘要"},{id:"report",name:"通報統計"},{id:"case",name:"個案"},{id:"area",name:"環域分析"},{id:"streetview",name:"街景"}],p=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",u),g=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",u),m=null,h=[],y=null,b={},f=0,v={},C=null;return d.forEach(function(e){f++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==f?" leaflet-popup-content-sub-content-tab--active":"");v[e.id]=G.ui.create("div",n,"",g),v[e.id].id=a;var r="popupTabLink"+(1==f?" is-active":""),o=L.DomUtil.create("li","",p),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.popup.DengueMedical.tab=e.id,G.util.each(p.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(g.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),m&&("area"==G.popup.DengueMedical.tab?m.setStyle({fillOpacity:.2}):m.setStyle({fillOpacity:0})),y&&("area"==G.popup.DengueMedical.tab?y.addTo(t):t.removeLayer(y)),"streetview"==G.popup.DengueMedical.tab&&v.streetview.streetview.visible&&v.streetview.streetview.visible()})}),G.popup.DengueMedical.tab="summary",n(),r(),o(),i(),s(),l},G.popup.DengueMedical.tab="summary",G.popup.DengueMedical.result_type="個案情形",G.ui.PopupInfoWindow.MeaslesCase=function(e,t,a){function n(){switch(h&&t.removeLayer(h),y&&t.removeLayer(y),G.ui.PopupInfoWindow.MeaslesCase.tab){case"geo":y&&y.addTo(t);break;case"contact":h&&h.addTo(t)}}function r(){var t=!1;!User.regional||User.city==e.RESIDENCE_COUNTY_NAME&&User.dist==e.RESIDENCE_TOWN_NAME||(t=!0),f.summary.desc=[],f.summary.desc.push(G.ui.create("div","","<b>法傳編號：</b>"+e.REPORT+" ("+e.DETERMINED_STATUS_DESC+")",f.summary)),f.summary.desc.push(G.ui.create("div","","<b>性別：</b>"+e.GENDER_DESC,f.summary)),f.summary.desc.push(G.ui.create("div","","<b>發病年齡：</b>"+e.SICK_AGE,f.summary)),f.summary.desc.push(G.ui.create("div","","<b>發病日：</b>"+new Date(e.SICK_DATE).toLocaleDateString(),f.summary)),f.summary.desc.push(G.ui.create("div","","<b>報告日：</b>"+new Date(e.REPORT_DATE).toLocaleDateString(),f.summary)),f.summary.desc.push(G.ui.create("div","","<b>診斷日：</b>"+new Date(e.DIAGNOSE_DATE).toLocaleDateString(),f.summary));var a="<b>境外移入：</b>";a+="0"==e.IMMIGRATION?"否":"是","1"==e.IMMIGRATION&&(a+=e.INFECTED_COUNTRY_NAME&&e.INFECTED_COUNTRY_NAME.length>0?" ("+e.INFECTED_COUNTRY_NAME+")":"未註明"),f.summary.desc.push(G.ui.create("div","","<b>居住地址：</b>"+(e.RESIDENCE_COUNTY_NAME?e.RESIDENCE_COUNTY_NAME:"[缺縣市]")+(e.RESIDENCE_TOWN_NAME?e.RESIDENCE_TOWN_NAME:"[缺鄉鎮市區]")+(e.RESIDENCE_VILLAGE_NAME?e.RESIDENCE_VILLAGE_NAME:"[缺村里]")+(e.ADDRESS?e.ADDRESS:""),f.summary)),f.summary.desc.push(G.ui.create("div","",a,f.summary));var n=L.DomUtil.create("div","lmask",f.summary);$.ajax({url:"/map/data/measles/info/case/summary",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT}}).done(function(e){$(n).remove(),e&&e.report_first?f.summary.desc.push(G.ui.create("div","","<b>群聚編號：</b>"+e.report_first,f.summary)):f.summary.desc.push(G.ui.create("div","","<b>群聚編號：</b>無群聚",f.summary))})}function o(){function r(e){return L.geoJson(e,{pointToLayer:function(e,t){function a(e){var t=20;return e>50&&(e=50),t+=30*(e/50)}var n=(String(e.properties.place),parseInt(e.properties.count)),r=a(n),o=$("<div/>").text(n).css({width:r+"px",height:r+"px","margin-left":-(r/2)+"px","margin-top":-(r/2)+"px","border-radius":r/2+"px",border:"2px solid #FF0000","text-align":"center",background:"rgba(255,255,255,0.5)",color:"#000000","font-size":"12px","font-weight":"bold","line-height":r+"px"}),i=L.marker(t,{
icon:L.divIcon({className:"ttaafasdf",html:o.prop("outerHTML")})});return i}})}t.on("popupclose",function(e){e.popup===a&&y&&t.removeLayer(y),y=null}),y&&t.removeLayer(y),y=null;var o=L.DomUtil.create("div","lmask",f.geo);$.ajax({url:"/map/data/measles/info/case/geo",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT}}).done(function(a){$(o).remove();var i="";a&&a.geojson&&(y=r(a.geojson),y.addTo(t),a.geojson.features.forEach(function(e){i+="<label>"+e.properties.place+"("+e.properties.count+"人)</label><br/>",i+=e.properties.address+"<br/>"})),n(),f.geo.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked="false"><span>顯示所有點位</span></label>',f.geo);var s=(e.RESIDENCE_COUNTY_NAME?e.RESIDENCE_COUNTY_NAME:"")+(e.RESIDENCE_TOWN_NAME?e.RESIDENCE_TOWN_NAME:"")+(e.RESIDENCE_VILLAGE_NAME?e.RESIDENCE_VILLAGE_NAME:"")+(e.ADDRESS?e.ADDRESS:"");G.ui.create("div","","<label>居住地：</label>",f.geo),G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+s+"</span></label>",f.geo),G.ui.create("div","","<label>接觸地：</label>",f.geo),G.ui.create("div","",i,f.geo)})}function i(){$.ajax({url:"/map/data/measles/info/case/hospital",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT}}).done(function(e){f.hospital.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>顯示所有點位</span></label>',f.hospital),G.ui.create("div","","<label>通報醫院：</label>",f.hospital),e.data&&1==e.data.length&&e.data[0].NAME?G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+e.data[0].NAME+"</span></label>",f.hospital):G.ui.create("div","","無資料",f.hospital),G.ui.create("div","","<label>就醫歷程：</label>",f.hospital),G.ui.create("div","","無資料",f.hospital)})}function s(){function r(e){var t=new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"});return L.geoJson(e,{pointToLayer:function(e,a){var n=L.marker(a,{icon:t});return n.on("mouseover",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person_highlight.png"}))}),n.on("mouseout",function(e){this.setIcon(new L.Icon({iconSize:[18,18],iconUrl:"/map/images/icon/icon_person.png"}))}),n}})}t.on("popupclose",function(e){e.popup===a&&h&&t.removeLayer(h),h=null}),h&&t.removeLayer(h),h=null;var o=L.DomUtil.create("div","lmask",f.contact);$.ajax({url:"/map/data/measles/info/case/contact",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT,county:e.RESIDENCE_COUNTY_NAME}}).done(function(e){if($(o).remove(),f.contact.desc=[],e&&e.count){f.contact.desc.push(G.ui.create("div","","<b>接觸者人數：</b>"+e.count.contact_count,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>有症狀人數：</b>"+e.count.contact_situation,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>高風險族群：</b>"+e.count.contact_risk,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>監測中人數：</b>"+e.count.contact_watch,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>1歲以下/IMIG施打人數：</b>"+e.count.contact_imig_total+"/"+e.count.contact_imig,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>1-6歲/MMR施打人數：</b>"+e.count.contact_mmr_total+"/"+e.count.contact_mmr,f.contact)),f.contact.desc.push(G.ui.create("div","","<b>監測截止日：</b>"+new Date(e.count.last_watch).toLocaleDateString(),f.contact));var a="";e.count.watch_main.forEach(function(e){a+=0==a.length?e:","+e}),f.contact.desc.push(G.ui.create("div","","<b>主辦單位：</b>"+a,f.contact));var i="";e.count.watch_sub.forEach(function(e){e&&"undefined"!=e&&(i+=0==i.length?e:","+e)}),f.contact.desc.push(G.ui.create("div","","<b>協辦單位：</b>"+i,f.contact))}else f.contact.desc.push(G.ui.create("div","","<b>無接觸者資料</b>",f.contact));e&&e.geojson&&(h=r(e.geojson).addTo(t)),n()})}function l(){var t=L.DomUtil.create("div","lmask",f.cluster);$.ajax({url:"/map/data/measles/info/case/cluster",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT,county:e.RESIDENCE_COUNTY_NAME}}).done(function(e){if($(t).remove(),f.cluster.desc=[],e&&e.event){if(f.cluster.desc.push(G.ui.create("div","","<b>事件名稱：</b>"+e.event.case_name,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>首例發病日：</b>"+new Date(e.event.sickdate_first).toLocaleDateString(),f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>末例發病日：</b>"+new Date(e.event.sickdate_last).toLocaleDateString(),f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>病例數：</b>"+e.event.case_count,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>行政區：</b>"+e.event.residence_city,f.cluster)),e&&e.count){f.cluster.desc.push(G.ui.create("div","","<b>接觸者人數：</b>"+e.count.contact_count,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>有症狀人數：</b>"+e.count.contact_situation,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>高風險族群：</b>"+e.count.contact_risk,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>監測中人數：</b>"+e.count.contact_watch,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>1歲以下/IMIG施打人數：</b>"+e.count.contact_imig_total+"/"+e.count.contact_imig,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>1-6歲/MMR施打人數：</b>"+e.count.contact_mmr_total+"/"+e.count.contact_mmr,f.cluster)),f.cluster.desc.push(G.ui.create("div","","<b>監測截止日：</b>"+new Date(e.count.last_watch).toLocaleDateString(),f.cluster));var a="";e.count.watch_main.forEach(function(e){a+=0==a.length?e:","+e}),f.cluster.desc.push(G.ui.create("div","","<b>主辦單位：</b>"+a,f.cluster));var n="";e.count.watch_sub.forEach(function(e){e&&"undefined"!=e&&(n+=0==n.length?e:","+e)}),f.cluster.desc.push(G.ui.create("div","","<b>協辦單位：</b>"+n,f.cluster))}else f.cluster.desc.push(G.ui.create("div","","<b>無接觸者資料</b>",f.cluster));e.event.report_first&&e.event.report_first.length>0?f.cluster.desc.push(G.ui.create("div","","<b>指標個案：</b>"+e.event.report_first,f.cluster)):f.cluster.desc.push(G.ui.create("div","","<b>指標個案：</b>無",f.cluster))}else f.cluster.desc.push(G.ui.create("div","","<b>無群聚資料</b>",f.cluster))})}var c=document.createElement("div");c.className="leaflet-popup-content-sub";var u=document.createElement("div");u.className="leaflet-popup-content-sub-header",u.innerHTML="麻疹個案";var d=document.createElement("div");d.className="leaflet-popup-content-sub-content",u.invisible=G.ui.create("input","","透明化",u),u.invisible.type="checkbox",u.invisible.checked=!1,u.invisible.style.position="fixed",u.invisible.style.right="30px",u.invisible.style.top="10px",$(u.invisible).click(function(){$(u.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),c.appendChild(u),c.appendChild(d);var p=[{id:"summary",name:"摘要"},{id:"geo",name:"地理資訊"},{id:"hospital",name:"就醫"},{id:"contact",name:"接觸者"},{id:"cluster",name:"群聚"}],g=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",d),m=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",d),h=null,y=null,b=0,f={};return p.forEach(function(e){b++;var t="content-tab-"+e.id,a="leaflet-popup-content-sub-content-tab"+(1==b?" leaflet-popup-content-sub-content-tab--active":"");f[e.id]=G.ui.create("div",a,"",m),f[e.id].id=t;var r="popupTabLink"+(1==b?" is-active":""),o=L.DomUtil.create("li","",g),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(a){G.ui.PopupInfoWindow.MeaslesCase.tab=e.id,G.util.each(g.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(m.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+t)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),n()})}),G.ui.PopupInfoWindow.MeaslesCase.tab="summary",r(),o(),i(),s(),l(),c},G.ui.PopupInfoWindow.MeaslesCase.tab="summary",G.ui.PopupInfoWindow.MeaslesCase.result_type="個案情形",G.ui.PopupInfoWindow.MeaslesCluster=function(e,t,a){function n(){var t=!1;!User.regional||User.city==e.RESIDENCE_COUNTY_NAME&&User.dist==e.RESIDENCE_TOWN_NAME||(t=!0),h.summary.desc=[],h.summary.desc.push(G.ui.create("div","","<b>法傳編號：</b>"+e.REPORT+" ("+e.DETERMINED_STATUS_DESC+")",h.summary)),h.summary.desc.push(G.ui.create("div","","<b>發病日：</b>"+new Date(e.SICK_DATE).toLocaleDateString(),h.summary)),h.summary.desc.push(G.ui.create("div","","<b>報告日：</b>"+new Date(e.REPORT_DATE).toLocaleDateString(),h.summary)),h.summary.desc.push(G.ui.create("div","","<b>診斷日：</b>"+new Date(e.DIAGNOSE_DATE).toLocaleDateString(),h.summary)),h.summary.desc.push(G.ui.create("div","","<b>性別：</b>"+e.GENDER_DESC,h.summary)),h.summary.desc.push(G.ui.create("div","","<b>發病年齡：</b>"+e.SICK_AGE,h.summary)),h.summary.desc.push(G.ui.create("div","","<b>居住地址：</b>"+e.RESIDENCE_COUNTY_NAME+e.RESIDENCE_TOWN_NAME+e.RESIDENCE_VILLAGE_NAME+e.ADDRESS,h.summary));var a="<b>境外移入：</b>";a+="0"==e.IMMIGRATION?"否":"是","1"==e.IMMIGRATION&&(a+=e.INFECTED_COUNTRY_NAME&&e.INFECTED_COUNTRY_NAME.length>0?" ("+e.INFECTED_COUNTRY_NAME+")":"未註明"),h.summary.desc.push(G.ui.create("div","",a,h.summary)),h.summary.desc.push(G.ui.create("div","","<b>群聚編號：</b>",h.summary))}function r(){h.geo.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked="false"><span>顯示所有點位</span></label>',h.geo);var t=(e.RESIDENCE_COUNTY_NAME?e.RESIDENCE_COUNTY_NAME:"")+(e.RESIDENCE_TOWN_NAME?e.RESIDENCE_TOWN_NAME:"")+(e.RESIDENCE_VILLAGE_NAME?e.RESIDENCE_VILLAGE_NAME:"")+(e.ADDRESS?e.ADDRESS:"");G.ui.create("div","","<label>居住地：</label>",h.geo),G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+t+"</span></label>",h.geo),G.ui.create("div","","<label>工作/就學：</label>",h.geo),G.ui.create("div","","無資料",h.geo),G.ui.create("div","","<label>活動點：</label>",h.geo),G.ui.create("div","","無資料",h.geo)}function o(){$.ajax({url:"/map/data/dengue/info/case/hospital",async:!0,dataType:"json",type:"POST",data:{report:e.REPORT}}).done(function(e){h.hospital.checkAll=G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>顯示所有點位</span></label>',h.hospital),G.ui.create("div","","<label>通報醫院：</label>",h.hospital),e.data&&1==e.data.length&&e.data[0].NAME?G.ui.create("div","form-check",'<label class="form-check-label form-check-toggle"><input class="form-check-input" type="checkbox" checked=false><span>'+e.data[0].NAME+"</span></label>",h.hospital):G.ui.create("div","","無資料",h.hospital),G.ui.create("div","","<label>就醫歷程：</label>",h.hospital),G.ui.create("div","","無資料",h.hospital)})}var i=document.createElement("div");i.className="leaflet-popup-content-sub";var s=document.createElement("div");s.className="leaflet-popup-content-sub-header",s.innerHTML="麻疹個案";var l=document.createElement("div");l.className="leaflet-popup-content-sub-content",s.invisible=G.ui.create("input","","透明化",s),s.invisible.type="checkbox",s.invisible.checked=!1,s.invisible.style.position="fixed",s.invisible.style.right="30px",s.invisible.style.top="10px",$(s.invisible).click(function(){$(s.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),i.appendChild(s),i.appendChild(l);var c=[{id:"summary",name:"摘要"},{id:"geo",name:"地理資訊"},{id:"hospital",name:"就醫"},{id:"contact",name:"接觸者"},{id:"cluster",name:"群聚"}],u=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",l),d=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",l),p=null,g=null,m=0,h={};return c.forEach(function(e){m++;var a="content-tab-"+e.id,n="leaflet-popup-content-sub-content-tab"+(1==m?" leaflet-popup-content-sub-content-tab--active":"");h[e.id]=G.ui.create("div",n,"",d),h[e.id].id=a;var r="popupTabLink"+(1==m?" is-active":""),o=L.DomUtil.create("li","",u),i=G.ui.create("a",r,e.name,o);i.addEventListener("click",function(n){G.ui.PopupInfoWindow.MeaslesCase.tab=e.id,G.util.each(u.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(d.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+a)[0].classList.add("leaflet-popup-content-sub-content-tab--active"),p&&("area"==G.ui.PopupInfoWindow.MeaslesCase.tab?p.setStyle({fillOpacity:.2}):p.setStyle({fillOpacity:0})),g&&("area"==G.ui.Zone_PopupInfoWindow.MeaslesCluster.tab?g.addTo(t):t.removeLayer(g))})}),G.ui.PopupInfoWindow.MeaslesCase.tab="summary",n(),r(),o(),i},G.ui.PopupInfoWindow.MeaslesCluster.tab="summary",G.ui.PopupInfoWindow.MeaslesCluster.result_type="個案情形",G.ui.PopupInfoWindow.MeaslesContact=function(e,t,a){function n(){}var r=document.createElement("div");r.className="leaflet-popup-content-sub";var o=document.createElement("div");o.className="leaflet-popup-content-sub-header",o.innerHTML="接觸者資訊";var i=document.createElement("div");i.className="leaflet-popup-content-sub-content",o.invisible=G.ui.create("input","","透明化",o),o.invisible.type="checkbox",o.invisible.checked=!1,o.invisible.style.position="fixed",o.invisible.style.right="30px",o.invisible.style.top="10px",$(o.invisible).click(function(){$(o.invisible).prop("checked")?$(".leaflet-popup").fadeTo("fast",.3,function(){}):$(".leaflet-popup").fadeTo("fast",1,function(){})}),r.appendChild(o),r.appendChild(i);var s=[{id:"summary",name:"摘要"}],l=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",i),c=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",i),u=0,d={};return s.forEach(function(e){u++;var t="content-tab-"+e.id,a="leaflet-popup-content-sub-content-tab"+(1==u?" leaflet-popup-content-sub-content-tab--active":"");d[e.id]=G.ui.create("div",a,"",c),d[e.id].id=t;var n="popupTabLink"+(1==u?" is-active":""),r=L.DomUtil.create("li","",l),o=G.ui.create("a",n,e.name,r);o.addEventListener("click",function(a){G.ui.PopupInfoWindow.MeaslesContact.tab=e.id,G.util.each(l.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(c.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+t)[0].classList.add("leaflet-popup-content-sub-content-tab--active")})}),G.ui.PopupInfoWindow.MeaslesContact.tab="summary",n(),r},G.ui.PopupInfoWindow.MeaslesContact.tab="summary",G.ui.PopupInfoWindow.MeaslesContact.result_type="個案情形",G.ui.PopupInfoWindow.MeaslesContactArea=function(e,t,a){function n(){b.summary.desc=[],"MeaslesClusterContactAreaCity"!=G.ui.PopupInfoWindow.type&&"MeaslesClusterContactAreaDist"!=G.ui.PopupInfoWindow.type||b.summary.desc.push(G.ui.create("div","","<b>個案人數：</b>"+i,b.summary)),b.summary.desc.push(G.ui.create("div","","<b>接觸者人數：</b>"+s,b.summary))}var r=document.createElement("div");r.className="leaflet-popup-content-sub";var o=document.createElement("div");o.className="leaflet-popup-content-sub-header",o.innerHTML="接觸者病例數圖資訊";var i=0,s=0;switch(G.ui.PopupInfoWindow.type){case"MeaslesClusterContactAreaCity":var l=e.COUNTY,c=G.geo.tile.geojsons.MeaslesCluster;c.features.forEach(function(e){e.properties.RESIDENCE_COUNTY_NAME&&e.properties.RESIDENCE_COUNTY_NAME==l&&i++});var u=G.geo.tile.geojsons.MeaslesClusterContact;u.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME&&e.properties.RESIDENTIAL_COUNTY_NAME==l&&s++});break;case"MeaslesContactAreaCity":var l=e.COUNTY,u=G.geo.tile.geojsons.MeaslesContact;u.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME&&e.properties.RESIDENTIAL_COUNTY_NAME==l&&s++});break;case"MeaslesClusterContactAreaDist":var l=e.COUNTY,d=e.TOWN,c=G.geo.tile.geojsons.MeaslesCluster;c.features.forEach(function(e){e.properties.RESIDENCE_COUNTY_NAME&&e.properties.RESIDENCE_COUNTY_NAME==l&&e.properties.RESIDENCE_TOWN_NAME&&e.properties.RESIDENCE_TOWN_NAME==d&&i++});var u=G.geo.tile.geojsons.MeaslesClusterContact;u.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME&&e.properties.RESIDENTIAL_COUNTY_NAME==l&&e.properties.RESIDENTIAL_TOWN_NAME&&e.properties.RESIDENTIAL_TOWN_NAME==d&&s++});break;case"MeaslesContactAreaDist":var l=e.COUNTY,d=e.TOWN,u=G.geo.tile.geojsons.MeaslesContact;u.features.forEach(function(e){e.properties.RESIDENTIAL_COUNTY_NAME&&e.properties.RESIDENTIAL_COUNTY_NAME==l&&e.properties.RESIDENTIAL_TOWN_NAME&&e.properties.RESIDENTIAL_TOWN_NAME==d&&s++})}var p=document.createElement("div");p.className="leaflet-popup-content-sub-content",r.appendChild(o),r.appendChild(p);var g=[{id:"summary",name:"摘要"}],m=L.DomUtil.create("ul","leaflet-popup-content-sub-content-tabs",p),h=L.DomUtil.create("div","leaflet-popup-content-sub-content-container",p),y=0,b={};return g.forEach(function(e){y++;var t="content-tab-"+e.id,a="leaflet-popup-content-sub-content-tab"+(1==y?" leaflet-popup-content-sub-content-tab--active":"");b[e.id]=G.ui.create("div",a,"",h),b[e.id].id=t;var n="popupTabLink"+(1==y?" is-active":""),r=L.DomUtil.create("li","",m),o=G.ui.create("a",n,e.name,r);o.addEventListener("click",function(a){G.ui.PopupInfoWindow.MeaslesContact.tab=e.id,G.util.each(m.querySelectorAll(".popupTabLink"),function(e){e.classList.remove("is-active")}),this.classList.add("is-active"),G.util.each(h.querySelectorAll(".leaflet-popup-content-sub-content-tab"),function(e){e.classList.remove("leaflet-popup-content-sub-content-tab--active")}),$("#"+t)[0].classList.add("leaflet-popup-content-sub-content-tab--active")})}),G.ui.PopupInfoWindow.MeaslesContactArea.tab="summary",n(),r},G.ui.PopupInfoWindow.MeaslesContactArea.tab="summary",G.ui.PopupInfoWindow.MeaslesContactArea.result_type="個案情形",G.Map=function(e,t){var a=L.map(e,t);G.map=a;var n=a.getContainer();a.attributionControl.setPrefix('<a href="http://www.cdc.gov.tw/Professional/page.aspx?nowtreeid=22103848C7E68D2D&treeid=22103848C7E68D2D" target="_blank">'+LanguageValue.CopyRight+'</a> | Powered by <a href="http://leafletjs.com/">Leaflet</a>'),this.GeocloudId=G.util.getRandomId(),n.classList.add("geocloud-"+this.GeocloudId);var r=t.layerOptions,o={};o.geo=r.geo?r.geo:[],o.extra=r.extra?r.extra:[],o.tile=r.tile?r.tile:["google"],o.tabStartTime=r.tabStartTime,o.tabEndTime=r.tabEndTime;var i=r.functionButton?r.functionButton:["basic"],s=r.tabButton?r.tabButton:["basic"];this.layerOptions=o;var l={},c={},u={},d={now:"gsm"};o.tile&&o.tile.forEach(function(e,t){switch(e){case"google":d.gsm=L.tileLayer.grayscale("https://mt{s}.google.com/vt/x={x}&y={y}&z={z}&hl="+LanguageValue.GoogleLanguageCode,{subdomains:"012",attribution:"Map data: &copy; Google",maxZoom:22,fadeAnimation:!1}).addTo(a),d.gim=L.tileLayer.grayscale("https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{subdomains:"012",attribution:"Map data: &copy; Google",fadeAnimation:!1}),d.gvm=L.tileLayer.grayscale("https://mts{s}.googleapis.com/vt?hl=zh-TW&lyrs=svv|cb_client:apiv3&style=40,18&gl=US&x={x}&y={y}&z={z}",{subdomains:"012",attribution:"Map data: &copy; Google",zIndex:100,fadeAnimation:!1});break;case"osm":d.osm1=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a>',maxZoom:22,maxNativeZoom:19});break;case"nlsc":d.nlsc1=L.tileLayer("http://wmts.nlsc.gov.tw/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=EMAP&STYLE=_null&TILEMATRIXSET=EPSG:3857&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png",{attribution_:'Map data &copy; <a href="http://maps.nlsc.gov.tw/" target="_blank">'+LanguageValue.NLSC+"</a>",maxZoom:19,errorTileUrl:"/map/images/error.png"}),d.nlsc4=L.tileLayer("http://wmts.nlsc.gov.tw/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=PHOTO2&STYLE=_null&TILEMATRIXSET=EPSG:3857&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png",{attribution_:'Map data &copy; <a href="http://maps.nlsc.gov.tw/" target="_blank">'+LanguageValue.NLSC+"</a>",maxZoom:19})}});var p=G.control.geocoding();p.addTo(a);var g=(G.control.streetview({tile:d.gvm}),G.control.zoom());g.addTo(a);var m=G.control.geolocation();if(m.addTo(a),!G.Dropbox){G.control.dropbox()}var h=G.control.extradata({gmap:this,overLayers:l});n.addEventListener("dragenter",function(){a.scrollWheelZoom.disable()},!1),n.addEventListener("dragleave",function(){a.scrollWheelZoom.enable()},!1),n.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1);var y=(G.control.position().addTo(a),G.control.scale().addTo(a),G.ui.modal(n));L.DomEvent.disableClickPropagation(y).disableScrollPropagation(y);var b={};b.point=G.ui.popupPointStyle(),b.polyline=G.ui.popupPolylineStyle(),b.polygon=G.ui.popupPolygonStyle(),this.mainMap=a,this.tileLayers=d,this.overLayers=l,this.vectorTileLayers=c,this.sortLayersList=u,this.editPopup=b,this.zoomControl=g,this.geolocationControl=m,this.extradataControl=h,this.modal=y,this.chartModal=G.chart.modal(y);var f=["DengueCase"];o.geo.sort(function(e,t){return f.indexOf(e)-f.indexOf(t)});var v=G.control.menu();v.addTo(a);var C=G.control.menucontent();C._menu=v,C.addTo(a);var D=G.control.tab();D.addTo(a);var x=G.control.tabcontent();x._tab=D,x.addTo(a);var _=this;i&&i.forEach(function(e){switch(e){case"all":break;case"zone_user":G.menu.zone_user(v,C,_,o);break;case"zone_export":G.menu.zone_export(v,C,_,o);break;case"zone_bookmark":G.menu.zone_bookmark(v,C,_,o);break;case"zone_tile":G.menu.zone_tile(v,C,_,o);break;case"zone_import":G.menu.zone_import(v,C,_,o);break;case"zone_draw":G.menu.zone_draw(v,C,_,o);break;case"zone_animation":G.menu.zone_animation(v,C,_,o);break;case"zone_list":G.menu.zone_list(v,C,_,o);break;case"zone_legend":G.menu.zone_legend(v,C,_,o);break;case"zone_logout":G.menu.zone_logout(v,C,_);break;case"zone_information":G.menu.zone_information(v,C,_);break;case"zone_disease":G.menu.zone_disease(v,C,_);break;case"DengueGraph":G.menu.dengueGraph(v,C,_,o);break;case"measlesGraph":G.menu.measlesGraph(v,C,_,o)}}),s&&s.forEach(function(e){switch(e){case"DengueSummary":G.tab.dengueSummary(D,x,_,o);break;case"DengueCase":G.tab.dengueCase(D,x,_,o);break;case"DengueCluster":G.tab.dengueCluster(D,x,_,o);break;case"DenguePest":G.tab.denguePest(D,x,_,o);break;case"DenguePrevent":G.tab.denguePrevent(D,x,_,o);break;case"DengueMedical":G.tab.dengueMedical(D,x,_,o);break;case"DengueWeather":G.tab.dengueWeather(D,x,_,o);break;case"DengueRisk":G.tab.dengueRisk(D,x,_,o);break;case"measlesSummary":G.tab.measlesSummary(D,x,_,o);break;case"measlesCase":G.tab.measlesCase(D,x,_,o);break;case"measlesCluster":G.tab.measlesCluster(D,x,_,o);break;case"measlesContact":G.tab.measlesContact(D,x,_,o)}})},G.Map.prototype.tileLayerChange=function(e){var t=this.tileLayers.now;this.mainMap.removeLayer(this.tileLayers[t]),this.mainMap.addLayer(this.tileLayers[e]),this.tileLayers[e].setZIndex(-99),this.tileLayers[t].options.attribution_&&this.mainMap.attributionControl.removeAttribution(this.tileLayers[t].options.attribution_),this.tileLayers[e].options.attribution_&&this.mainMap.attributionControl.addAttribution(this.tileLayers[e].options.attribution_),this.tileLayers.now=e},G.Map.prototype.mapMoveEvent=function(e){var t=this.mainMap;e?(t.dragging.enable(),t.scrollWheelZoom.enable(),t.doubleClickZoom.enable()):(t.dragging.disable(),t.scrollWheelZoom.disable(),t.doubleClickZoom.disable())};